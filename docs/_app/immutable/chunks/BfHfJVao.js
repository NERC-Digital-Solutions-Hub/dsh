import{ac as m,H as O}from"./BUsxo-Ec.js";import{I as x,V as g}from"./D0nkGZIM.js";import{P as E}from"./_r5V6nso.js";import{t as j}from"./su4amZQb.js";import{v as b}from"./C3_gy5al.js";import{t as I}from"./DjNuiUVf.js";function S(t){const n={};for(const a in t){if(a==="declaredClass")continue;const i=t[a];if(i!=null&&typeof i!="function")if(Array.isArray(i)){n[a]=[];for(let o=0;o<i.length;o++)n[a][o]=S(i[o])}else typeof i=="object"?i.toJSON&&(n[a]=JSON.stringify(i)):n[a]=i}return n}function R(t,n){if(n&&t.type==="extent")return`${t.xmin},${t.ymin},${t.xmax},${t.ymax}`;if(n&&t.type==="point")return`${t.x},${t.y}`;const a=t.toJSON();return delete a.spatialReference,JSON.stringify(a)}function q(t,n,a){const{geometry:i}=t,o=t.compactGeometryEnabled??!1,e=t.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const r=e;let s,u,l;if(i&&(u=i.spatialReference,l=m(u),r.geometryType=b(i),r.geometry=R(i,o),r.inSR=l),e.groupByFieldsForStatistics&&(r.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds)switch(a?.uniqueIdFields?.length){case void 0:r.objectIds=e.objectIds.join(",");break;case 1:r.uniqueIds=JSON.stringify(e.objectIds),delete r.objectIds;break;default:r.uniqueIds=JSON.stringify(e.objectIds.map(c=>JSON.parse(c))),delete r.objectIds}if(e.orderByFields&&(r.orderByFields=e.orderByFields.join(",")),!e.outFields||!e.returnDistinctValues&&(n?.returnCountOnly||n?.returnExtentOnly||n?.returnIdsOnly)?delete r.outFields:e.outFields.includes("*")?r.outFields="*":r.outFields=e.outFields.join(","),e.outSR?(r.outSR=m(e.outSR),s=t.outSpatialReference):i&&(e.returnGeometry||e.returnCentroid)&&(r.outSR=r.inSR,s=u),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(r.outStatistics=JSON.stringify(e.outStatistics)),e.fullText&&(r.fullText=JSON.stringify(e.fullText)),e.pixelSize&&(r.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(t.defaultSpatialReferenceEnabled&&u!=null&&t.quantizationParameters?.extent!=null&&u.equals(t.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,r.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(r.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(r.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(r.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const c=e.timeExtent,{start:y,end:f}=c;y==null&&f==null||(r.time=y===f?y:`${y??"null"},${f??"null"}`),delete e.timeExtent}return t.defaultSpatialReferenceEnabled&&u!=null&&s!=null&&u.equals(s)&&(r.defaultSR=r.inSR,delete r.inSR,delete r.outSR),r}const p="Layer does not support extent calculation.";function F(t,n,a){return q(t,n,a)}async function B(t,n,a,i,o){const e=n.timeExtent?.isEmpty?{data:{features:[]}}:await d(t,n,"json",i,void 0,o);return I(n,a,e.data),e}async function C(t,n,a,i,o){if(n.timeExtent?.isEmpty)return{data:a.createFeatureResult()};const e=await J(t,n,i,o),r=e;return r.data=j(e.data,a),r}function J(t,n,a,i){return d(t,n,"pbf",a,void 0,i)}function D(t,n,a,i){return n.timeExtent?.isEmpty?Promise.resolve({data:{objectIds:[]}}):d(t,n,"json",a,{returnIdsOnly:!0},i)}function G(t,n,a,i){return n.timeExtent?.isEmpty?Promise.resolve({data:{count:0}}):d(t,n,"json",a,{returnIdsOnly:!0,returnCountOnly:!0},i)}async function T(t,n,a){if(n.timeExtent?.isEmpty)return{data:{count:0,extent:null}};const i=await d(t,n,"json",a,{returnExtentOnly:!0,returnCountOnly:!0}),o=i.data;if(o.hasOwnProperty("extent"))return i;if(o.features)throw new Error(p);if(o.hasOwnProperty("count"))throw new Error(p);return i}function N(t,n){if(!t.returnIdsOnly||!n.uniqueIdFields)return t;const a={...t,returnUniqueIdsOnly:!0};return delete a.returnIdsOnly,a}async function d(t,n,a,i={},o={},e={}){const r=typeof t=="string"?x(t):t,s=n.geometry?[n.geometry]:[],u=await E(s,null,{signal:i.signal}),l=u?.[0];l!=null&&((n=n.clone()).geometry=l);const c=S({...r.query,f:a,...N(o,e),...F(n,o,e)});return O(g(r.path,$(n,o)?"query3d":"query"),{...i,responseType:a==="pbf"?"array-buffer":"json",query:{...c,...i.query}})}function $(t,n){return t.formatOf3DObjects!=null&&!(n.returnCountOnly||n.returnExtentOnly||n.returnIdsOnly)}export{J as c,T as d,C as f,D as m,G as p,q as r,S as t,B as y};
