const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BPUbp0Pa.js","./DedWa6hQ.js","./CnfuZz2S.js","./PPVm8Dsz.js","./CbAk7Q2g.js","./BYatcg2i.js","./DvUDi2Se.js","./DSvukMJ1.js","./kro8eSGX.js","./CU3cIjbd.js","./Bx7Drccn.js"])))=>i.map(i=>d[i]);
import{r as w,m as R,a as U}from"./DvUDi2Se.js";import{o as T}from"./BtRNH9HO.js";import{a as m}from"./CnfuZz2S.js";import{L as k}from"./DSvukMJ1.js";import"./BYatcg2i.js";import{_ as j}from"./PPVm8Dsz.js";import{H as x}from"./DedWa6hQ.js";import{o as D}from"./Cl5lrJ4c.js";const P=D(),V=new Map,A=new Map;async function X(e,s,d){if(!e||!d)return!1;if(!s)return!0;const r=new URL(e).host;let n=V.get(r);if(!n){const o=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");n=(await x(o,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return n===s}async function Y(e,s,d=!1){if(!e||!s)return!0;const r=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=A.get(r)?.entries();if(n){for(const[o,t]of n)if(t.name===s){const c=!t.stack?.hasForwardEdits();if(!c&&d){const[{deleteForwardEdits:a},{default:h}]=await Promise.all([j(()=>import("./BPUbp0Pa.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]),import.meta.url),j(()=>import("./CU3cIjbd.js"),__vite__mapDeps([9,6,2,5,7,10]),import.meta.url)]),u=await a(r,o,new h({sessionId:P,moment:t.moment}));return u.success&&t.stack?.clearForwardEdits(),u.success}return c}}return!0}function O(e,s){if(!e)return!1;const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),r=A.get(d)?.entries();if(r){for(const[n,o]of r)if(o.name===s)return o.lockType==="edit"}return!1}const M=new T.EventEmitter;function W(e){return M.on("apply-edits",new WeakRef(e))}function q(e){return M.on("update-moment",new WeakRef(e))}function Z(e,s,d=null,r=!1){const n=k();return r=s==null||r,M.emit("apply-edits",{serviceUrl:e,layerId:s,gdbVersion:d,mayReceiveServiceEdits:r,result:n.promise}),n}const H=Symbol();function ee(e){return e!=null&&typeof e=="object"&&H in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function I(e,s,d){const r=new URL(e).host,n=V.get(r),o=t=>!t||t===n;return o(s)&&o(d)||s===d}const te=e=>{var r;var s;let d=(r=class extends e{constructor(...n){super(...n),this[s]=!0,this._applyEditsHandler=o=>{const{serviceUrl:t,layerId:c,gdbVersion:a,mayReceiveServiceEdits:h,result:u}=o,b=t===this.url,f=c!=null&&this.layerId!=null&&c===this.layerId,S=p(this),$=p(this)&&I(t,a,this.gdbVersion);if(!b||S&&!$||!f&&!h)return;const L=u.then((i=>{if(this.lastEditsEventDate=new Date,f&&(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length||i.addedAttachments.length||i.updatedAttachments.length||i.deletedAttachments.length))return this.emit("edits",m(i)),i;const y=i.editedFeatures?.find((({layerId:F})=>F===this.layerId));if(y){const{adds:F,updates:v,deletes:_}=y.editedFeatures,E={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:F?F.map((({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]}))):[],deletedFeatures:_?_.map((({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]}))):[],updatedFeatures:v?v.map((({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]}))):[],editedFeatures:m(i.editedFeatures),exceededTransferLimit:!1,historicMoment:m(i.historicMoment)};return this.emit("edits",E),E}const g={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:m(i.editedFeatures),exceededTransferLimit:!1,historicMoment:m(i.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(t,a,g.historicMoment)&&this.emit("edits",g),g})).then((i=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(t,a,i.historicMoment)&&(this.historicMoment=i.historicMoment),i)));this.emit("apply-edits",{result:L})},this._updateMomentHandler=o=>{const{serviceUrl:t,gdbVersion:c,moment:a}=o,h=t===this.url,u=p(this),b=p(this)&&I(t,c,this.gdbVersion),f=p(this)&&!I(t,this.gdbVersion,null);h&&u&&b&&f&&"historicMoment"in this&&this.historicMoment!==a&&(this.historicMoment=a)},this.when().then((()=>{this.addHandles(W(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(q(this._updateMomentHandler))}),(()=>{}))}_shouldUpdateHistoricMoment(n,o,t){return"historicMoment"in this&&this.historicMoment!==t&&O(n,o)}},s=H,r);return w([R()],d.prototype,"lastEditsEventDate",void 0),d=w([U("esri.layers.mixins.EditBusLayer")],d),d};export{te as F,Z as a,O as c,I as g,q as h,Y as i,W as l,X as o,ee as p,P as t};
