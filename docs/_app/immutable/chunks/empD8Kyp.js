import{s as P,a as c}from"./BFGjv385.js";import{s as b,H as w}from"./DE7MWQCs.js";import{q as k}from"./CYZreaXu.js";import{B as v}from"./DzPnzJx5.js";import{f as x}from"./B6nb1bq7.js";import{u as G,L as S,M as p,H as E}from"./D8WJzxGJ.js";import{v as d}from"./BQr2meHs.js";import{t as M}from"./DngBYph4.js";import{g as O}from"./C4W4xdQN.js";const F={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function D(n){const o=n.folders||[],r=o.slice(),t=new Map,s=new Map,u=new Map,y=new Map,m=new Map,f={esriGeometryPoint:s,esriGeometryPolyline:u,esriGeometryPolygon:y};(n.featureCollection?.layers||[]).forEach(e=>{const l=c(e);l.featureSet.features=[];const i=e.featureSet.geometryType;t.set(i,l);const g=e.layerDefinition.objectIdField;i==="esriGeometryPoint"?h(s,g,e.featureSet.features):i==="esriGeometryPolyline"?h(u,g,e.featureSet.features):i==="esriGeometryPolygon"&&h(y,g,e.featureSet.features)}),n.groundOverlays&&n.groundOverlays.forEach(e=>{m.set(e.id,e)}),o.forEach(e=>{e.networkLinkIds.forEach(l=>{const i=L(l,e.id,n.networkLinks);i&&r.push(i)})}),r.forEach(e=>{if(e.featureInfos){e.points=c(t.get("esriGeometryPoint")),e.polylines=c(t.get("esriGeometryPolyline")),e.polygons=c(t.get("esriGeometryPolygon")),e.mapImages=[];for(const l of e.featureInfos)switch(l.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const i=f[l.type].get(l.id);i&&e[F[l.type]]?.featureSet.features.push(i);break}case"GroundOverlay":{const i=m.get(l.id);i&&e.mapImages.push(i);break}}e.fullExtent=I([e])}});const a=I(r);return{folders:o,sublayers:r,extent:a}}function R(n,o,r,t){const s=b?.findCredential(n);n=v(n,{token:s?.token});const u=P.kmlServiceUrl;return w(u,{query:{url:n,model:"simple",folders:"",refresh:r!==0||void 0,outSR:JSON.stringify(o)},responseType:"json",signal:t})}function A(n,o,r=null,t=[]){const s=[],u={},y=o.sublayers,m=new Set(o.folders.map(f=>f.id));return y.forEach(f=>{const a=new n;if(r?a.read(f,r):a.read(f),t.length&&m.has(a.id)&&(a.visible=t.includes(a.id)),u[f.id]=a,f.parentFolderId!=null&&f.parentFolderId!==-1){const e=u[f.parentFolderId];e.sublayers||(e.sublayers=[]),e.sublayers?.unshift(a)}else s.unshift(a)}),s}function h(n,o,r){r.forEach(t=>{n.set(t.attributes[o],t)})}function $(n,o){let r;return o.some(t=>t.id===n&&(r=t,!0)),r}function L(n,o,r){const t=$(n,r);return t&&(t.parentFolderId=o,t.networkLink=t),t}async function U(n,o,r,t){const s=n[o];if(!s)return[];const u=O.fromJSON(s.featureSet).features,y=s.layerDefinition,m=M(y.drawingInfo.renderer),f=k.fromJSON(s.popupInfo),a=[];for(const e of u){const l=await m.getSymbolAsync(e);e.symbol=l,e.popupTemplate=f,e.visible=!0;const i=r.sublayerById.get(t);e.origin=i.origin,a.push(e)}return a}function I(n){const o=G(S),r=G(S);for(const t of n){if(t.polygons?.featureSet?.features)for(const s of t.polygons.featureSet.features)d(o,s.geometry),p(r,o);if(t.polylines?.featureSet?.features)for(const s of t.polylines.featureSet.features)d(o,s.geometry),p(r,o);if(t.points?.featureSet?.features)for(const s of t.points.featureSet.features)d(o,s.geometry),p(r,o);if(t.mapImages)for(const s of t.mapImages)d(o,s.extent),p(r,o)}return E(r,S)?void 0:{xmin:r[0],ymin:r[1],zmin:r[2],xmax:r[3],ymax:r[4],zmax:r[5],spatialReference:x.WGS84}}export{I,A as S,U as b,D as d,R as g};
