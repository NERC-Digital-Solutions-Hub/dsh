const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CGqwzVOT.js","./CQL0hffV.js","./DUlE1Kon.js","./BFGjv385.js","./DSdBzmdi.js","./DxH_hBwP.js","./PPVm8Dsz.js","./CZCUGSrh.js","./DCcCllwm.js","./DjD9ZkP_.js"])))=>i.map(i=>d[i]);
import{_ as j,m as L,a as T}from"./DUlE1Kon.js";import{i as k}from"./Cc17QD5h.js";import{a as m}from"./BFGjv385.js";import{$ as x}from"./DxH_hBwP.js";import"./DSdBzmdi.js";import{_ as V}from"./PPVm8Dsz.js";import{H as D}from"./CQL0hffV.js";import{o as P}from"./Oe6SV2kF.js";const O=P(),A=new Map,H=new Map;async function Y(e,i,o){if(!e||!o)return!1;if(!i)return!0;const t=new URL(e).host;let r=A.get(t);if(!r){const n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");r=(await D(n,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return r===i}async function Z(e,i,o=!1){if(!e||!i)return!0;const t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),r=H.get(t)?.entries();if(r){for(const[n,d]of r)if(d.name===i){const a=!d.stack?.hasForwardEdits();if(!a&&o){const[{deleteForwardEdits:u},{default:l}]=await Promise.all([V(()=>import("./CGqwzVOT.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]),import.meta.url),V(()=>import("./DjD9ZkP_.js"),__vite__mapDeps([9,2,3,4,5]),import.meta.url)]),h=await u(t,n,new l({sessionId:O,moment:d.moment}));return h.success&&d.stack?.clearForwardEdits(),h.success}return a}}return!0}function W(e,i){if(!e)return!1;const o=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=H.get(o)?.entries();if(t){for(const[r,n]of t)if(n.name===i)return n.lockType==="edit"}return!1}const y=new k;function q(e){return y.on("apply-edits",new WeakRef(e))}function B(e){return y.on("update-moment",new WeakRef(e))}function ee(e,i,o=null,t=!1){const r=x();return t=i==null||t,y.emit("apply-edits",{serviceUrl:e,layerId:i,gdbVersion:o,mayReceiveServiceEdits:t,result:r.promise}),r}const $=Symbol();function te(e){return e!=null&&typeof e=="object"&&$ in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function M(e,i,o){const t=new URL(e).host,r=A.get(t),n=d=>!d||d===r;return n(i)&&n(o)||i===o}const se=e=>{var r;var i;const o=e;let t=(r=class extends o{constructor(...n){super(...n),this[i]=!0,this._applyEditsHandler=d=>{const{serviceUrl:a,layerId:u,gdbVersion:l,mayReceiveServiceEdits:h,result:b}=d,g=a===this.url,f=u!=null&&this.layerId!=null&&u===this.layerId,S=p(this),R=p(this)&&M(a,l,this.gdbVersion);if(!g||S&&!R||!f&&!h)return;const U=b.then(s=>{if(this.lastEditsEventDate=new Date,f&&(s.addedFeatures.length||s.updatedFeatures.length||s.deletedFeatures.length||s.addedAttachments.length||s.updatedAttachments.length||s.deletedAttachments.length))return this.emit("edits",m(s)),s;const _=s.editedFeatures?.find(({layerId:F})=>F===this.layerId);if(_){const{adds:F,updates:v,deletes:w}=_.editedFeatures,E={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:F?F.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],deletedFeatures:w?w.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],updatedFeatures:v?v.map(({current:{attributes:c}})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],editedFeatures:m(s.editedFeatures),exceededTransferLimit:!1,historicMoment:m(s.historicMoment)};return this.emit("edits",E),E}const I={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:m(s.editedFeatures),exceededTransferLimit:!1,historicMoment:m(s.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(a,l,I.historicMoment)&&this.emit("edits",I),I}).then(s=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(a,l,s.historicMoment)&&(this.historicMoment=s.historicMoment),s));this.emit("apply-edits",{result:U})},this._updateMomentHandler=d=>{const{serviceUrl:a,gdbVersion:u,moment:l}=d,h=a===this.url,b=p(this),g=p(this)&&M(a,u,this.gdbVersion),f=p(this)&&!M(a,this.gdbVersion,null);h&&b&&g&&f&&"historicMoment"in this&&this.historicMoment!==l&&(this.historicMoment=l)},this.when().then(()=>{this.addHandles(q(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(B(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(n,d,a){return"historicMoment"in this&&this.historicMoment!==a&&W(n,d)}},i=$,r);return j([L()],t.prototype,"lastEditsEventDate",void 0),t=j([T("esri.layers.mixins.EditBusLayer")],t),t};export{se as F,ee as a,W as c,M as g,B as h,Z as i,q as l,Y as o,te as p,O as t};
