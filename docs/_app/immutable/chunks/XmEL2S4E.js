const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CFHige2F.js","./iFuBOtDF.js","./DHq0rblm.js","./BfhsIlKo.js","./C3el2dU7.js","./gRIb6kZn.js","./D6wORzA5.js","./D6KPPgz5.js","./BkQcsSCB.js","./DQOJ18NT.js","./DPb6J-GU.js","./D-ovSOwr.js","./DhdgDebw.js","./C4sptlMV.js","./DUjReREf.js","./D4R7oZu3.js","./D9Z9MdNV.js","./BgvLO-3W.js","./DAH1hNT2.js","./WcJGXhiC.js","./DJjT3TTZ.js","./X5C1MeQS.js","./aQeO9QTD.js","./DDSDNAvY.js","./D6ZixKAB.js","./MNdTETuD.js","./CIEJ47vb.js","./s4pFTH3J.js","./0Li1KFl_.js","./CeU4muFd.js","./Dt5YSiFI.js","./Bvto7RYj.js","./COwzl_RY.js","./9YvG7tFv.js","./DUnEJCVc.js","./CaNAmI22.js","./bSd63DKI.js","./DA8P0gC7.js","./B9tUWPP0.js","./BXcQjlUf.js","./CplOCcJ4.js","./1NvkAIBS.js","./C5CzMsLd.js","./DSV1OGTD.js","./B7bVjktC.js","./Djp3mnm5.js","./CPo5-yuN.js","./BsB-6bk9.js","./BtomzZFt.js","./BObOjkey.js","./5kEBELjv.js","./BTmgXaLR.js","./Dx6OYnl-.js","./P7f_b1p3.js","./jdSLNkEr.js","./DgwIrkEl.js","./sua5Oe99.js","./PazZe8st.js","./C_0GAhb0.js","./X8e6Ip-W.js","./Cl5lrJ4c.js","./BhFjAryG.js","./MtSiOt06.js","./C0wm8_Yw.js","./C4HJhmWz.js","./B9bNngN9.js","./Bkn6ETYF.js","./CMu79gGv.js","./DKpHpVXg.js","./EzLf78vY.js","./BMX0GFJS.js","./YxzK1u-M.js","./ETfT8J3h.js","./BrzAf0Kr.js","./DZd6gJy7.js","./Czy_3qlu.js","./C8BmVxiO.js","./CJ_83qNO.js","./o7saAPsN.js","./BJdY-3i_.js","./cw1rsUFH.js","./BLqYSr4O.js","./ok2Sqpw2.js","./Chk7YAAL.js","./D0t3l1UW.js","./Cgb6qxNH.js","./BhvPu0tO.js","./CrwPCMe2.js","./QQC62dOK.js","./B3whEHty.js","./BPFrGhhc.js","./Db-WH96Y.js","./CkRwMJ5O.js","./DKpmsPfl.js","./D4KVO-SP.js","./B1N-tmtC.js","./CASyCajO.js","./BiphejqT.js","./Cf9zLCCH.js","./pDuGEAnG.js","./DQvOrLsz.js","./BrScpkSj.js","./rxpTDz6e.js","./CecNjDdY.js","./b4odqmHr.js","./iclJa8t9.js","./uI82Pomd.js","./CIs0xPBV.js","./rSV_rS4R.js","./MmOLfBvm.js","./B5o_lm6j.js","./q_b6UJoq.js","./aQ5IuZRd.js","./DC11yzF6.js","./3PRbgC68.js","./D4AYUkpH.js","./CirnHLSB.js","./D9gy186-.js","./Djc4Ct7C.js","./_50YZZp0.js","./ePjqvsF2.js","./BkUGpYg4.js","./Bk8yk9ly.js","./046RZWmO.js","./LsmUtVV9.js","./RkzZNCYb.js","./DmxaQ-k8.js","./DhYO7Jl1.js","./BsxeN7wM.js","./DOhPy5kB.js","./B48Ei7aL.js","./PHd144zV.js","./CMDvjow7.js","./idFNhppz.js","./PYNeNydK.js","./FVrkSZit.js","./Cp3YW0ei.js","./N86vRvDz.js","./1mYWTFa-.js","./CjDPhOGW.js","./BfkzOMLV.js","./Cj7KC756.js","./BBwFZqyN.js","./Bdd80V3g.js","./8YOoqft9.js","./CdXHeswL.js","./Btp5SFNj.js","./BKo2foNY.js","./CqQCbLGa.js","./IL9uLNrO.js","./WCVSSNPR.js","./BRxoU36Y.js","./DKrbbI-R.js","./iZTkh1ZX.js","./BLyltQyJ.js","./Cl3n0dbA.js","./D2n6zc4S.js","./os6EaHYW.js","./CfTuaOGP.js","./B9UdDv0k.js","./DjeKiOF-.js","./BRAjkLg8.js","./DJIBPMHs.js","./CuJjo2fS.js","./DdPmKAyS.js","./cj780n54.js","./Ei29lXAh.js","./B92kdZ15.js","./DP7_WWTp.js","./C_qJxl23.js","./C5MveZ50.js","./CwpJ9Hd-.js","./B6Ns6hcP.js","./ooEONrDB.js","./gX06LtHq.js","./gQim6TH1.js","./C9p9jDb1.js","./C1rV46kJ.js","./vx7aVD29.js","./DdSLmJ2d.js","./BS3H3l-F.js","./DCdj6Lab.js","./KcazVFlU.js","./CYsUaMUi.js","./CfmtXFtd.js","./CKnvvm_b.js","./B4k-7AfK.js","./GKolV7NZ.js","./Be-zgxj_.js"])))=>i.map(i=>d[i]);
import{ar as De,r as u,m as b,a as B,k as Ie,f as Jr,ae as Ze,N as es,Q as ts,au as we,aO as ct,a9 as rs}from"./iFuBOtDF.js";import{b as Ht,i as Vt,c as bt,h as ss,X as is,Q as as,q as os,n as ns}from"./CPo5-yuN.js";import{r as X,e as N}from"./q_b6UJoq.js";import{j as ls,r as hs,A as cs,g as us,s as q,c as ds,H as gs,y as ps,E as Sr,o as Dr}from"./C4sptlMV.js";import{C as fs,E as _s,U as ms}from"./DC11yzF6.js";import{m as vs}from"./rSV_rS4R.js";import{n as Dt,a as ys,s as xs}from"./DPb6J-GU.js";import{O as re}from"./Btp5SFNj.js";import{n as R,u as Pr,d as ut,S as Ut,e as bs}from"./Bdd80V3g.js";import{au as U,O as Ir,q as Re,i as Pt,ax as ws,ay as Cs,a2 as Wt,ab as zt,aU as qt,am as It,h as Ke,aG as Ts,ap as Ae,K as Se,ae as it,ao as Ar,g as Er,aV as Fr,v as se,x as ie,al as Os,as as $s,at as dt,aW as Rs,E as F,u as At,aX as gt,aY as Ss,aZ as Ds,C as A,a_ as Ps,a$ as Is,G as pt,D as As,aR as Gt,_ as Es,ag as Fs,aE as Ms,b as Ls,e as Ns,ai as Hs,aF as Vs,a as Us,f as Ws,c as zs,aI as qs,aJ as Gs,aK as js,aL as Bs,aM as ks,aN as Ys,aO as Qs,aP as Xs,F as Zs,z as Ks,A as Js,B as ei,aQ as ti,k as ri,aT as si,b0 as ii,b1 as ai,p as oi,Y as ni,n as li}from"./PYNeNydK.js";import{a as ke,e as Et}from"./N86vRvDz.js";import{e as f}from"./BfkzOMLV.js";import{u as Ye,aa as jt,W as hi,n as Ee,r as Pe,ab as ci}from"./DUjReREf.js";import{_ as ae}from"./D9Z9MdNV.js";import{n as C}from"./Cj7KC756.js";import{i as oe}from"./DKrbbI-R.js";import{B as K,g as J,c as Mr,f as ui}from"./8YOoqft9.js";import{o as H,u as Y,l as pe,_ as Ce,b as Bt,e as fe,j as D,x as di,v as kt,r as gi,G as pi}from"./D0t3l1UW.js";import{n as y}from"./Cgb6qxNH.js";import{t as Qe,aA as fi}from"./D4R7oZu3.js";import{h as _i,a as mi}from"./5kEBELjv.js";import{t as Lr,a as Yt}from"./B9tUWPP0.js";import{U as vi}from"./CjDPhOGW.js";import{l as Nr}from"./Chk7YAAL.js";import{t as k}from"./CMDvjow7.js";import{p as Je,a as Hr}from"./Cp2hvC1m.js";import{t as yi,i as at,l as xi,a as bi,e as He,C as wi,b as Qt,u as Ci}from"./PHd144zV.js";import{l as _e,h as wt,o as Ti,a as Oi,w as Xt}from"./D-ovSOwr.js";import{n as $i,b as Ri}from"./DHq0rblm.js";import{i as Si}from"./BfhsIlKo.js";import{r as Vr,o as Di,b as Pi}from"./D6KPPgz5.js";import{a as Ft}from"./BBwFZqyN.js";import{r as ft}from"./CJ_83qNO.js";import{j as Ii,v as Zt,w as Kt}from"./046RZWmO.js";import{r as Fe}from"./Bvto7RYj.js";import{L as Ai}from"./CMu79gGv.js";import{O as ee,M as Ei,L as Ur,_ as te,Y as Jt,R as Fi,G as Mi,g as Ve}from"./BiphejqT.js";import{t as ye}from"./BLyltQyJ.js";import{o as Li,E as er}from"./Cl3n0dbA.js";import{a as Wr,S as Mt}from"./Cf9zLCCH.js";import{t as Ni}from"./wm1q4thl.js";import{s as me,u as Hi,c as ne,e as Ue}from"./B48Ei7aL.js";import{h as Vi}from"./CqQCbLGa.js";import{e as Ui}from"./B5o_lm6j.js";import{s as tr,z as Wi}from"./BkQcsSCB.js";import{g as zi,C as qi}from"./D4KVO-SP.js";var rr,sr;(function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"})(rr||(rr={})),(function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"})(sr||(sr={}));let Gi=class extends Li{};var j,ir,ar;(function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"})(j||(j={})),(function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"})(ir||(ir={})),(function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"})(ar||(ar={}));let or=class{constructor(){this._extent=Ye(),this.resolution=0,this.renderLocalOrigin=yi(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new ji}get extent(){return this._extent}setupGeometryViews(t){if(this._setupGeometryView(),!t)return;const r=.001*t.range;if(this._extent[0]-r<=t.min){const s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];jt(this._extent,t.range,0,s)}if(this._extent[2]+r>=t.max){const s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];jt(this._extent,-t.range,0,s)}}_setupGeometryView(){this.canvasGeometries.numViews=1,hi(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let t=0;t<this.canvasGeometries.numViews;t++){const r=this.canvasGeometries.extents[t];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},ji=class{constructor(){this.extents=[Ye(),Ye(),Ye()],this.numViews=0}};var w;(function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.WaterNormal=3]="WaterNormal",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(w||(w={}));let Bi=class{constructor(t,r,s){this._fbos=t,this._format=r,this._name=s}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=De(this._handle)}get texture(){return this._handle?.getTexture()}bind(t,r,s){this._handle&&this._handle.fbo?.width===r&&this._handle.fbo?.height===s||(this._handle?.release(),this._handle=this._fbos.acquire(r,s,this._name,this._format)),t.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},le=class{constructor(t,r,s,a,i=U.RGBA8UNORM_MIPMAP){this.output=s,this.content=a,this.fbo=new Bi(t,i,r)}get valid(){return this.fbo.valid}},ki=class{constructor(t){this.targets=[new le(t,"overlay color",R.Color,w.Color),new le(t,"overlay IM color",R.Color,w.ColorNoRasterImage),new le(t,"overlay highlight",R.Highlight,w.Highlight,U.RG8UINT),new le(t,"overlay water",R.Normal,w.WaterNormal),new le(t,"overlay occluded",R.Color,w.Occluded)],Ir()&&this.targets.push(new le(t,"overlay olid",R.ObjectAndLayerIdColor,w.ObjectAndLayerIdColor,U.RGBA8UNORM))}getTexture(t){return this.targets[t]?.fbo.texture}dispose(){for(const t of this.targets)t.fbo.dispose()}computeValidity(){return this.targets.reduce(((t,r,s)=>r.valid?t|=1<<s:t),0)}};var nr;(function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight",e[e.ViewshedShadowMap=3]="ViewshedShadowMap"})(nr||(nr={}));var G,et;function Yi(e){return e!=null&&!e.running}(function(e){e[e.Idle=0]="Idle",e[e.Rendering=1]="Rendering",e[e.Ready=2]="Ready",e[e.Fading=3]="Fading"})(G||(G={})),(function(e){e[e.RG=0]="RG",e[e.BA=1]="BA",e[e.COUNT=2]="COUNT"})(et||(et={}));var Ct;let We=Ct=class extends Ie{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new Ct({cloudCover:this.cloudCover})}};u([Fe({cloudy:"cloudy"}),b({json:{write:{isRequired:!0}}})],We.prototype,"type",void 0),u([b({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],We.prototype,"cloudCover",void 0),We=Ct=u([B("esri.views.3d.environment.CloudyWeather")],We);var Tt;let ze=Tt=class extends Ie{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new Tt({fogStrength:this.fogStrength})}};u([Fe({foggy:"foggy"}),b({json:{write:{isRequired:!0}}})],ze.prototype,"type",void 0),u([b({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ze.prototype,"fogStrength",void 0),ze=Tt=u([B("esri.views.3d.environment.FoggyWeather")],ze);var Ot;let Te=Ot=class extends Ie{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new Ot({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([Fe({rainy:"rainy"}),b({json:{write:{isRequired:!0}}})],Te.prototype,"type",void 0),u([b({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Te.prototype,"cloudCover",void 0),u([b({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Te.prototype,"precipitation",void 0),Te=Ot=u([B("esri.views.3d.environment.RainyWeather")],Te);var $t;let he=$t=class extends Ie{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new $t({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};u([Fe({snowy:"snowy"}),b({json:{write:{isRequired:!0}}})],he.prototype,"type",void 0),u([b({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],he.prototype,"cloudCover",void 0),u([b({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],he.prototype,"precipitation",void 0),u([b({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],he.prototype,"snowCover",void 0),he=$t=u([B("esri.views.3d.environment.SnowyWeather")],he);var Rt;let qe=Rt=class extends Ie{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new Rt({cloudCover:this.cloudCover})}};u([Fe({sunny:"sunny"}),b({json:{write:{isRequired:!0}}})],qe.prototype,"type",void 0),u([b({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],qe.prototype,"cloudCover",void 0),qe=Rt=u([B("esri.views.3d.environment.SunnyWeather")],qe);const _t=1e4,Qi=1e5;class Xi{constructor(){this.startTime=0,this._data=ft(null),this.coverage=0,this.absorption=0,this._readChannels=et.RG,this.parallax=new lr,this.parallaxNew=new lr,this._anchorPoint=Ee(),this._fadeState=ft(m.HIDE),this._fadeFactor=ft(1)}get data(){return this._data.value}set data(t){this._data.value=t}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case m.HIDE:return 0;case m.FADE_OUT:return 1-this.fadeFactor;case m.FADE_IN:return this.fadeFactor;case m.SHOW:case m.CROSS_FADE:return 1}}fade(t,r,s){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=s?Vr((r-this.startTime)/(Ki*s),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(t,r),this._updateParallax(t)}_evaluateState(t,r){const s=t.relativeElevation,a=this._updateAnchorPoint(t);(s>1.7*_t||s<-1e4||a>cr)&&this.opacity>0?this._startFade(m.HIDE,r):this.isFading||(s>_t||s<-.35*_t||a>Ji*cr?this.opacity>0&&this._startFade(m.FADE_OUT,r):Yi(this.data)&&(this.opacity===0?this._startFade(m.FADE_IN,r):this.data.state===G.Ready&&(this.fadeState===m.SHOW?this._startFade(m.CROSS_FADE,r):this._startFade(m.SHOW,r))))}_updateParallax(t){const r=ls(t.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(r-Qe.radius*Qe.radius,0))/Math.sqrt(r),Zt(hr,this.parallax.anchorPoint,ce),Ht(this.parallax.transform,X,ce[3],Kt(ce)),Zt(hr,this.parallaxNew.anchorPoint,ce),Ht(this.parallaxNew.transform,X,ce[3],Kt(ce))}_updateAnchorPoint(t){return cs(this._anchorPoint,t.eye),us(this._anchorPoint,this._anchorPoint,Qe.radius),this.fadeState===m.HIDE&&this.data?.state===G.Ready?(q(this.parallax.anchorPoint,this._anchorPoint),0):hs(ds(Zi,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(t,r){switch(this._fadeState.value=t,this.startTime=r,t){case m.CROSS_FADE:this.requestFade(),this._switchReadChannels(),q(this.parallaxNew.anchorPoint,this._anchorPoint);break;case m.FADE_IN:this.requestFade(),this._switchReadChannels(),q(this.parallax.anchorPoint,this._anchorPoint),q(this.parallaxNew.anchorPoint,this._anchorPoint);break;case m.FADE_OUT:this.requestFade();break;case m.SHOW:this._switchReadChannels(),q(this.parallax.anchorPoint,this._anchorPoint),q(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case m.HIDE:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==G.Ready&&(this.data.state=G.Idle),this.fadeState){case m.CROSS_FADE:q(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=m.SHOW;break;case m.FADE_IN:this._fadeState.value=m.SHOW;break;case m.FADE_OUT:this._fadeState.value=m.HIDE;break;case m.SHOW:case m.HIDE:break;default:$i(this.fadeState)}}_switchReadChannels(){this.data?.state===G.Ready&&(this._readChannels=1-this._readChannels,this.data.state=G.Fading)}get isFading(){return this.fadeState===m.FADE_OUT||this.fadeState===m.FADE_IN||this.fadeState===m.CROSS_FADE}}var m;(function(e){e[e.HIDE=0]="HIDE",e[e.FADE_IN=1]="FADE_IN",e[e.SHOW=2]="SHOW",e[e.CROSS_FADE=3]="CROSS_FADE",e[e.FADE_OUT=4]="FADE_OUT"})(m||(m={}));let lr=class{constructor(){this.anchorPoint=Ee(),this.radiusCurvatureCorrection=0,this.transform=N()}};const hr=Pe(0,0,1),ce=Ii(),Zi=Ee(),Ki=1.25,Ji=.5,cr=2e5;function ea(e){e.fragment.uniforms.add(new Re("cloudAbsorption",(t=>t.clouds.absorption)),new Re("cloudCoverage",(t=>t.clouds.coverage))).code.add(C`vec4 lookupCloudsFromTextureArray(sampler2DArray cubeMap, vec3 rayDir) {
int faceIndex;
vec2 uv;
if(rayDir.z <= 0.0) {
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudCoverage), abs(dot(rayDir, vec3(0, 0, 1))));
float shading = clamp(1.0 - cloudAbsorption, 0.6, 1.0) * (1.0 - hazeFactor);
float totalTransmittance = hazeFactor;
return vec4(shading, totalTransmittance, shading, totalTransmittance);
}
if (abs(rayDir.x) >= abs(rayDir.y) && abs(rayDir.x) >= abs(rayDir.z)) {
if(rayDir.x > 0.0) {
faceIndex = 0;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, uv.y);
} else {
faceIndex = 1;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, -uv.y);
}
} else if (abs(rayDir.y) >= abs(rayDir.x) && abs(rayDir.y) >= abs(rayDir.z)) {
if(rayDir.y > 0.0) {
faceIndex = 2;
uv = rayDir.xz / rayDir.y;
} else {
faceIndex = 3;
uv = rayDir.xz / rayDir.y;
uv = vec2(uv.x, -uv.y);
}
} else {
if(rayDir.y < 0.0) {
faceIndex = 4;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
} else {
faceIndex = 5;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
}
}
uv = 0.5 * (uv + 1.0);
if(faceIndex != 5) {
uv.y = uv.y - 0.5;
}
uv.y = uv.y * 2.0;
vec4 s = texture(cubeMap, vec3(uv, float(faceIndex)));
return s;
}`)}let ta=class extends Pt{constructor(t,r){super(t,"sampler2DArray",Ft.Bind,((s,a)=>s.bindTexture(t,r(a))))}};function dn(e){const t=e.fragment;t.constants.add("radiusCloudsSquared","float",ra).code.add(C`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
return (cameraPosition + dir * pointIntDist) - spherePos;
}`),t.uniforms.add(new Re("radiusCurvatureCorrection",(({clouds:l})=>l.parallax.radiusCurvatureCorrection))).code.add(C`vec3 correctForPlanetCurvature(vec3 dir) {
dir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;
return dir;
}`),t.code.add(C`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),ws(t),Cs(t);const r=Pe(.28,.175,.035);t.constants.add("RIM_COLOR","vec3",r),t.code.add(C`
    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {
      float upDotLight = dot(cameraPosition, mainLightDirection);
      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);
      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ${C.float(.3)}), 0.0, 1.0);

      // Base color of the clouds that depends on lighting of the sun and sky
      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);
      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));

      // Rim light around the edge of the clouds simulating scattering of the direct lun light
      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);
      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ${C.float(140)})) * scatteringMod;

      // Brighten the clouds around the sun at the sunsets
      float additionalLight = ${C.float(.2)} * pow(dirDotLight, ${C.float(10)}) * (1. - pow(sunsetTransition, ${C.float(.3)})) ;

      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);
    }
  `),e.include(ea),t.uniforms.add(new Wt("readChannelsRG",(l=>l.clouds.readChannels===et.RG)),new ta("cubeMap",(l=>l.clouds.data?.cubeMap?.colorTexture))).code.add(C`vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {
vec4 s = lookupCloudsFromTextureArray(cubeMap, rayDir);
bool readRG = readChannelsRG ^^ readOtherChannel;
s = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);
return length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;
}`),t.uniforms.add(new zt("anchorPoint",(l=>l.clouds.parallax.anchorPoint)),new zt("anchorPointNew",(l=>l.clouds.parallaxNew.anchorPoint)),new qt("rotationClouds",(l=>l.clouds.parallax.transform)),new qt("rotationCloudsNew",(l=>l.clouds.parallaxNew.transform)),new Re("cloudsOpacity",(l=>l.clouds.opacity)),new Re("fadeFactor",(l=>l.clouds.fadeFactor)),new Wt("crossFade",(l=>l.clouds.fadeState===m.CROSS_FADE))).code.add(C`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {
vec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);
vec3 cameraPositionN = normalize(cameraPosition);
vec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
if(crossFade) {
intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);
worldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = sampleCloud(worldRayRotatedCorrected, false);
vec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorNew, fadeFactor);
}
float totalTransmittance = length(cloudColor.rgb) == 0.0 ?
1.0 :
clamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);
return vec4(cloudColor.rgb, totalTransmittance);
}`)}const ra=(Qe.radius+Qi)**2;let ot=class extends Pt{constructor(t,r){super(t,"usampler2D",Ft.Pass,((s,a,i)=>s.bindTexture(t,r(a,i))))}};var ve;(function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"})(ve||(ve={}));let zr=class extends Ae{constructor(){super(...arguments),this.color=Pe(1,1,1)}};function sa(){const e=new oe;return e.include(It),e.fragment.uniforms.add(new Ke("tex",(t=>t.texture)),new Ts("uColor",(t=>t.color))),e.fragment.main.add(C`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}const ia=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:zr,build:sa},Symbol.toStringTag,{value:"Module"})),aa={required:[]};R.Depth;let qr=class extends Jr{precompile(t){return!!this.acquireTechniques(t)}consumes(){return aa}get usedMemory(){return 0}get renderOccludedFlags(){return Se.Occlude}get isDecoration(){return!1}get running(){return!1}modify(t,r){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(t){}},oa=class extends qr{},mn=class extends qr{},ur=class extends Pt{constructor(t,r){super(t,"ivec2",Ft.Pass,((s,a,i)=>s.setUniform2iv(t,r(a,i))))}},Gr=class extends Ae{};function na(){const e=new oe,{outputs:t,fragment:r}=e;return e.include(It),r.uniforms.add(new ot("highlightTexture",(s=>s.highlightTexture))),r.constants.add("outlineWidth","int",Math.ceil(tt)),r.constants.add("cellSize","int",Z),t.add("fragGrid","uvec2"),r.main.add(C`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),e}const Z=32,tt=9,jr=.4,la=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:Gr,blurSize:jr,build:na,gridCellPixelSize:Z,outlineSize:tt},Symbol.toStringTag,{value:"Module"}));function Lt(e){const{vertex:t}=e;t.uniforms.add(new ot("coverageTexture",(r=>r.coverageTexture)),new ur("highlightRenderCellCount",(r=>H(dr,r.horizontalCellCount,r.verticalCellCount))),new ur("highlightTextureResolution",(({highlightTexture:r})=>H(dr,r.descriptor.width,r.descriptor.height))),new it("highlightLevel",(r=>r.highlightLevel))).constants.add("cellSize","int",Z),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),t.code.add(C`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),t.main.add(C`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const dr=y();function ha(){const e=new oe;e.include(Lt);const{fragment:t}=e;return t.uniforms.add(new Ke("blurInput",(r=>r.highlightBlurTexture)),new Ar("blurSize",(r=>r.blurSize)),new ot("highlightTexture",(r=>r.highlightTexture)),new Ke("highlightOptionsTexture",(r=>r.highlightOptionsTexture)),new it("highlightLevel",(r=>r.highlightLevel)),new Er("occludedIntensityFactor",(r=>r.occludedFactor))),t.constants.add("inner","float",1-(tt-jr)/tt),e.include(Fr),t.main.add(C`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),e}const ca=Object.freeze(Object.defineProperty({__proto__:null,build:ha},Symbol.toStringTag,{value:"Module"}));let gr=class extends se{constructor(t,r){super(t,r,new ie(ca,(()=>ae(()=>import("./CFHige2F.js").then(s=>s.H),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188]),import.meta.url))))}initializePipeline(){return K({blending:Mr,colorWrite:J})}},Br=class extends Ae{constructor(){super(...arguments),this.blurSize=y()}};function ua(){const e=new oe;return e.include(Lt),e.outputs.add("fragHighlight","vec2",0),e.fragment.uniforms.add(new Ar("blurSize",(t=>t.blurSize)),new Os("blurInput",(t=>t.blurInput))).main.add(C`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),e}const da=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:Br,build:ua},Symbol.toStringTag,{value:"Module"}));let pr=class extends se{constructor(t,r){super(t,r,new ie(da,(()=>ae(()=>import("./CFHige2F.js").then(s=>s.a),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188]),import.meta.url))))}initializePipeline(){return K({colorWrite:J})}},fr=class extends se{constructor(t,r){super(t,r,new ie(la,(()=>ae(()=>import("./CFHige2F.js").then(s=>s.b),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188]),import.meta.url))))}initializePipeline(){return K({colorWrite:J})}},ga=class extends Ae{constructor(){super(...arguments),this.occludedFactor=Ai,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}};function pa(){const e=new oe;e.include(Lt),e.include(Fr);const{fragment:t}=e;return e.outputs.add("fragSingleHighlight","vec2",0),t.uniforms.add(new ot("highlightTexture",(r=>r.highlightTexture)),new it("highlightLevel",(r=>r.highlightLevel))),t.main.add(C`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),e}const fa=Object.freeze(Object.defineProperty({__proto__:null,build:pa},Symbol.toStringTag,{value:"Module"}));let _r=class extends se{constructor(t,r){super(t,r,new ie(fa,(()=>ae(()=>import("./CFHige2F.js").then(s=>s.c),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188]),import.meta.url))))}initializePipeline(){return K({colorWrite:J})}};const _a=[];new ye(f.POSITION,3,ee.FLOAT,0,12);new ye(f.POSITION,2,ee.FLOAT,0,8);new ye(f.POSITION,2,ee.FLOAT,0,12),new ye(f.UV0,2,ee.HALF_FLOAT,8,12);new ye(f.POSITION,2,ee.FLOAT,0,16),new ye(f.UV0,2,ee.FLOAT,8,16);let Ge=class extends $s{constructor(){super(...arguments),this.produces=dt.HIGHLIGHTS,this.consumes={required:[dt.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new Gr,this._passParameters=new ga,this._highlightBlurDrawParameters=new Br,this._grid=new ma}initialize(){this.addHandles([_e((()=>this._updateOptionsTexture()),(()=>{}),wt)])}destroy(){this._grid.coverage=De(this._grid.coverage),this._grid.vao=Ze(this._grid.vao),this._passParameters.highlightOptionsTexture=De(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){const t=new Wr(16,2);t.internalFormat=Ei.RGBA,t.samplingMode=Ur.NEAREST,this._passParameters.highlightOptionsTexture=new Mt(this.renderingContext,t,null)}this._passParameters.highlightOptionsTexture.setData(va(this.view.state.highlights)),this.requestRender(ke.UPDATE)}precompile(){this.techniques.precompile(fr),this.techniques.precompile(_r),this.techniques.precompile(pr),this.techniques.precompile(gr)}render(t){const r=t.find((({name:d})=>d===dt.HIGHLIGHTS)),{techniques:s,bindParameters:a,_passParameters:i,renderingContext:o}=this;if(!a.decorations)return r;const n=s.get(fr);if(!n.compiled)return this.requestRender(ke.UPDATE),r;const l=t.find((({name:d})=>d==="highlights")).getTexture();i.highlightTexture=l;const c=()=>{this._gridUpdateResources(l);const d=this._gridComputeCoverage(n,l,a),{horizontalCellCount:x,verticalCellCount:W}=d;return i.horizontalCellCount=x,i.verticalCellCount=W,i.coverageTexture=d.coverage?.getTexture(),d},p=d=>{const x=d.verticalCellCount*d.horizontalCellCount;o.bindVAO(d.vao),o.drawElementsInstanced(Fi.TRIANGLES,6,ee.UNSIGNED_BYTE,0,x)},{camera:_}=a,O=()=>{o.bindFramebuffer(r.fbo),o.setViewport4fv(_.fullViewport)};return this._renderHighlightPostprocess(l,c,p,O),i.highlightTexture=null,i.coverageTexture=null,r}_renderHighlightPostprocess(t,r,s,a){const{fboCache:i,techniques:o,bindParameters:n,_passParameters:l,renderingContext:c}=this,p=o.get(_r),_=o.get(pr),O=o.get(gr);if(!O.compiled||!_.compiled||!p.compiled)return void this.requestRender(ke.UPDATE);l.highlightTexture=t;const d=r(),{width:x,height:W}=t.descriptor;l.highlightTexture=t;const{camera:xe}=n,{fullWidth:nt,fullHeight:lt,pixelRatio:Me}=xe,be=Math.ceil(nt/Me),v=Math.ceil(lt/Me),{_highlightBlurDrawParameters:$}=this,Zr=this.view.stage.renderView.renderer,{highlights:Nt}=n;for(let Le=0;Le<Nt.length;++Le){const{name:Kr}=Nt[Le];if(!Zr.hasHighlight(Kr))continue;l.highlightLevel=Le,c.setClearColor(0,0,0,0);const ht=i.acquire(x,W,"single highlight",U.RG8UNORM);c.bindFramebuffer(ht.fbo),c.setViewport(0,0,x,W),c.clear(te.COLOR),c.bindTechnique(p,n,l),s(d),$.blurInput=ht.getTexture(),H($.blurSize,1/be,0);const Ne=i.acquire(be,v,"single highlight blur h",U.RG8UNORM);c.unbindTexture(Ne.fbo?.colorTexture),c.bindFramebuffer(Ne.fbo),c.setViewport(0,0,be,v),c.clear(te.COLOR),c.bindTechnique(_,n,l,$),s(d),ht.release(),H($.blurSize,0,1/v),l.highlightBlurTexture=Ne.getTexture(),a(),c.bindTechnique(O,n,l,$),s(d),Ne.release()}}_gridUpdateResources(t){const r=this._grid,{width:s,height:a}=t.descriptor;if(r.horizontalCellCount=Math.ceil(s/Z),r.verticalCellCount=Math.ceil(a/Z),r.vao)return;const i=this.renderingContext,o=er.createIndex(i,Jt.STATIC_DRAW,ba);r.vao=new Gi(i,Rs,new Map([["geometry",_a]]),new Map([["geometry",er.createVertex(i,Jt.STATIC_DRAW)]]),o)}_gridComputeCoverage(t,r,s){const a=this.renderingContext,i=this._grid,o=r.descriptor,n=Math.ceil(o.width/Z),l=Math.ceil(o.height/Z);this._downsampleDrawParameters.input=r;const{highlights:c}=s;i.coverage?.release();const p=this.fboCache.acquire(n,l,"highlight coverage",c.length>kr?U.RG8UINT:U.R8UINT);return i.coverage=p,a.bindFramebuffer(p.fbo),a.bindTechnique(t,s,this._passParameters,this._downsampleDrawParameters),a.setViewport(0,0,n,l),a.screen.draw(),i}get test(){}};u([b()],Ge.prototype,"produces",void 0),u([b()],Ge.prototype,"consumes",void 0),Ge=u([B("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Ge);let ma=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function va(e){const t=new Uint8Array(128);let r=0;for(const s of e){const a=4*r,i=4*r+64;++r;const{color:o}=s,n=s.haloColor??o;t[a+0]=o.r,t[a+1]=o.g,t[a+2]=o.b,t[a+3]=s.fillOpacity*o.a*255,t[i+0]=n.r,t[i+1]=n.g,t[i+2]=n.b,t[i+3]=s.haloOpacity*n.a*255}return t}let ya=0;function xa(e){let t=0;for(const s of e){const{name:a}=s;t+=a.length;const{color:i,fillOpacity:o,haloColor:n,haloOpacity:l}=s;t+=i.r+i.g+i.b+i.a+o,t+=n?n.r+n.g+n.b+n.a+l:0}const r=e.at(0);if(r){const{shadowOpacity:s,shadowDifference:a,shadowColor:i}=r;t+=s+a+i.r+i.g+i.b+i.a}return ya+++(t>=0?0:1)}const ba=new Uint8Array([0,1,2,2,1,3]);function wa(e,t,r,s,a,i=0){const{highlights:o}=s,n=o.length>1?t.acquire(r.width,r.height,"highlight mix",o.length>kr?U.RG8UINT:U.R8UINT):null,{gl:l}=e;if(n){const p=e.getBoundFramebufferObject();e.bindFramebuffer(n.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),e.bindFramebuffer(p)}const c=n?.getTexture();s.highlightMixTexture=c,H(s.highlightMixOrigin,i,0),o.forEach(((p,_)=>{if(_>0){const O=Mt.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(c,O),e.setActiveTexture(O),l.copyTexSubImage2D(Mi.TEXTURE_2D,0,0,0,i,0,r.width,r.height),e.bindTexture(null,O)}e.clear(te.DEPTH),s.highlightLevel=_,a()})),s.highlightLevel=null,s.highlightMixTexture=null,n?.release()}const kr=4;let Ca=class{constructor(t,r,s,a){this.material=t,this.output=r,this.techniques=s,this.textures=a}},Ta=class{constructor(t,r,s,a){this._textures=t,this._techniques=r,this.materialChanged=s,this.requestRender=a,this._id2glMaterialRef=new Ni}dispose(){this._textures.destroy()}acquire(t,r,s){if(this._ownMaterial(t),!t.produces.get(r)?.(s))return null;let i=this._id2glMaterialRef.get(s,t.id);if(i==null){const o=t.createGLMaterial(new Ca(t,s,this._techniques,this._textures));i=new Oa(o),this._id2glMaterialRef.set(s,t.id,i)}return i.ref(),i.glMaterial}release(t,r){const s=this._id2glMaterialRef.get(r,t.id);s!=null&&(s.unref(),s.referenced||(Ze(s.glMaterial),this._id2glMaterialRef.delete(r,t.id)))}_ownMaterial(t){t.repository&&t.repository!==this&&Si.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),t.repository=this}},Oa=class{constructor(t){this.glMaterial=t,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,me(this._refCnt>=0)}get referenced(){return this._refCnt>0}};var rt;(function(e){e[e.Immediate=0]="Immediate",e[e.FadeWithWeather=1]="FadeWithWeather"})(rt||(rt={}));let $a=class{constructor(t){this.shadowMap=t,this.slot=F.OPAQUE_MATERIAL,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=At.NONE,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new at,this._inverseViewport=y(),this._oldLighting=new gt,this._newLighting=new gt,this._fadedLighting=new gt,this._lighting=this._newLighting,this.ssr=new Ra,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=y(),this.highlightMixTexture=null,this.hudRenderStyle=Vi.Occluded,this.hudOccludedFragmentOpacity=1,this.snowCover=!1,this.clouds=new Xi,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(t){this._camera=t,this._inverseViewport[0]=1/t.fullViewport[2],this._inverseViewport[1]=1/t.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(t,r,s,a){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=r,this._newLighting.globalFactor=s,this._newLighting.set(t),a===rt.FadeWithWeather&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},Ra=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=N()}},Sa=class{constructor(t,r,s){this.rctx=t,this.techniques=s,this.lastFrameCamera=new at,this.output=R.Color,this.renderOccludedMask=Xe,this.time=es(0),this.bind=new $a(r),this.bind.alignPixelEnabled=!0}};const Xe=Se.Occlude|Se.OccludeAndTransparent|Se.OccludeAndTransparentStencil;let $e=class extends at{constructor(){super(...arguments),this._projectionMatrix=N()}get projectionMatrix(){return this._projectionMatrix}};u([b()],$e.prototype,"_projectionMatrix",void 0),u([b({readOnly:!0})],$e.prototype,"projectionMatrix",null),$e=u([B("esri.views.3d.webgl-engine.lib.CascadeCamera")],$e);var st;(function(e){e[e.Highlight=0]="Highlight",e[e.ExcludeHighlight=1]="ExcludeHighlight"})(st||(st={}));let je=class{constructor(){this.camera=new $e,this.lightMat=N()}},Da=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},Pa=class{constructor(t,r){this._fbos=t,this._viewingMode=r,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Da,this._projectionView=N(),this._projectionViewInverse=N(),this._modelViewLight=N(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Dt(),this._cascades=[new je,new je,new je,new je],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(Ri("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(Ve)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return tr(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=De(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(t){this.settings.maxNumCascadesHighQuality=Vr(Math.floor(t),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(t){this._enabled=t,t||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let t=0;t<this._numCascades;++t)vt[t]=this._cascades[t];return vt.length=this._numCascades,vt}start(t,r,s,a,i){me(this.enabled);const{near:o,far:n}=La(s);this._computeCascadeDistances(o,n,a),this._textureHeight=this._computeTextureHeight(t,i,a),this._setupMatrices(t,r);const{viewMatrix:l,projectionMatrix:c}=t;for(let p=0;p<this._numCascades;++p)this._constructCascade(p,c,l,r);this._lastOrigin=null,this.clear()}finish(){me(this.enabled)}getShadowMapMatrices(t){if(!this._lastOrigin||!gs(t,this._lastOrigin)){this._lastOrigin=this._lastOrigin||Ee(),q(this._lastOrigin,t);for(let r=0;r<this._numCascades;++r){Vt(wr,this._cascades[r].lightMat,t);for(let s=0;s<16;++s)Cr[16*r+s]=wr[s]}}return Cr}moveSnapshot(t){me(this.enabled),this._snapshots[t]?.release(),this._snapshots[t]=this._handle,this._handle?.setName(t===st.Highlight?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(t){if(!this.enabled||!this._handle?.getTexture(Ve)?.descriptor)return;this._snapshots[t]?.release();const s=t===st.Highlight?"shadow map highlight":"shadow map excluding highlight",a=this._acquireFBO(s);this._snapshots[t]=a;const i=this._handle?.fbo;if(!i||!a?.fbo)return void console.error("No FBO");const{rctx:o}=this._fbos;o.blitFramebuffer(i,a.fbo,te.DEPTH)}getSnapshot(t){return this.enabled?this._snapshots[t]?.getTexture(Ve):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(te.DEPTH)}_computeTextureHeight({pixelRatio:t,fullWidth:r,fullHeight:s},a,i){const o=Math.min(window.devicePixelRatio,a)/t,n=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return Ss(Math.max(r,s)*o*n,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(t){const r=this._fbos.acquire(this._textureWidth,this._textureHeight,t,Ds.DEPTH16);return r.getTexture(Ve)?.setShadowFiltering(!0),r}_discardSnapshot(t){this._snapshots[t]=De(this._snapshots[t])}_discardSnapshots(){for(let t=0;t<this._snapshots.length;++t)this._discardSnapshot(t);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(t,r,s,a){const i=this._cascades[t],o=-this._cascadeDistances[t],n=-this._cascadeDistances[t+1],l=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),c=(r[10]*n+r[14])/Math.abs(r[11]*n+r[15]);me(l<c);for(let d=0;d<8;++d){tr(mr,d%4==0||d%4==3?-1:1,d%4==0||d%4==1?-1:1,d<4?l:c,1);const x=L[d];Wi(x,mr,this._projectionViewInverse),x[0]/=x[3],x[1]/=x[3],x[2]/=x[3]}ps(mt,L[0]),i.camera.viewMatrix=Vt(Ia,this._modelViewLight,mt);for(let d=0;d<8;++d)Sr(L[d],L[d],i.camera.viewMatrix);let p=L[0][2],_=L[0][2];for(let d=1;d<8;++d)p=Math.min(p,L[d][2]),_=Math.max(_,L[d][2]);p-=200,_+=200,i.camera.near=-_,i.camera.far=-p,Ma(s,a,p,_,i.camera),bt(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const O=this._textureHeight;i.camera.viewport=[t*O,0,O,O]}_setupMatrices(t,r){bt(this._projectionView,t.projectionMatrix,t.viewMatrix),ss(this._projectionViewInverse,this._projectionView);const s=this._viewingMode===Nr.Global?t.eye:Dr(mt,0,0,1);is(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],s)}_computeCascadeDistances(t,r,s){const a=s?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Hi(r/t,4)),a);const i=(r-t)/this._numCascades,o=(r/t)**(1/this._numCascades);let n=t,l=t;for(let c=0;c<this._numCascades+1;++c)this._cascadeDistances[c]=Di(n,l,this.settings.splitSchemeLambda),n*=o,l+=i}get test(){}};const Ia=N(),mr=Dt(),L=[];for(let e=0;e<8;++e)L.push(Dt());const vr=y(),yr=y(),Aa=y(),xr=y(),br=y(),mt=Ee(),vt=[],wr=N(),Cr=X.concat(X,X,X,X),M=y(),ue=y(),Q=[y(),y(),y(),y()],T=y(),yt=y(),z=y(),Oe=y(),de=y(),ge=y(),Be=y();function Ea(e,t,r,s,a,i,o,n){H(M,0,0);for(let v=0;v<4;++v)Y(M,M,e[v]);pe(M,M,.25),H(ue,0,0);for(let v=4;v<8;++v)Y(ue,ue,e[v]);pe(ue,ue,.25),Ce(Q[0],e[4],e[5],.5),Ce(Q[1],e[5],e[6],.5),Ce(Q[2],e[6],e[7],.5),Ce(Q[3],e[7],e[4],.5);let l=0,c=Bt(Q[0],M);for(let v=1;v<4;++v){const $=Bt(Q[v],M);$<c&&(c=$,l=v)}fe(T,Q[l],e[l+4]);const p=T[0];let _,O;T[0]=-T[1],T[1]=p,fe(yt,ue,M),D(yt,T)<0&&di(T,T),Ce(T,T,yt,r),kt(T,T),_=O=D(fe(z,e[0],M),T);for(let v=1;v<8;++v){const $=D(fe(z,e[v],M),T);$<_?_=$:$>O&&(O=$)}gi(s,M),pe(z,T,_-t),Y(s,s,z);let d=-1,x=1,W=0,xe=0;for(let v=0;v<8;++v){fe(Oe,e[v],s),kt(Oe,Oe);const $=T[0]*Oe[1]-T[1]*Oe[0];$>0?$>d&&(d=$,W=v):$<x&&(x=$,xe=v)}ne(d>0,"leftArea"),ne(x<0,"rightArea"),pe(de,T,_),Y(de,de,M),pe(ge,T,O),Y(ge,ge,M),Be[0]=-T[1],Be[1]=T[0];const nt=Ue(s,e[xe],ge,Y(z,ge,Be),1,a),lt=Ue(s,e[W],ge,z,1,i),Me=Ue(s,e[W],de,Y(z,de,Be),1,o),be=Ue(s,e[xe],de,z,1,n);ne(nt,"rayRay"),ne(lt,"rayRay"),ne(Me,"rayRay"),ne(be,"rayRay")}function g(e,t){return 3*t+e}const Tr=y();function I(e,t){return H(Tr,e[t],e[t+3]),Tr}const P=y(),h=Ui();function Fa(e,t,r,s,a){fe(P,r,s),pe(P,P,.5),h[0]=P[0],h[1]=P[1],h[2]=0,h[3]=P[1],h[4]=-P[0],h[5]=0,h[6]=P[0]*P[0]+P[1]*P[1],h[7]=P[0]*P[1]-P[1]*P[0],h[8]=1,h[g(0,2)]=-D(I(h,0),e),h[g(1,2)]=-D(I(h,1),e);let i=D(I(h,0),r)+h[g(0,2)],o=D(I(h,1),r)+h[g(1,2)],n=D(I(h,0),s)+h[g(0,2)],l=D(I(h,1),s)+h[g(1,2)];i=-(i+n)/(o+l),h[g(0,0)]+=h[g(1,0)]*i,h[g(0,1)]+=h[g(1,1)]*i,h[g(0,2)]+=h[g(1,2)]*i,i=1/(D(I(h,0),r)+h[g(0,2)]),o=1/(D(I(h,1),r)+h[g(1,2)]),h[g(0,0)]*=i,h[g(0,1)]*=i,h[g(0,2)]*=i,h[g(1,0)]*=o,h[g(1,1)]*=o,h[g(1,2)]*=o,h[g(2,0)]=h[g(1,0)],h[g(2,1)]=h[g(1,1)],h[g(2,2)]=h[g(1,2)],h[g(1,2)]+=1,i=D(I(h,1),t)+h[g(1,2)],o=D(I(h,2),t)+h[g(2,2)],n=D(I(h,1),r)+h[g(1,2)],l=D(I(h,2),r)+h[g(2,2)],i=-.5*(i/o+n/l),h[g(1,0)]+=h[g(2,0)]*i,h[g(1,1)]+=h[g(2,1)]*i,h[g(1,2)]+=h[g(2,2)]*i,i=D(I(h,1),t)+h[g(1,2)],o=D(I(h,2),t)+h[g(2,2)],n=-o/i,h[g(1,0)]*=n,h[g(1,1)]*=n,h[g(1,2)]*=n,a[0]=h[0],a[1]=h[1],a[2]=0,a[3]=h[2],a[4]=h[3],a[5]=h[4],a[6]=0,a[7]=h[5],a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=h[6],a[13]=h[7],a[14]=0,a[15]=h[8]}function Ma(e,t,r,s,a){const i=1/L[0][3],o=1/L[4][3];me(i<o);let n=i+Math.sqrt(i*o);const l=Math.sin(Pi(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));n/=l,Ea(L,n,l,vr,yr,Aa,xr,br),Fa(vr,yr,xr,br,a.projectionMatrix),a.projectionMatrix[10]=2/(r-s),a.projectionMatrix[14]=-(r+s)/(r-s)}function La(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}let Or=class extends se{constructor(t,r){super(t,r,new ie(ia,(()=>ae(()=>import("./CFHige2F.js").then(s=>s.T),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188]),import.meta.url))))}initializePipeline(t){return t.hasAlpha?K({blending:Mr,colorWrite:J}):K({colorWrite:J})}},Yr=class extends Ps{constructor(){super(...arguments),this.hasAlpha=!1}};u([A()],Yr.prototype,"hasAlpha",void 0);let Qr=class extends Ae{constructor(){super(...arguments),this.overlayIndex=j.INNER,this.opacity=1}};function Na(){const e=new oe;return e.include(It),e.fragment.uniforms.add(new Ke("tex",(t=>t.texture))),e.fragment.uniforms.add(new it("overlayIdx",(t=>t.overlayIndex))),e.fragment.uniforms.add(new Er("opacity",(t=>t.opacity))),e.fragment.main.add(C`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}const Ha=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Qr,build:Na},Symbol.toStringTag,{value:"Module"}));let $r=class extends se{constructor(t,r){super(t,r,new ie(Ha,(()=>ae(()=>import("./CFHige2F.js").then(s=>s.O),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188]),import.meta.url))))}},V=class extends oa{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Qr,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new ts,this._passParameters=new zr,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new at,this.events=new Ti,this.longitudeCyclical=null,this.produces=new Map([[F.DRAPED_MATERIAL,t=>t!==R.Highlight||this.hasHighlights],[F.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this._view,t=e.stage,r=t.renderer.fboCache,{waterTextures:s,techniques:a}=t.renderView;this._renderContext=new Sa(this._rctx,new Pa(r,e.state.viewingMode),a),this.addHandles([_e((()=>s.updating),(()=>this.events.emit("content-changed")),Xt),_e((()=>this.spatialReference),(n=>this._localOriginFactory=new xi(n)),Xt),Oi((()=>e.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0)),_e((()=>xa(e.state.highlights)),(()=>this._sortedDrapeSourceRenderersDirty=!0),wt),_e((()=>e.state.highlights),(n=>{this._bindParameters.highlights=n,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap}),wt),e.resourceController.scheduler.registerTask(zi.OVERLAY_RENDERER,this)]);const{_bindParameters:i,_camera:o}=this;o.near=1,o.far=1e4,o.relativeElevation=null,i.slot=F.DRAPED_MATERIAL,i.mainDepth=null,i.camera=o,i.oitPass=At.NONE,i.updateLighting([new Is(ci())],0,0,rt.Immediate)}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._passParameters.texture=Ze(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new Ta(this._view.stage.renderView.textures,this._techniques,(()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed")));this._pluginContext={...e,materials:t},this._techniques.precompile($r)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||we(this._renderers,(e=>e.updating||e.canCompact))}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map((e=>e.drapeSource.layer)).filter((e=>!!e))}registerDrapeSource(e,t){const r=this._renderers.get(e);r?.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(_e((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e)}removeDrapeSourceRenderer(e){if(e==null)return;const t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&ct(e,(t=>t.drapeTargetType===bi.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=ct(e,(t=>t.drapeSourceType===He.Features)),this._hasDrapedRasterSource=ct(e,(t=>t.drapeSourceType===He.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new ki(this._stage.renderer.fboCache),this._overlays=[new or,new or]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=Ze(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){return e===w.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(w.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let r=!1;for(const[s,a]of this._renderers){if(e.done)break;(s.destroyed||t(s))&&a.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=we(this._renderers,(s=>s.hasHighlights)),this.notifyChange("rendersOccludedDraped"))}compact(e){let t=!1;for(const r of this._renderers.values()){if(e.done)break;t=r.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return we(this._renderers,(t=>t.hasHighlight(e)))}processSyncDrapeSources(){this._processDrapeSources(qi,(e=>e.updatePolicy===wi.SYNC))}get isEmpty(){return!pt.OVERLAY_DRAW_DEBUG_TEXTURE&&!we(this._renderers,(e=>!e.isEmpty))}get hasWater(){const e=we(this._renderers,(({hasWater:t})=>t));return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=xt,++this._techniques.precompiling;const t=this._sortedRenderers.some((({renderer:r})=>r.precompile(this._renderContext)));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=e,t}renders(e){if(pt.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==w.Occluded&&e!==w.Highlight)return!0;if(!this._overlays)return!1;const t=this._overlays[j.INNER];for(const a of this._overlays)a.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;const r=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find((a=>a.content===e))?.output??R.Color,++this._techniques.precompiling;const s=this._sortedRenderers.some((({renderer:a})=>a.precompile(this._renderContext)));return--this._techniques.precompiling,this._renderContext.output=r,s}get mode(){return this.isEmpty?ve.Disabled:this.hasWater&&this.renders(w.WaterNormal)?ve.EnabledWithWater:this._renderTargets?.getTexture(w.Color)?ve.Enabled:ve.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach((r=>t=r.updateAnimation(e)||t)),t&&this.parent.requestRender(ke.BACKGROUND),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const r of this._renderTargets.targets){if(r.content===w.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const s=r.output;this._renderContext.output=s,t.slot=s===R.Normal?F.DRAPED_WATER:F.DRAPED_MATERIAL,s===R.Highlight&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null),r.content===w.Occluded&&(this._renderContext.renderOccludedMask=xt),this._sortedRenderers.forAll((({drapeSource:a,renderer:i})=>{r.content===w.ColorNoRasterImage&&a.drapeSourceType===He.RasterImage||i.precompile(this._renderContext)})),this._renderContext.renderOccludedMask=Xe,t.highlightMixTexture=null}--this._techniques.precompiling}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const t of this._overlays)t.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;for(const t of this._renderTargets.targets){if(t.content===w.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=this._drawTarget(j.INNER,t),s=this._drawTarget(j.OUTER,t);(r||s)&&t.fbo.generateMipMap()}}}_drawTarget(e,t){const r=this._overlays[e],s=r.canvasGeometries;if(s.numViews===0)return!1;const a=this._view.state.contentPixelRatio;this._screenToWorldRatio=a*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:i}=t;if(this.isEmpty||i===R.Normal&&!this.hasWater||!r.hasSomeSizedView())return!1;const{_rctx:o,_camera:n,_renderContext:l,_bindParameters:c}=this;if(n.pixelRatio=r.pixelRatio*a,l.output=i,c.screenToWorldRatio=this._screenToWorldRatio,c.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,c.slot=i===R.Normal?F.DRAPED_WATER:F.DRAPED_MATERIAL,t.content===w.Occluded&&(l.renderOccludedMask=xt),!this.renders(t.content))return l.renderOccludedMask=Xe,!1;const{resolution:p}=r,_=e===j.INNER,O=_?0:p;if(o.setViewport(O,0,p,p),this._bindTargetFBO(t),_)if(t.output!==R.Highlight)o.setClearColor(0,0,0,0),o.clear(te.COLOR);else{const{gl:d}=o;d.clearBufferuiv(d.COLOR,0,[0,0,0,0])}if(pt.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==w.Occluded&&t.content!==w.Highlight){this._techniques.precompile(Or,St);const d=this._techniques.get(Or,St);for(let x=0;x<s.numViews;x++)this._setViewParameters(s.extents[x],r),this._ensureDebugPatternResources(r.resolution,Ua[e]),o.bindTechnique(d,c,this._passParameters),o.screen.draw()}if(t.output===R.Highlight){const{fboCache:d}=this._stage.renderer,x=this._resolution;this._bindTargetFBO(t),wa(o,d,{width:x,height:x},c,(()=>this._renderAllGeometry(e,t)),O)}else this._renderAllGeometry(e,t);return o.bindFramebuffer(null),l.renderOccludedMask=Xe,!0}_renderAllGeometry(e,t){const r=this._overlays[e],s=r.canvasGeometries;this._sortedRenderers.forAll((({drapeSource:a,renderer:i})=>{if(t.content===w.ColorNoRasterImage&&a.drapeSourceType===He.RasterImage)return;const{fullOpacity:o}=a,n=o!=null&&o<1&&t.output===R.Color&&this._bindTemporaryFBO();for(let l=0;l<s.numViews;l++)this._setViewParameters(s.extents[l],r),i.render(this._renderContext);if(n){this._bindTargetFBO(t),this._overlayParameters.texture=n.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;const l=this._techniques.get($r);this._rctx.bindTechnique(l,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),n.release()}}))}_bindTargetFBO(e){const t=this._resolution,r=2*t;e.fbo.bind(this._rctx,r,t)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,r=this._stage.renderer.fboCache,s=r.acquire(t,e,"overlay tmp");return r.rctx.bindFramebuffer(s.fbo),r.rctx.clear(te.COLOR),s}get _resolution(){return this._overlays?.[j.INNER].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,s){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let a=0;for(const{renderer:i}of this._sortedRenderers)a=i.intersect?.(e,t,r,s,a)??a}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this._view.map.allLayers,t=e.length;this._renderers.forEach(((r,s)=>{const a=e.indexOf(s.layer),i=a>=0,o=s.renderGroup??(i?Qt.MapLayer:Qt.ViewLayer),n=s.drapeSourcePriorityOffset??0,l=t*o+(i?a:0)+n;this._sortedRenderers.push(new Va(s,r,l))})),this._sortedRenderers.sort(((r,s)=>r.index-s.index))}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],as(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),os(r.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(Dr(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let s=0;for(let i=0;i<e;i++)for(let o=0;o<e;o++){const n=Math.floor(o/10),l=Math.floor(i/10);n<2||l<2||10*n>e-20||10*l>e-20?(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=255):(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=1&n&&1&l?1&o^1&i?0:255:1&n^1&l?0:128)}const a=new Wr(e);a.samplingMode=Ur.NEAREST,this._passParameters.texture=new Mt(this._rctx,a,r)}get test(){}};u([b()],V.prototype,"hasHighlights",void 0),u([b()],V.prototype,"_sortedDrapeSourceRenderersDirty",void 0),u([b({constructOnly:!0})],V.prototype,"parent",void 0),u([b({readOnly:!0})],V.prototype,"_techniques",null),u([b({type:Boolean,readOnly:!0})],V.prototype,"updating",null),u([b()],V.prototype,"isEmpty",null),u([b({readOnly:!0})],V.prototype,"rendersOccludedDraped",null),V=u([B("esri.views.3d.terrain.OverlayRenderer")],V);class Va{constructor(t,r,s){this.drapeSource=t,this.renderer=r,this.index=s}}const Ua=[[1,.5,.5],[.5,.5,1]],Wa=-2,xt=Se.OccludeAndTransparent,St=new Yr;St.hasAlpha=!0;let zn=class{constructor(t,r={}){this.geometry=t,this.screenToWorldRatio=1,this._transformation=N(),this._shaderTransformation=null,this._boundingSphere=null,this.id=rs(),this.layerViewUid=r.layerViewUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(t){ns(this._transformation,t),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(t){t==null?this._shaderTransformation=null:(this._shaderTransformation??=N(),bt(this._shaderTransformation,t,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??=_s(),Sr(ms(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*vs(this.shaderTransformation)),this._boundingSphere):fs}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlight(){return this.geometry.highlights}foreachHighlightOptions(t){this.geometry.foreachHighlightOptions(t)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(t){this.geometry.visible=t}},za=class extends As{constructor(){super(...arguments),this._pp0=Pe(0,0,1),this._pp1=Pe(0,0,0)}intersect(t,r,s,a,i,o){return Gt(t,s,a,i,void 0,o)}intersectDraped(t,r,s,a){return this._pp0[0]=this._pp1[0]=s[0],this._pp0[1]=this._pp1[1]=s[1],Gt(t,r,this._pp0,this._pp1,void 0,a)}};function qa(e){const t=new oe,{vertex:r,fragment:s,attributes:a,varyings:i}=t,{vvColor:o,hasVertexColors:n}=e;return Es(r,e),t.include(Fs,e),t.include(Ms,e),t.include(Ls,e),t.include(Ns,e),s.include(Hs,e),t.include(Vs,e),t.include(Us,e),a.add(f.POSITION,"vec3"),o&&a.add(f.COLORFEATUREATTRIBUTE,"float"),n||i.add("vColor","vec4"),i.add("vpos","vec3",{invariant:!0}),r.uniforms.add(new Ws("uColor",(l=>l.color))),r.main.add(C`
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${n?"vColor *= uColor;":o?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
      gl_Position = transformPosition(proj, view, vpos);`),s.include(zs),s.main.add(C`discardBySlice(vpos);
discardByTerrainDepth();
outputColorHighlightOID(vColor, vpos, vColor.rgb);`),t}const Ga=Object.freeze(Object.defineProperty({__proto__:null,build:qa},Symbol.toStringTag,{value:"Module"}));class ja extends se{constructor(t,r){super(t,r,new ie(Ga,(()=>ae(()=>import("./CFHige2F.js").then(s=>s.C),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188]),import.meta.url))))}_createPipeline(t,r){const{oitPass:s,output:a,transparent:i,cullFace:o,draped:n,hasOccludees:l,polygonOffset:c}=t,p=s===At.NONE;return K({blending:Pr(a)&&i?Xs(s):null,culling:ui(o),depthTest:n?null:{func:Qs(s)},depthWrite:Ys(t),drawBuffers:ks(a,Zs(s,a)),colorWrite:J,stencilWrite:l?Bs:null,stencilTest:l?r?Gs:js:null,polygonOffset:p?c?Ba:null:qs(t)})}initializePipeline(t){return this._occludeePipelineState=this._createPipeline(t,!0),this._createPipeline(t,!1)}getPipeline(t){return t?this._occludeePipelineState:super.getPipeline()}}const Ba={factor:1,units:1};let E=class extends Ks{constructor(){super(...arguments),this.cullFace=Et.None,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1,this.textureCoordinateType=Js.None,this.emissionSource=ei.None,this.occlusionPass=!1,this.hasVvInstancing=!0,this.vvSize=!1,this.vvOpacity=!1,this.snowCover=!1}};u([A({count:Et.COUNT})],E.prototype,"cullFace",void 0),u([A()],E.prototype,"hasVertexColors",void 0),u([A()],E.prototype,"transparent",void 0),u([A()],E.prototype,"discardInvisibleFragments",void 0),u([A()],E.prototype,"polygonOffset",void 0),u([A()],E.prototype,"enableOffset",void 0),u([A()],E.prototype,"writeDepth",void 0),u([A()],E.prototype,"hasOccludees",void 0),u([A()],E.prototype,"terrainDepthTest",void 0),u([A()],E.prototype,"cullAboveTerrain",void 0),u([A()],E.prototype,"objectAndLayerIdColorInstanced",void 0),u([A()],E.prototype,"vvColor",void 0),u([A()],E.prototype,"draped",void 0);let Bn=class extends za{constructor(t){super(t,Ya),this._configuration=new E,this.supportsEdges=!0,this.produces=new Map([[F.OPAQUE_MATERIAL,r=>this._isOpaqueMaterialPass(r)],[F.OPAQUE_MATERIAL_WITHOUT_NORMALS,r=>this._isOpaqueNoSSAODepthPass(r)],[F.TRANSPARENT_MATERIAL,r=>ut(r)&&this._transparent&&this.parameters.writeDepth],[F.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,r=>Ut(r)&&this._transparent&&this.parameters.writeDepth],[F.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,r=>ut(r)&&this._transparent&&!this.parameters.writeDepth],[F.DRAPED_MATERIAL,r=>bs(r)]])}getConfiguration(t,r){return super.getConfiguration(t,r,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(t)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=r.hasOccludees,this._configuration.oitPass=r.oitPass,this._configuration.enableOffset=r.camera.relativeElevation<ti,this._configuration.terrainDepthTest=r.terrainDepthTest&&Pr(t),this._configuration.cullAboveTerrain=r.cullAboveTerrain,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=ri}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(t){return this._isOpaqueMaterialPass(t)||this._isOpaqueNoSSAODepthPass(t)}_isOpaqueMaterialPass(t){return t===R.Highlight||ut(t)&&!this._transparent}_isOpaqueNoSSAODepthPass(t){return Ut(t)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(t){return new ka(t)}createBufferWriter(){const t=re().vec3f(f.POSITION);return Ir()&&t.vec4u8(f.OLIDCOLOR),this.parameters.vvColor?t.f32(f.COLORFEATUREATTRIBUTE):t.vec4u8(f.COLOR),new si(t)}},ka=class extends ai{beginSlot(t){return this.getTechnique(ja,t)}};class Ya extends ii{constructor(){super(...arguments),this.color=ys,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Et.None,this.draped=!1,this.discardInvisibleFragments=!1}}var Rr;(function(e){e[e.EnableFastUpdates=0]="EnableFastUpdates",e[e.DisableFastUpdates=1]="DisableFastUpdates",e[e.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"})(Rr||(Rr={}));const S={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},Qa={dash:S.dash,"dash-dot":[...S.dash,...S.dot],dot:S.dot,"long-dash":S["long-dash"],"long-dash-dot":[...S["long-dash"],...S.dot],"long-dash-dot-dot":[...S["long-dash"],...S.dot,...S.dot],none:null,"short-dash":S["short-dash"],"short-dash-dot":[...S["short-dash"],...S["short-dot"]],"short-dash-dot-dot":[...S["short-dash"],...S["short-dot"],...S["short-dot"]],"short-dot":S["short-dot"],solid:null},Xa=8;function Za(e,t){return e==null?e:{pattern:e.slice(),pixelRatio:t}}function Qn(e){return{pattern:[e,e],pixelRatio:2}}function Xn(e){return e?.type==="style"?Ka(e.style):null}function Ka(e){return e!=null?Za(Qa[e],Xa):null}function Zn(e,t,r=null){const s=[],a=t.mapPositions;Ja(t,s);const i=s[0][1].data,o=s[0][1].indices.length,n=vi(o);return eo(t,s,n),so(t,s,n),to(t,s,n),ro(t,s,n),io(t,s,n),ao(t,s,n),oo(t,s,i),new oi(e,s,a,ni.Line,r)}function Ja(e,t){const{attributeData:{position:r},removeDuplicateStartEnd:s}=e,a=no(r)&&s,i=r.length/3-(a?1:0),o=new Array(2*(i-1)),n=a?r.slice(0,-3):r;let l=0;for(let c=0;c<i-1;c++)o[l++]=c,o[l++]=c+1;t.push([f.POSITION,new k(n,o,3,a)])}function eo(e,t,r){if(e.attributeData.colorFeature!=null)return;const s=e.attributeData.color;t.push([f.COLOR,new k(s??xs,r,4)])}function to(e,t,r){e.attributeData.normal&&t.push([f.NORMAL,new k(e.attributeData.normal,r,3)])}function ro(e,t,r){e.attributeData.colorFeature!=null&&t.push([f.COLORFEATUREATTRIBUTE,new k([e.attributeData.colorFeature],r,1,!0)])}function so(e,t,r){e.attributeData.sizeFeature==null&&t.push([f.SIZE,new k([e.attributeData.size??1],r,1,!0)])}function io(e,t,r){e.attributeData.sizeFeature!=null&&t.push([f.SIZEFEATUREATTRIBUTE,new k([e.attributeData.sizeFeature],r,1,!0)])}function ao(e,t,r){e.attributeData.opacityFeature!=null&&t.push([f.OPACITYFEATUREATTRIBUTE,new k([e.attributeData.opacityFeature],r,1,!0)])}function oo(e,t,r){if(e.overlayInfo==null||e.overlayInfo.renderCoordsHelper.viewingMode!==Nr.Global||!e.overlayInfo.spatialReference.isGeographic)return;const s=Lr(r.length),a=fi(e.overlayInfo.spatialReference);for(let _=0;_<s.length;_+=3)_i(r,_,s,_,a);const i=r.length/3,o=li(i+1);let n=lo,l=ho,c=0,p=0;H(n,s[p++],s[p++]),p++,o[0]=0;for(let _=1;_<i+1;++_)_===i&&(p=0),H(l,s[p++],s[p++]),p++,c+=pi(n,l),o[_]=c,[n,l]=[l,n];t.push([f.DISTANCETOSTART,new k(o,t[0][1].indices,1,!0)])}function no(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}const lo=y(),ho=y();function Kn(e,t,r,s){const a=e.type==="polygon"?Je.CCW_IS_HOLE:Je.NONE,i=e.type==="polygon"?e.rings:e.paths,{position:o,outlines:n}=Hr(i,!!e.hasZ,a,e.spatialReference),l=Lr(o.length),c=Ci(o,e.spatialReference,0,l,0,o,0,o.length/3,t,r,s),p=c!=null;return{lines:p?Xr(n,o,l):[],projectionSuccess:p,sampledElevation:c}}function Jn(e,t){const r=e.type==="polygon"?Je.CCW_IS_HOLE:Je.NONE,s=e.type==="polygon"?e.rings:e.paths,{position:a,outlines:i}=Hr(s,!1,r),o=mi(a,e.spatialReference,0,a,t,0);for(let n=2;n<a.length;n+=3)a[n]=Wa;return{lines:o?Xr(i,a):[],projectionSuccess:o}}function Xr(e,t,r=null){const s=new Array;for(const{index:a,count:i}of e){if(i<=1)continue;const o=3*a,n=3*i;s.push({position:Yt(t,3*a,3*i),mapPositions:r!=null?Yt(r,o,n):void 0})}return s}const el=re().vec3f(f.POSITION),tl=re().vec3f(f.POSITION).vec2f16(f.UV0),rl=re().vec3f(f.POSITION).vec4u8(f.COLOR);re().vec3f(f.POSITION).vec2f16(f.UV0).vec4u8(f.OLIDCOLOR);const sl=re().vec3f(f.POSITION).vec2f(f.UV0),il=re().vec3f(f.POSITION).vec2f(f.UV0).vec4u8(f.OLIDCOLOR);export{Bn as A,sa as B,dn as C,Qr as D,rr as E,Na as F,qa as G,sr as I,el as a,Zn as b,Rr as c,mn as d,za as e,rl as f,zn as g,il as h,sl as i,Qn as j,tl as k,Jn as l,ha as m,Xn as n,Br as o,Kn as p,ua as q,Gi as r,Gr as s,Wa as t,jr as u,na as v,Z as w,tt as x,pa as y,zr as z};
