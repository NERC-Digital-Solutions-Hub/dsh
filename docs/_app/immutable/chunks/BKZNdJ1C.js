import{l as T,v as c,m as $}from"./BFGjv385.js";import{s as F}from"./DSdBzmdi.js";import{i as R}from"./r_tU0ZMk.js";import{I as U,s as E,w as V,c as b,x as B,l as O}from"./gvnm7ut2.js";import{Z as y,d as X}from"./DzPnzJx5.js";import{r as k}from"./B4fwd4MG.js";import{t as G}from"./DIUYgbCK.js";import{u as N}from"./DE7MWQCs.js";import{_ as W}from"./PPVm8Dsz.js";import{n as z}from"./CSadq5My.js";import{Y as h}from"./DQOO6RKE.js";import{A as f,_ as K,h as j,n as q}from"./DMy-0e9p.js";import{S as Y}from"./Cg7k00wG.js";import{s as Z}from"./D4M_-EvY.js";function J(){return w??=(async()=>{const a=await W(()=>import("./DuG70Smz.js"),[],import.meta.url),t=await a.default({locateFile:e=>z(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t})(),w}let w,o=null,g=null;async function A(){return g==null&&(g=J(),o=await g),g}function Q(a,t){if(o==null)return a.byteLength;const e=new o.BasisFile(new Uint8Array(a)),r=C(e)?D(e.getNumLevels(0),e.getHasAlpha(),e.getImageWidth(0,0),e.getImageHeight(0,0),t):0;return e.close(),e.delete(),r}function tt(a,t){if(o==null)return a.byteLength;const e=new o.KTX2File(new Uint8Array(a)),r=I(e)?D(e.getLevels(),e.getHasAlpha(),e.getWidth(),e.getHeight(),t):0;return e.close(),e.delete(),r}function D(a,t,e,r,i){const s=K(t?h.COMPRESSED_RGBA8_ETC2_EAC:h.COMPRESSED_RGB8_ETC2),n=i&&a>1?(4**a-1)/(3*4**(a-1)):1;return Math.ceil(e*r*s*n)}function C(a){return a.getNumImages()>=1&&!a.isUASTC()}function I(a){return a.getFaces()>=1&&a.isETC1S()}async function et(a,t,e){o==null&&(o=await A());const r=new o.BasisFile(new Uint8Array(e));if(!C(r))return null;r.startTranscoding();const i=v(a,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(s,n)=>r.getImageTranscodedSizeInBytes(0,s,n),(s,n,l)=>r.transcodeImage(l,0,s,n,0,0));return r.close(),r.delete(),i}async function rt(a,t,e){o==null&&(o=await A());const r=new o.KTX2File(new Uint8Array(e));if(!I(r))return null;r.startTranscoding();const i=v(a,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(s,n)=>r.getImageTranscodedSizeInBytes(s,0,0,n),(s,n,l)=>r.transcodeImage(l,s,0,0,n,0,-1,-1));return r.close(),r.delete(),i}function v(a,t,e,r,i,s,n,l){const{compressedTextureETC:d,compressedTextureS3TC:x}=a.capabilities,[p,P]=d?r?[1,h.COMPRESSED_RGBA8_ETC2_EAC]:[0,h.COMPRESSED_RGB8_ETC2]:x?r?[3,h.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,h.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],H=t.hasMipmap?e:Math.min(1,e),_=[];for(let u=0;u<H;u++)_.push(new Uint8Array(n(u,p))),l(u,p,_[u]);return t.internalFormat=P,t.hasMipmap=_.length>1,t.samplingMode=t.hasMipmap?9987:9729,t.width=i,t.height=s,new f(a,t,{type:"compressed",levels:_})}const m=16;function M(a,t){return t=Math.floor(t/m)*m,Math.min(Math.round(a/m)*m,t)}function wt(a,t){return t=Math.floor(t/m)*m,Math.min(Math.ceil(a/m)*m,t)}function at(a,t){const[e,r]=it(a,t);return a.width===e&&a.height===r?a:S(a,e,r)}function it({width:a,height:t},{maxPreferredTexturePixels:e,maxTextureSize:r}){const i=Math.max(a,t),s=a*t;if(i<=r&&s<=e)return[a,t];const n=Math.min(Math.sqrt(e/s),r/i);return[M(Math.round(a*n),r),M(Math.round(t*n),r)]}function S(a,t,e){if(a instanceof ImageData)return S(st(a),t,e);const r=document.createElement("canvas");return r.width=t,r.height=e,r.getContext("2d").drawImage(a,0,0,r.width,r.height),r}function st(a){const t=document.createElement("canvas");t.width=a.width,t.height=a.height;const e=t.getContext("2d");if(e==null)throw new F("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return e.putImageData(a,0,0),t}class Mt{constructor(t,e){this._data=t,this.id=U(),this.events=new R,this._parameters={...ot,...e},this._startPreload(t)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(t){t instanceof HTMLVideoElement?(this.update=e=>this._update(t,e),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t)}_startPreloadVideoElement(t){if(!(y(t.src)||t.preload==="auto"&&t.crossOrigin)&&(t.preload="auto",t.crossOrigin="anonymous",t.src=t.src,t.paused&&t.autoplay)){const e=[];k(t,r=>e.push(r)).then(()=>{t.play()}).finally(()=>e.forEach(r=>r.remove()))}}_startPreloadImageElement(t){X(t.src)||y(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){const e=new j;return e.wrapMode=this._parameters.wrap??10497,e.flipped=!this._parameters.noUnpackFlip,e.samplingMode=this._parameters.mipmap?9987:9729,e.hasMipmap=!!this._parameters.mipmap,e.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,e.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),e.dataType=this._parameters.dataType??e.dataType,e.pixelFormat=this._parameters.pixelFormat??e.pixelFormat,e.internalFormat=this._parameters.internalFormat??e.internalFormat,e}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return this._glTexture!=null}get usedMemory(){return this._glTexture?.usedMemory||nt(this._data,this._parameters)}load(t){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const e=this._data;return e==null?(this._glTexture=new f(t,this._createDescriptor(t),null),this._glTexture):(this._emptyTexture=t.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof e=="string"?this._loadFromURL(t,e):e instanceof Image?this._loadFromImageElement(t,e):e instanceof HTMLVideoElement?this._loadFromVideoElement(t,e):e instanceof ImageData||e instanceof HTMLCanvasElement?this._loadFromImage(t,e):T(e)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(t,e):c(e)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(t,new Uint8Array(e)):(c(e)||T(e))&&this._parameters.encoding==="image/ktx2"?this._loadFromKTX2(t,e):(c(e)||T(e))&&this._parameters.encoding==="image/x.basis"?this._loadFromBasis(t,e):c(e)?this._loadFromPixelData(t,new Uint8Array(e)):$(e)?this._loadFromPixelData(t,e):null)}_update(t,e){return this._glTexture==null||t.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||e===t.currentTime?e:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,e){return this._glTexture=Y(t,this._createDescriptor(t),e),this._emptyTexture=null,this._glTexture}_loadFromKTX2(t,e){return this._loadAsync(()=>rt(t,this._createDescriptor(t),e).then(r=>(this._glTexture=r,r)))}_loadFromBasis(t,e){return this._loadAsync(()=>et(t,this._createDescriptor(t),e).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(t,e){Z(this._parameters.width>0&&this._parameters.height>0);const r=this._createDescriptor(t);return r.pixelFormat!==6407&&r.pixelFormat!==6408||(r.compress=this._parameters.compressionOptions),r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new f(t,r,e),this._glTexture}_loadFromURL(t,e){return this._loadAsync(async r=>{const i=await G(e,{signal:r});return E(r),this._loadFromImage(t,i)})}_loadFromImageElement(t,e){return e.complete?this._loadFromImage(t,e):this._loadAsync(async r=>{const i=await N(e,e.src,!1,r);return E(r),this._loadFromImage(t,i)})}_loadFromVideoElement(t,e){return e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(t,e):this._loadFromVideoElementAsync(t,e)}_loadFromVideoElementAsync(t,e){return this._loadAsync(r=>new Promise((i,s)=>{const n=()=>{e.removeEventListener("loadeddata",l),e.removeEventListener("error",d),O(x)},l=()=>{e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(n(),i(this._loadFromImage(t,e)))},d=p=>{n(),s(p||new F("texture:load-error","Failed to load video"))};e.addEventListener("loadeddata",l),e.addEventListener("error",d);const x=V(r,()=>d(b()))}))}_loadFromImage(t,e){let r=e;r instanceof HTMLVideoElement||(r=at(r,t.parameters));const i=L(r);this._parameters.width=i.width,this._parameters.height=i.height;const s=this._createDescriptor(t);return s.width=i.width,s.height=i.height,s.compress=this._parameters.compressionOptions,this._glTexture=new f(t,s,r),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(t){const e=new AbortController;this._loadingController=e;const r=t(e.signal);this._loadingPromise=r;const i=()=>{this._loadingController===e&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null),this._emptyTexture=null};return r.then(i,i),r}unload(){if(this._glTexture=B(this._glTexture),this._emptyTexture=null,this._loadingController!=null){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}}function nt(a,t){if(a==null)return 0;if(c(a)||T(a))return t.encoding==="image/ktx2"?tt(a,!!t.mipmap):t.encoding==="image/x.basis"?Q(a,!!t.mipmap):a.byteLength;const{width:e,height:r}=a instanceof Image||a instanceof ImageData||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?L(a):t,i=t.pixelFormat??6408,s=q(i);return(t.mipmap?4/3:1)*e*r*s||0}function L(a){return a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a}const ot={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};export{Mt as M,M as n,wt as r};
