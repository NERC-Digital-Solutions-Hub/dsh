import{H as S}from"./f3N8RNee.js";import{I as O,V as x}from"./CzvYEThE.js";import{v as g}from"./DOsAn7Yf.js";import{R as E}from"./C6RfGsvn.js";import{x as f}from"./DGk5f3jX.js";import{t as b}from"./DzwIWKe2.js";import{t as j}from"./Cge7XzSz.js";function p(e){const n={};for(const a in e){if(a==="declaredClass")continue;const i=e[a];if(i!=null&&typeof i!="function")if(Array.isArray(i)){n[a]=[];for(let t=0;t<i.length;t++)n[a][t]=p(i[t])}else typeof i=="object"?i.toJSON&&(n[a]=JSON.stringify(i)):n[a]=i}return n}const m="Layer does not support extent calculation.";function I(e,n){if(n&&e.type==="extent")return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(n&&e.type==="point")return`${e.x},${e.y}`;const a=e.toJSON();return delete a.spatialReference,JSON.stringify(a)}function R(e,n,a){const i=e.geometry,t=e.toJSON();delete t.compactGeometryEnabled,delete t.defaultSpatialReferenceEnabled;const r=t;let o,u,d;if(i&&(u=i.spatialReference,d=f(u),r.geometryType=g(i),r.geometry=I(i,e.compactGeometryEnabled),r.inSR=d),t.groupByFieldsForStatistics&&(r.groupByFieldsForStatistics=t.groupByFieldsForStatistics.join(",")),t.objectIds)switch(a?.uniqueIdFields?.length){case void 0:r.objectIds=t.objectIds.join(",");break;case 1:r.uniqueIds=JSON.stringify(t.objectIds),delete r.objectIds;break;default:r.uniqueIds=JSON.stringify(t.objectIds.map((s=>JSON.parse(s)))),delete r.objectIds}if(t.orderByFields&&(r.orderByFields=t.orderByFields.join(",")),!t.outFields||!t.returnDistinctValues&&(n?.returnCountOnly||n?.returnExtentOnly||n?.returnIdsOnly)?delete r.outFields:t.outFields.includes("*")?r.outFields="*":r.outFields=t.outFields.join(","),t.outSR?(r.outSR=f(t.outSR),o=e.outSpatialReference):i&&(t.returnGeometry||t.returnCentroid)&&(r.outSR=r.inSR,o=u),t.returnGeometry&&delete t.returnGeometry,t.outStatistics&&(r.outStatistics=JSON.stringify(t.outStatistics)),t.fullText&&(r.fullText=JSON.stringify(t.fullText)),t.pixelSize&&(r.pixelSize=JSON.stringify(t.pixelSize)),t.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&u!=null&&e.quantizationParameters?.extent!=null&&u.equals(e.quantizationParameters.extent.spatialReference)&&delete t.quantizationParameters.extent.spatialReference,r.quantizationParameters=JSON.stringify(t.quantizationParameters)),t.parameterValues&&(r.parameterValues=JSON.stringify(t.parameterValues)),t.rangeValues&&(r.rangeValues=JSON.stringify(t.rangeValues)),t.dynamicDataSource&&(r.layer=JSON.stringify({source:t.dynamicDataSource}),delete t.dynamicDataSource),t.timeExtent){const s=t.timeExtent,{start:l,end:y}=s;l==null&&y==null||(r.time=l===y?l:`${l??"null"},${y??"null"}`),delete t.timeExtent}return e.defaultSpatialReferenceEnabled&&u!=null&&o!=null&&u.equals(o)&&(r.defaultSR=r.inSR,delete r.inSR,delete r.outSR),r}async function v(e,n,a,i,t){const r=n.timeExtent?.isEmpty?{data:{features:[]}}:await c(e,n,"json",i,void 0,t);return j(n,a,r.data),r}async function B(e,n,a,i,t){if(n.timeExtent?.isEmpty)return{data:a.createFeatureResult()};const r=await q(e,n,i,t),o=r;return o.data=b(r.data,a),o}function q(e,n,a,i){return c(e,n,"pbf",a,void 0,i)}function C(e,n,a,i){return n.timeExtent?.isEmpty?Promise.resolve({data:{objectIds:[]}}):c(e,n,"json",a,{returnIdsOnly:!0},i)}function D(e,n,a,i){return n.timeExtent?.isEmpty?Promise.resolve({data:{count:0}}):c(e,n,"json",a,{returnIdsOnly:!0,returnCountOnly:!0},i)}async function G(e,n,a){if(n.timeExtent?.isEmpty)return{data:{count:0,extent:null}};const i=await c(e,n,"json",a,{returnExtentOnly:!0,returnCountOnly:!0}),t=i.data;if(t.hasOwnProperty("extent"))return i;if(t.features)throw new Error(m);if(t.hasOwnProperty("count"))throw new Error(m);return i}function F(e,n){if(!e.returnIdsOnly||!n.uniqueIdFields)return e;const a={...e,returnUniqueIdsOnly:!0};return delete a.returnIdsOnly,a}async function c(e,n,a,i={},t={},r={}){const o=typeof e=="string"?O(e):e,u=n.geometry?[n.geometry]:[],d=await E(u,null,{signal:i.signal}),s=d?.[0];s!=null&&((n=n.clone()).geometry=s);const l=p({...o.query,f:a,...F(t,r),...R(n,t,r)});return S(x(o.path,J(n,t)?"query3d":"query"),{...i,responseType:a==="pbf"?"array-buffer":"json",query:{...l,...i.query}})}function J(e,n){return e.formatOf3DObjects!=null&&!(n.returnCountOnly||n.returnExtentOnly||n.returnIdsOnly)}export{G as O,D as S,v as c,B as f,q as m,C as p,p as t};
