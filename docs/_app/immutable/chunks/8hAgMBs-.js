import j from"./B4_pDwsp.js";import{s as x,i as y}from"./DGjcIG0n.js";import{a as G,n as F}from"./Q08H8bVX.js";import{c as M}from"./BmSLGRn-.js";import{N as T,L as X,$ as Y}from"./BTWTCu7M.js";import{f as Z}from"./BhvNxPz5.js";import{A as L}from"./jom_tG0F.js";import{isFeatureIdentifierArrayWithGlobalId as v,isFeatureIdentifierArrayWithObjectId as D}from"./BjhIfhXi.js";async function J(a,e,s){const{geometry:r}=e,t={...e.attributes};if(s!=null&&r?.type==="mesh"){const{transformFieldRoles:o}=s,{origin:c,spatialReference:l,vertexSpace:p}=r,n=r.transform??new L,i=p.type==="local",u=a.spatialReference,h=u.isGeographic,$=G(u,l),w=T(l,u)&&X(l,u);if(!(i&&h&&w||!i&&!h&&$))return null;const m=Y(c,l,u);if(m==null)return null;if(t[o.originX]=m.x,t[o.originY]=m.y,t[o.originZ]=m.z??0,n!=null){const{translation:b,scale:I,rotation:f}=n,R=i?1:F(l)/F(u);t[o.translationX]=b[0]*R,t[o.translationY]=b[2]*R,t[o.translationZ]=-b[1]*R,t[o.scaleX]=I[0],t[o.scaleY]=I[2],t[o.scaleZ]=I[1],t[o.rotationX]=f[0],t[o.rotationY]=f[2],t[o.rotationZ]=-f[1],t[o.rotationDeg]=f[3]}return{attributes:t}}return r==null?{attributes:t}:r.type==="mesh"||r.type==="extent"?null:{geometry:r.toJSON(),attributes:t}}async function k(a,e){const s=await Promise.all((e.addAttachments??[]).map((o=>A(a,o)))),r=await Promise.all((e.updateAttachments??[]).map((o=>A(a,o)))),t=e.deleteAttachments??[];return s.length||r.length||t.length?{adds:s,updates:r,deletes:[...t]}:null}async function A(a,e){const{feature:s,attachment:r}=e,{globalId:t,name:o,contentType:c,data:l,uploadId:p}=r,n={globalId:t};if(s&&("attributes"in s?n.parentGlobalId=s.attributes?.[a.globalIdField]:s.globalId&&(n.parentGlobalId=s.globalId)),p)n.uploadId=p;else if(l){const i=await M(l);i&&(n.contentType=i.mediaType,n.data=i.data),l instanceof File&&(n.name=l.name)}return o&&(n.name=o),c&&(n.contentType=c),n}function q(a,e,s){if(!e||e.length===0)return[];if(s&&v(e))return e.map((t=>t.globalId));if(D(e))return e.map((t=>t.objectId));const r=s?a.globalIdField:a.objectIdField;return r?e.map((t=>t.getAttribute(r))):[]}function B(a){const e=a?.assetMaps;if(e){for(const t of e.addResults)t.success||y.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${t.globalId}.`);for(const t of e.updateResults)t.success||y.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${t.globalId}.`)}const s=a?.attachments,r={addFeatureResults:a?.addResults?.map(d)??[],updateFeatureResults:a?.updateResults?.map(d)??[],deleteFeatureResults:a?.deleteResults?.map(d)??[],addAttachmentResults:s?.addResults?s.addResults.map(d):[],updateAttachmentResults:s?.updateResults?s.updateResults.map(d):[],deleteAttachmentResults:s?.deleteResults?s.deleteResults.map(d):[]};return a?.editMoment&&(r.editMoment=a.editMoment),r}function d(a){const e=a.success===!0?null:a.error||{code:void 0,description:"Feature edit failed"};return{objectId:a.objectId,globalId:a.globalId,error:e?new x("feature-layer-source:edit-failure",e.description,{code:e.code}):null}}function g(a,e){return new j({attributes:a.attributes,geometry:Z({...a.geometry,spatialReference:e})})}function E(a,e){return{adds:a?.adds?.map((s=>g(s,e)))||[],updates:a?.updates?.map((s=>({original:g(s[0],e),current:g(s[1],e)})))||[],deletes:a?.deletes?.map((s=>g(s,e)))||[],spatialReference:e}}function H(a){const e=a.details.raw,s=+e.code,r=+e.extendedCode;return s===500&&(r===-2147217144||r===-2147467261)}export{E as I,d as R,q as b,k as f,H as j,J as m,B as y};
