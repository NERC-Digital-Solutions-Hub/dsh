import{i as y,s as u}from"./CaNW5Bx0.js";import{b as v,K as U}from"./CEBETtrS.js";import{at as z,c as O,d as K}from"./BW0zoJTm.js";import{Y as g,E as n,G as F,T as D,N as P,S as V,O as G}from"./DQOO6RKE.js";const Y=()=>y.getLogger("esri.views.webgl.checkWebGLError");function L(i){switch(i.getError()){case i.NO_ERROR:return null;case i.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case i.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case i.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case i.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case i.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case i.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const X=!!v("enable-feature:webgl-debug");function W(){return X}function ne(){return X}function R(i,e=W()){if(e){const t=L(i);if(t){const s=new Error().stack;Y().error(new u("webgl-error","WebGL error occurred",{message:t,stack:s}))}}}function ce(i,e,t,s=0){const r=i.gl;i.bindBuffer(t);for(const a of t.layout){const c=e.get(a.name);if(c==null){console.warn(`There is no location for vertex attribute '${a.name}' defined.`);continue}const l=s*a.stride;if(a.count<=4)r.vertexAttribPointer(c,a.count,a.type,a.normalized,a.stride,a.offset+l),r.enableVertexAttribArray(c),a.divisor>0&&r.vertexAttribDivisor(c,a.divisor);else if(a.count===9)for(let o=0;o<3;o++)r.vertexAttribPointer(c+o,3,a.type,a.normalized,a.stride,a.offset+12*o+l),r.enableVertexAttribArray(c+o),a.divisor>0&&r.vertexAttribDivisor(c+o,a.divisor);else if(a.count===16)for(let o=0;o<4;o++)r.vertexAttribPointer(c+o,4,a.type,a.normalized,a.stride,a.offset+16*o+l),r.enableVertexAttribArray(c+o),a.divisor>0&&r.vertexAttribDivisor(c+o,a.divisor);else console.error("Unsupported vertex attribute element count: "+a.count);if(W()){const o=L(i.gl);o&&console.error(`Unable to bind vertex attribute "${a.name}" with baseInstanceOffset ${l}:`,o,a)}}}function le(i){switch(i){case 6406:case 6409:case 6403:case 36244:case 6402:case 34041:return 1;case 6410:case 33319:case 33320:return 2;case 6407:case 36248:return 3;case 6408:case 36249:return 4}return 0}function j(i){switch(i){case 6406:case 6409:case 6403:case 36244:case n.R8:case n.R8I:case n.R8UI:case n.R8_SNORM:case 36168:return 1;case 6410:case 33319:case 33320:case n.RGBA4:case n.R16F:case n.R16I:case n.R16UI:case n.RG8:case n.RG8I:case n.RG8UI:case n.RG8_SNORM:case n.RGB565:case n.RGB5_A1:case D.DEPTH_COMPONENT16:return 2;case 6407:case 36248:case n.RGB8:case n.RGB8I:case n.RGB8UI:case n.RGB8_SNORM:case n.SRGB8:case D.DEPTH_COMPONENT24:return 3;case 6408:case 36249:case n.RGBA8:case n.R32F:case n.R11F_G11F_B10F:case n.RG16F:case n.R32I:case n.R32UI:case n.RG16I:case n.RG16UI:case n.RGBA8I:case n.RGBA8UI:case n.RGBA8_SNORM:case n.SRGB8_ALPHA8:case n.RGB9_E5:case n.RGB10_A2UI:case n.RGB10_A2:case D.DEPTH_COMPONENT32F:case F.DEPTH24_STENCIL8:return 4;case F.DEPTH32F_STENCIL8:return 5;case n.RGB16F:case n.RGB16I:case n.RGB16UI:return 6;case n.RG32F:case n.RG32I:case n.RG32UI:case n.RGBA16F:case n.RGBA16I:case n.RGBA16UI:return 8;case n.RGB32F:case n.RGB32I:case n.RGB32UI:return 12;case n.RGBA32F:case n.RGBA32I:case n.RGBA32UI:return 16;case g.COMPRESSED_RGB_S3TC_DXT1_EXT:case g.COMPRESSED_RGBA_S3TC_DXT1_EXT:return .5;case g.COMPRESSED_RGBA_S3TC_DXT3_EXT:case g.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case g.COMPRESSED_R11_EAC:case g.COMPRESSED_SIGNED_R11_EAC:case g.COMPRESSED_RGB8_ETC2:case g.COMPRESSED_SRGB8_ETC2:case g.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case g.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return .5;case g.COMPRESSED_RG11_EAC:case g.COMPRESSED_SIGNED_RG11_EAC:case g.COMPRESSED_RGBA8_ETC2_EAC:case g.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0}let q=class{constructor(e=0,t=e){this.width=e,this.height=t,this.type=0,this.target=3553,this.pixelFormat=6408,this.dataType=P.UNSIGNED_BYTE,this.samplingMode=9729,this.wrapMode=10497,this.maxAnisotropy=1,this.flipped=!1,this.hasMipmap=!1,this.isOpaque=!1,this.unpackAlignment=4,this.preMultiplyAlpha=!1,this.compareEnabled=!1,this.linearFilterDepth=!1,this.depth=1,this.isImmutable=!1}};function J(i){return i.width<=0||i.height<=0||i.depth<=0?0:Math.round(i.width*i.height*i.depth*(i.hasMipmap?4/3:1)*(i.internalFormat==null?4:j(i.internalFormat))*(i.target===34067?6:1))}const A=()=>y.getLogger("esri/views/webgl/textureUtils");function w(i){const{width:e,height:t,depth:s}=i;(e!=null&&e<0||t!=null&&t<0||s!=null&&s<0)&&A().error("Negative dimension parameters are not allowed!");const{internalFormat:r}=i;if(r&&(H(r)||$(r))){const{linearFilterDepth:a,compareEnabled:c,samplingMode:l,hasMipmap:o}=i;o&&A().error("Depth textures cannot have mipmaps"),a?l!==9729&&l!==9728&&A().error("Depth textures cannot sample mipmaps"):(l!==9728&&A().error("Depth textures without filtering must use NEAREST filtering"),c&&A().error("Depth textures without filtering cannot use compare function"))}}function Q(i){return V.includes(i)}function H(i){return U(D,i)}function $(i){return U(F,i)}function Z(i){return i!=null&&U(g,i)}function b(i){return i!=null&&"type"in i&&i.type==="compressed"}function ee(i){return i!=null&&"byteLength"in i}function N(i){return i!=null&&!b(i)&&!ee(i)}function M(i){return i===32879||i===35866}function B(i,e,t,s=1){let r=Math.max(e,t);return i===32879&&(r=Math.max(r,s)),Math.floor(Math.log2(r))+1}function S(i){if(i.internalFormat!=null)return i.internalFormat;switch(i.dataType){case P.FLOAT:switch(i.pixelFormat){case 6408:return n.RGBA32F;case 6407:return n.RGB32F;default:throw new u("texture:unknown-format","Unable to derive format")}case P.UNSIGNED_BYTE:switch(i.pixelFormat){case 6408:return n.RGBA8;case 6407:return n.RGB8}}const{pixelFormat:e}=i;return i.internalFormat=e===34041?F.DEPTH24_STENCIL8:e===6402?D.DEPTH_COMPONENT24:e,i.internalFormat}function te(i){let e="width"in i?i.width:i.codedWidth,t="height"in i?i.height:i.codedHeight;return i instanceof HTMLVideoElement&&(e=i.videoWidth,t=i.videoHeight),{width:e,height:t,depth:1}}class C extends q{constructor(e,t){switch(super(),this.context=e,Object.assign(this,t),this.internalFormat){case n.R16F:case n.R32F:case n.R8_SNORM:case n.R8:this.pixelFormat=6403;break;case n.R8I:case n.R8UI:case n.R16I:case n.R16UI:case n.R32I:case n.R32UI:this.pixelFormat=36244}}static validate(e,t){return new C(e,t)}}const re=!!v("esri-tests-disable-gpu-memory-measurements"),E=()=>y.getLogger("esri/views/webgl/Texture");var p;let pe=(p=class{constructor(e,t=null,s=null){if(this.type=1,this._glName=null,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._shadowFilterDirty=!1,this._wasImmutablyAllocated=!1,"context"in e)this._descriptor=e,s=t;else{const r=C.validate(e,t);if(!r)throw new u("texture:invalid-descriptor","Texture descriptor invalid");this._descriptor=r}this._descriptor.target===34067?this._setDataCubeMap(s):this.setData(s)}get glName(){return this._glName}get descriptor(){return this._descriptor}get usedMemory(){return re?0:J(this._descriptor)}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty||this._shadowFilterDirty}get hasWebGLTextureObject(){return!!this._glName}dispose(){this.abortCompression(),this.hasWebGLTextureObject&&this._descriptor.context?.gl&&(this._descriptor.context.instanceCounter.decrement(G.Texture,this),this._descriptor.context.unbindTexture(this),this._descriptor.context.gl.deleteTexture(this._glName),this._glName=null,this._descriptor=null)}release(){this.dispose()}[Symbol.dispose](){this.dispose()}resize(e,t){const s=this._descriptor;if(s.width!==e||s.height!==t){if(this._wasImmutablyAllocated)throw new u("texture:immutable-resize","Immutable textures can't be resized!");s.width=e,s.height=t,this._descriptor.target===34067?this._setDataCubeMap(null):this.setData(null)}}enableCompression(e){this._descriptor.compress=e}disableCompression(){this._descriptor.compress=void 0}setData(e){this.abortCompression(),!b(e)&&this._descriptor.internalFormat&&U(g,this._descriptor.internalFormat)&&(this._descriptor.internalFormat=void 0),this._setData(e),!b(e)&&this._descriptor.compress&&this._compressOnWorker(e)}updateData(e,t,s,r,a,c,l=0){c||E().error("An attempt to use uninitialized data!"),this.hasWebGLTextureObject||E().error("An attempt to update uninitialized texture!");const o=this._descriptor;o.internalFormat=S(o);const{context:h,pixelFormat:m,dataType:x,target:d,isImmutable:_}=o;if(_&&!this._wasImmutablyAllocated)throw new u("texture:uninitialized","Cannot update immutable texture before allocation!");const f=h.bindTexture(this,p.TEXTURE_UNIT_FOR_UPDATES,!0);(t<0||s<0||t+r>o.width||s+a>o.height)&&E().error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage();const{gl:T}=h;l&&(r&&a||E().warn("Must pass width and height if `UNPACK_SKIP_ROWS` is used"),T.pixelStorei(T.UNPACK_SKIP_ROWS,l)),N(c)?T.texSubImage2D(d,e,t,s,r,a,m,x,c):b(c)?T.compressedTexSubImage2D(d,e,t,s,r,a,o.internalFormat,c.levels[e]):T.texSubImage2D(d,e,t,s,r,a,m,x,c),l&&T.pixelStorei(T.UNPACK_SKIP_ROWS,0),h.bindTexture(f,p.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(e,t,s,r,a,c,l,o){o||E().error("An attempt to use uninitialized data!"),this.hasWebGLTextureObject||E().error("An attempt to update an uninitialized texture!");const h=this._descriptor;h.internalFormat=S(h);const{context:m,pixelFormat:x,dataType:d,isImmutable:_,target:f}=h;if(_&&!this._wasImmutablyAllocated)throw new u("texture:uninitialized","Cannot update immutable texture before allocation!");M(f)||E().warn("Attempting to set 3D texture data on a non-3D texture");const T=m.bindTexture(this,p.TEXTURE_UNIT_FOR_UPDATES);m.setActiveTexture(p.TEXTURE_UNIT_FOR_UPDATES),(t<0||s<0||r<0||t+a>h.width||s+c>h.height||r+l>h.depth)&&E().error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage();const{gl:I}=m;if(b(o))o=o.levels[e],I.compressedTexSubImage3D(f,e,t,s,r,a,c,l,h.internalFormat,o);else{const k=o;I.texSubImage3D(f,e,t,s,r,a,c,l,x,d,k)}m.bindTexture(T,p.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const e=this._descriptor;if(e.width===0||e.height===0)return;if(!e.hasMipmap){if(this._wasImmutablyAllocated)throw new u("texture:immutable-change","Cannot add mipmaps to immutable texture after allocation");e.hasMipmap=!0,this._samplingModeDirty=!0,w(e)}e.samplingMode===9729?(this._samplingModeDirty=!0,e.samplingMode=9985):e.samplingMode===9728&&(this._samplingModeDirty=!0,e.samplingMode=9984);const t=this._descriptor.context.bindTexture(this,p.TEXTURE_UNIT_FOR_UPDATES);this._descriptor.context.setActiveTexture(p.TEXTURE_UNIT_FOR_UPDATES),this._descriptor.context.gl.generateMipmap(e.target),this._descriptor.context.bindTexture(t,p.TEXTURE_UNIT_FOR_UPDATES)}clearMipmap(){const e=this._descriptor;if(e.hasMipmap){if(this._wasImmutablyAllocated)throw new u("texture:immutable-change","Cannot delete mipmaps to immutable texture after allocation");e.hasMipmap=!1,this._samplingModeDirty=!0,w(e)}e.samplingMode===9985?(this._samplingModeDirty=!0,e.samplingMode=9729):e.samplingMode===9984&&(this._samplingModeDirty=!0,e.samplingMode=9728)}setSamplingMode(e){e!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=e,this._samplingModeDirty=!0)}setWrapMode(e){e!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=e,w(this._descriptor),this._wrapModeDirty=!0)}setShadowFiltering(e){e!==this._descriptor.linearFilterDepth&&(this._descriptor.linearFilterDepth=this._descriptor.compareEnabled=e,this.setSamplingMode(e?9729:9728),w(this._descriptor),this._shadowFilterDirty=!0)}applyChanges(){this._samplingModeDirty&&(this._applySamplingMode(),this._samplingModeDirty=!1),this._wrapModeDirty&&(this._applyWrapMode(),this._wrapModeDirty=!1),this._shadowFilterDirty&&(this._applyShadowMode(),this._shadowFilterDirty=!1)}abortCompression(){this._compressionAbortController=z(this._compressionAbortController)}_setData(e,t){const s=this._descriptor,r=s.context?.gl;if(!r)return;R(r),this.hasWebGLTextureObject||(this._glName=r.createTexture(),s.context.instanceCounter.increment(G.Texture,this)),w(s);const a=s.context.bindTexture(this,p.TEXTURE_UNIT_FOR_UPDATES);s.context.setActiveTexture(p.TEXTURE_UNIT_FOR_UPDATES),this._configurePixelStorage(),R(r);const c=t??s.target,l=M(c);if(N(e))this._setDataFromTexImageSource(e,c);else{const{width:o,height:h,depth:m}=s;if(o==null||h==null)throw new u("texture:missing-size","Width and height must be specified!");if(l&&m==null)throw new u("texture:missing-depth","Depth must be specified!");if(s.internalFormat=S(s),s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(c,s.internalFormat,s.hasMipmap,o,h,m),b(e)){if(!Z(s.internalFormat))throw new u("texture:format-mismatch","Attempting to use compressed data with an uncompressed format!");this._setDataFromCompressedSource(e,s.internalFormat,c)}else this._texImage(c,0,s.internalFormat,o,h,m,e),R(r),s.hasMipmap&&this.generateMipmap()}this._applySamplingMode(),this._applyWrapMode(),this._applyAnisotropicFilteringParameters(),this._applyShadowMode(),R(r),s.context.bindTexture(a,p.TEXTURE_UNIT_FOR_UPDATES)}_setDataCubeMap(e=null){for(let t=34069;t<=34074;t++)this._setData(e,t)}_configurePixelStorage(){const e=this._descriptor.context.gl,{unpackAlignment:t,flipped:s,preMultiplyAlpha:r}=this._descriptor;e.pixelStorei(e.UNPACK_ALIGNMENT,t),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s?1:0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r?1:0)}_setDataFromTexImageSource(e,t){const{gl:s}=this._descriptor.context,r=this._descriptor;r.internalFormat=S(r);const a=M(t),{width:c,height:l,depth:o}=te(e);r.width&&r.height,r.width||(r.width=c),r.height||(r.height=l),a&&r.depth,a&&(r.depth=o),r.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(t,r.internalFormat,r.hasMipmap,c,l,o),this._texImage(t,0,r.internalFormat,c,l,o,e),R(s),r.hasMipmap&&(this.generateMipmap(),R(s))}_setDataFromCompressedSource(e,t,s){const r=this._descriptor,{width:a,height:c,depth:l}=r,o=e.levels,h=B(s,a,c,l),m=Math.min(h,o.length)-1;this._descriptor.context.gl.texParameteri(r.target,33085,m),this._forEachMipmapLevel((x,d,_,f)=>{const T=o[Math.min(x,o.length-1)];this._compressedTexImage(s,x,t,d,_,f,T)},m)}_texStorage(e,t,s,r,a,c){const{gl:l}=this._descriptor.context;if(!Q(t)&&!H(t)&&!$(t))throw new u("texture:missing-format","Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const o=s?B(e,r,a,c):1;if(M(e)){if(c==null)throw new u("texture:missing-depth","Missing depth dimension for 3D texture upload");l.texStorage3D(e,o,t,r,a,c)}else l.texStorage2D(e,o,t,r,a);this._wasImmutablyAllocated=!0}_texImage(e,t,s,r,a,c,l){const o=this._descriptor.context.gl,h=M(e),{isImmutable:m,pixelFormat:x,dataType:d}=this._descriptor;if(m){if(l!=null){const _=l;if(h){if(c==null)throw new u("texture:missing-depth","Missing depth dimension for 3D texture upload");o.texSubImage3D(e,t,0,0,0,r,a,c,x,d,_)}else o.texSubImage2D(e,t,0,0,r,a,x,d,_)}}else{const _=l;if(h){if(c==null)throw new u("texture:missing-depth","Missing depth dimension for 3D texture upload");o.texImage3D(e,t,s,r,a,c,0,x,d,_)}else o.texImage2D(e,t,s,r,a,0,x,d,_)}}_compressedTexImage(e,t,s,r,a,c,l){const o=this._descriptor.context.gl,h=M(e);if(this._descriptor.isImmutable){if(l!=null)if(h){if(c==null)throw new u("texture:missing-depth","Missing depth dimension for 3D texture upload");o.compressedTexSubImage3D(e,t,0,0,0,r,a,c,s,l)}else o.compressedTexSubImage2D(e,t,0,0,r,a,s,l)}else if(h){if(c==null)throw new u("texture:missing-depth","Missing depth dimension for 3D texture upload");o.compressedTexImage3D(e,t,s,r,a,c,0,l)}else o.compressedTexImage2D(e,t,s,r,a,0,l)}async _compressOnWorker(e){const{width:t,height:s,context:r,flipped:a,preMultiplyAlpha:c,hasMipmap:l}=this._descriptor,o=this._descriptor.compress?.compressionTracker,h=this._descriptor.compress?.compressionCallback,{compressedTextureETC:m,compressedTextureS3TC:x}=r.capabilities;if(!p.compressionWorkerHandle?.isCompressible(e,this._descriptor)||!m&&!x)return;this.abortCompression();const d=new AbortController;let _;this._compressionAbortController=d,o?.increment();try{e instanceof Uint8Array?_=e.buffer:(_=await createImageBitmap(e,{imageOrientation:a?"flipY":"none"}),O(d));const f={data:_,width:t,height:s,needsFlip:e instanceof Uint8Array&&this.descriptor.flipped,components:this._descriptor.pixelFormat===6408?4:3,preMultiplyAlpha:c,hasMipmap:l,hasETC:!!m,hasS3TC:!!x},T=await p.compressionWorkerHandle.invoke(f,d.signal,"low");if(O(d),T.compressedTexture&&this.hasWebGLTextureObject){const I=this.usedMemory;this._descriptor.internalFormat=T.internalFormat,this._setData(T.compressedTexture),h?.(I-this.usedMemory)}}catch(f){K(f)||E().error("Texture compression failed!")}finally{o?.decrement(),this._compressionAbortController?.signal.aborted&&(this._compressionAbortController=null),_ instanceof ImageBitmap&&_.close()}}_forEachMipmapLevel(e,t=1/0){let{width:s,height:r,depth:a,hasMipmap:c,target:l}=this._descriptor;const o=l===32879;if(s==null||r==null||o&&a==null)throw new u("texture:missing-size","Missing texture dimensions for mipmap calculation");for(let h=0;e(h,s,r,a),c&&(s!==1||r!==1||o&&a!==1)&&!(h>=t);++h)s=Math.max(1,s>>1),r=Math.max(1,r>>1),o&&(a=Math.max(1,a>>1))}_applySamplingMode(){const e=this._descriptor,t=e.context?.gl;let s=e.samplingMode,r=e.samplingMode;s===9985||s===9987?(s=9729,e.hasMipmap||(r=9729)):s!==9984&&s!==9986||(s=9728,e.hasMipmap||(r=9728)),t.texParameteri(e.target,t.TEXTURE_MAG_FILTER,s),t.texParameteri(e.target,t.TEXTURE_MIN_FILTER,r)}_applyWrapMode(){const e=this._descriptor,t=e.context?.gl;typeof e.wrapMode=="number"?(t.texParameteri(e.target,t.TEXTURE_WRAP_S,e.wrapMode),t.texParameteri(e.target,t.TEXTURE_WRAP_T,e.wrapMode)):(t.texParameteri(e.target,t.TEXTURE_WRAP_S,e.wrapMode.s),t.texParameteri(e.target,t.TEXTURE_WRAP_T,e.wrapMode.t))}_applyShadowMode(){const e=this._descriptor,t=e.context?.gl,s=e.compareEnabled?t.COMPARE_REF_TO_TEXTURE:t.NONE;t.texParameteri(e.target,t.TEXTURE_COMPARE_MODE,s),e.compareEnabled&&t.texParameteri(e.target,t.TEXTURE_COMPARE_FUNC,t.GREATER),R(t)}_applyAnisotropicFilteringParameters(){const e=this._descriptor,t=e.context.capabilities.textureFilterAnisotropic;t&&e.context.gl.texParameterf(e.target,t.TEXTURE_MAX_ANISOTROPY,e.maxAnisotropy??1)}},p.TEXTURE_UNIT_FOR_UPDATES=0,p.compressionWorkerHandle=null,p);export{pe as A,ce as R,j as _,W as a,C as b,ne as c,q as h,le as n,L as t,R as u};
