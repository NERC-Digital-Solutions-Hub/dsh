import{u as g,e as m}from"./aQeO9QTD.js";import{t as b}from"./DwqrsEzQ.js";import{CIMSymbolRasterizer as L}from"./BXMBYno9.js";import{v as R}from"./CqGmR_uN.js";import{z as C}from"./DOAJfpyz.js";import{l as q,t as M}from"./bexxTcmF.js";const d=new L(null),u=m(M.size),x=m(M.maxSize),S=m(M.lineWidth),D=1;async function E(a,e,r){const l=e?.size;let t=l!=null&&typeof l=="object"&&"width"in l?l.width:l,n=l!=null&&typeof l=="object"&&"height"in l?l.height:l;if(!t||!n)if(r==="esriGeometryPolygon")t=n=e.maxSize?Math.min(e.maxSize,u):u;else{const s=await T(a,e,r);s&&(t=s.width,n=s.height),r==="esriGeometryPolyline"&&(t=e.maxSize?Math.min(e.maxSize,S):S),t=t!=null&&isFinite(t)?Math.min(t,x):u,n=n!=null&&isFinite(n)?Math.max(Math.min(n,x),D):u}return e.style==="legend"&&r==="esriGeometryPolyline"&&(t=S),{width:t,height:n}}async function T(a,e={},r){const l=e.cimOptions||e;r??=l.geometryType||C(a?.data?.symbol);const{feature:t,fieldMap:n,viewParams:s}=l,o=await R.resolveSymbolOverrides(a.data,t,null,n,r,null,s);if(!o)return null;(a=a.clone()).data={type:"CIMSymbolReference",symbol:o},a.data.primitiveOverrides=void 0;const i=[];return b.fetchResources(o,d.resourceManager,i),b.fetchFonts(o,d.resourceManager,i),i.length>0&&await Promise.all(i),b.getEnvelope(o,null,d.resourceManager)}async function W(a,e={}){const{node:r,opacity:l,symbolConfig:t}=e,n=t!=null&&typeof t=="object"&&"isSquareFill"in t&&t.isSquareFill,s=e.cimOptions||e,o=s.geometryType||C(a?.data?.symbol),i=await E(a,e,o),{feature:I,fieldMap:G}=s,$=e?.geometry||n||o!=="esriGeometryPolygon"?"preview":"legend";let v=i;const z=i;if(e?.geometry&&(o==="esriGeometryPolygon"||o==="esriGeometryPolyline")&&(g(i.width)<200||g(i.height)<200)){const j=i.width>i.height?m(200)*i.height/i.width:m(200);v={width:i.width>i.height?m(200):m(200)*i.width/i.height,height:j}}const f=await d.rasterizeCIMSymbolAsync(a,I,v,$,G,o,null,s.viewParams,s.allowScalingUp,e?.geometry?.toJSON());if(!f)return null;const{width:F,height:O}=f,c=document.createElement("canvas");c.width=F,c.height=O,c.getContext("2d").putImageData(f,0,0);const p=g(z.width),w=g(z.height),h=new Image(p,w);h.src=c.toDataURL(),h.ariaLabel=e.ariaLabel??null,h.alt=e.ariaLabel??"",l!=null&&(h.style.opacity=`${l}`);let y=h;if(e.effectView!=null){const P={shape:{type:"image",x:0,y:0,width:p,height:w,src:h.src},fill:null,stroke:null,offset:[0,0]};y=q([[P]],[p,w],e)}return r&&y&&r.appendChild(y),y}export{T as getCIMSymbolPreviewSize,W as previewCIMSymbol};
