import"./DsnmJJEf.js";import{a8 as u,aH as H,ah as M,t as d,a7 as h,aI as v,c as I,r as g,a5 as _,a9 as b,aJ as j,u as A}from"./kZbt_Riz.js";import{f as F,a as V,d as k}from"./CcHDQE4Y.js";import{s as x}from"./u2O093Vk.js";import{i as N}from"./P_mD4-LL.js";import{S as z}from"./BKAB22oD.js";import"./DwWpeHsS.js";import"./bnayRBMH.js";import"./CEhj4l8G.js";import"./D_bKRBrk.js";import"./CbKIfN8e.js";import"./BV8-ngCo.js";import{S as y}from"./BAauABG3.js";var C=["forEach","isDisjointFrom","isSubsetOf","isSupersetOf"],E=["difference","intersection","symmetricDifference","union"],L=!1;class S extends Set{#e=new Map;#t=u(0);#r=u(0);#i=H||-1;constructor(e){if(super(),e){for(var t of e)super.add(t);this.#r.v=super.size}L||this.#s()}#a(e){return H===this.#i?u(e):M(e)}#s(){L=!0;var e=S.prototype,t=Set.prototype;for(const i of C)e[i]=function(...r){return d(this.#t),t[i].apply(this,r)};for(const i of E)e[i]=function(...r){d(this.#t);var a=t[i].apply(this,r);return new S(a)}}has(e){var t=super.has(e),i=this.#e,r=i.get(e);if(r===void 0){if(!t)return d(this.#t),!1;r=this.#a(!0),i.set(e,r)}return d(r),t}add(e){return super.has(e)||(super.add(e),h(this.#r,super.size),v(this.#t)),this}delete(e){var t=super.delete(e),i=this.#e,r=i.get(e);return r!==void 0&&(i.delete(e),h(r,!1)),t&&(h(this.#r,super.size),v(this.#t)),t}clear(){if(super.size!==0){super.clear();var e=this.#e;for(var t of e.values())h(t,!1);e.clear(),h(this.#r,0),v(this.#t)}}keys(){return this.values()}values(){return d(this.#t),super.values()}entries(){return d(this.#t),super.entries()}[Symbol.iterator](){return this.keys()}get size(){return d(this.#r)}}var O=F('<div class="min-w-0 space-y-2 overflow-hidden"><!></div>'),P=F('<div class="w-full flex-1 overflow-hidden pr-1.5 pl-1.5"><!></div>');function Y(w,e){var t=P(),i=I(t);z(i,{class:"h-full w-full",children:(r,a)=>{var n=O(),o=I(n);{var l=c=>{var s=k(),f=_(s);x(f,()=>e.children),V(c,s)};N(o,c=>{e.children&&c(l)})}g(n),V(r,n)},$$slots:{default:!0}}),g(t),V(w,t)}class Z{#e;constructor(e){this.#e=e}async getLayerView(e){return this.#e.whenLayerView(e)}async getLayerViewById(e){const t=this.#e.map?.findLayerById(e);if(t)return this.getLayerView(t)}}class ee{areaSelectionStore;layerViewProvider;#e=u(b({layerView:null,areaHandles:new y}));get selectionViewState(){return d(this.#e)}set selectionViewState(e){h(this.#e,e,!0)}#t=u(null);get lastAddedArea(){return d(this.#t)}set lastAddedArea(e){h(this.#t,e,!0)}#r=u(null);get lastRemovedArea(){return d(this.#r)}set lastRemovedArea(e){h(this.#r,e,!0)}#i=u(null);get currentHoveredArea(){return d(this.#i)}set currentHoveredArea(e){h(this.#i,e,!0)}fieldInfos=[];cachedNames=new y;constructor(e,t){this.areaSelectionStore=e,this.layerViewProvider=t,j(()=>{A(()=>{this.refreshLayerView()}),A(()=>{this.refreshAreas()})})}async refreshLayerView(){if(!this.areaSelectionStore.layerId&&this.selectionViewState.layerView!==null){this.resetSelectedLayerView();return}if(this.selectionViewState.layerView?.layer?.id===this.areaSelectionStore.layerId||!this.areaSelectionStore.layerId)return;const e=await this.layerViewProvider.getLayerViewById(this.areaSelectionStore.layerId);e&&this.setSelectedLayerView(e)}async refreshAreas(){const e=this.selectionViewState.layerView;if(!e){this.resetSelectedAreas();return}const t=this.areaSelectionStore.selectedAreaIds,i=this.selectionViewState.areaHandles;for(const r of i.keys())t.has(r)||this.removeSelectedArea(r);for(const r of t){if(i.has(r))continue;const a=e.highlight(r,{name:"selected"});a&&this.addSelectedArea(r,a)}}setFieldInfos(e){this.fieldInfos=e}setSelectedLayerView(e){this.selectionViewState?.layerView!==e&&(this.selectionViewState={layerView:e,areaHandles:new y},this.resetSelectedAreas())}clearSelectedLayerView(){this.selectionViewState.layerView!==null&&(this.resetSelectedAreas(),this.selectionViewState.layerView=null)}resetSelectedLayerView(){this.selectionViewState={layerView:null,areaHandles:new y},this.resetSelectedAreas()}resetSelectedAreas(){!this.selectionViewState.layerView&&this.selectionViewState.areaHandles.size===0||(this.selectionViewState.areaHandles.values().forEach(e=>{e.remove()}),this.selectionViewState.areaHandles.clear(),this.lastAddedArea=null,this.lastRemovedArea=null,this.currentHoveredArea=null)}addSelectedArea(e,t){if(!this.selectionViewState){console.warn("SelectedAreasStore: No feature layer view is set.");return}const i={id:e,handle:t};this.lastAddedArea=i,this.selectionViewState.areaHandles.set(e,t),this.areaSelectionStore.addSelectedArea(e)}removeSelectedArea(e){if(!this.selectionViewState){console.warn("[area-selection-interaction-store] no feature layer view is set.");return}const t=this.selectionViewState.areaHandles.get(e);if(!t){console.warn(`[area-selection-interaction-store] no handle found for area ID ${e}.`);return}this.lastRemovedArea={id:e,handle:t},t.remove(),this.selectionViewState.areaHandles.delete(e),this.areaSelectionStore.removeSelectedArea(e)}async getAreaNamesById(e){if(!this.selectionViewState?.layerView)return[];const t=this.getNameFieldForCurrentLayer();if(!t)return[];const i=this.selectionViewState.layerView.layer;let r=this.cachedNames.get(i.uid);r||(r=new y,this.cachedNames.set(i.uid,r));const a=new Array(e.length),n=new y,o=[];if(e.forEach((s,f)=>{n.set(s,f);const p=r.get(s);p!==void 0?a[f]=p:o.push(s)}),o.length===0)return a.map(s=>s??"");const l=i.objectIdField,c=await i.queryFeatures({objectIds:o,outFields:[t,l],returnGeometry:!1});for(const s of c.features){const f=s.attributes[l],p=s.attributes[t],m=n.get(f);m!==void 0&&(a[m]=p??"",r.set(f,p??""))}return a.map(s=>s??"")}async getAreaCodesById(e){if(!this.selectionViewState?.layerView)return[];const t=this.getCodeFieldForCurrentLayer();if(!t)return[];const i=this.selectionViewState.layerView.layer,r=i.objectIdField,a=await i.queryFeatures({objectIds:e,outFields:[t,r],returnGeometry:!1}),n=new Array(e.length);for(const o of a.features){const l=o.attributes[r],c=o.attributes[t],s=e.indexOf(l);s!==-1&&(n[s]=c??"")}return n.map(o=>o??"")}setHoveredArea(e,t){e!==this.currentHoveredArea?.id&&(this.currentHoveredArea&&this.clearHoveredArea(),this.currentHoveredArea={id:e,handle:t})}clearHoveredArea(){this.currentHoveredArea&&(this.currentHoveredArea?.handle.remove(),this.currentHoveredArea=null)}getNameFieldForCurrentLayer(){if(!this.selectionViewState||!this.selectionViewState.layerView||!this.selectionViewState.layerView.layer)return null;const e=this.fieldInfos.find(t=>t.layerName===this.selectionViewState?.layerView?.layer?.title)?.nameField;return e||(console.warn(`[area-selection-interaction-store] no name field configured for layer ${this.selectionViewState.layerView.layer.title}`,this.fieldInfos),null)}getCodeFieldForCurrentLayer(){if(!this.selectionViewState||!this.selectionViewState.layerView||!this.selectionViewState.layerView.layer)return null;const e=this.fieldInfos.find(t=>t.layerName===this.selectionViewState?.layerView?.layer?.title)?.codeField;return e||(console.warn(`[area-selection-interaction-store] no code field configured for layer ${this.selectionViewState.layerView.layer.title}`,this.fieldInfos),null)}clearSelections(){this.resetSelectedAreas(),this.clearHoveredArea(),this.lastAddedArea=null,this.lastRemovedArea=null,this.currentHoveredArea=null,console.log("[area-selection-interaction-store] selections cleared.")}cleanup(){this.resetSelectedAreas(),this.clearHoveredArea(),this.lastAddedArea=null,this.lastRemovedArea=null,this.currentHoveredArea=null,this.cachedNames.clear(),this.fieldInfos=[],console.log("[area-selection-interaction-store] cleaned up.")}}class te{#e=u(null);get layerId(){return d(this.#e)}set layerId(e){h(this.#e,e,!0)}#t=u(b(new S));get selectedAreaIds(){return d(this.#t)}set selectedAreaIds(e){h(this.#t,e,!0)}setLayerId(e){this.layerId!==e&&(this.layerId=e,this.selectedAreaIds.clear())}addSelectedArea(e){this.selectedAreaIds.add(e)}addSelectedAreas(e){e.forEach(t=>this.selectedAreaIds.add(t))}removeSelectedArea(e){this.selectedAreaIds.delete(e)}clearSelectedAreas(){this.selectedAreaIds.clear()}exportSnapshot(){return{layerId:this.layerId,selectedAreaIds:new S(this.selectedAreaIds)}}}class re{mapView;areaSelectionInteractionStore;interactableLayers;pointerMoveHandle=null;clickHandle=null;leaveHandle=null;enterHandle=null;#e=u(!0);get pointerInsideMap(){return d(this.#e)}set pointerInsideMap(e){h(this.#e,e,!0)}constructor(e,t,i){console.log("[map-interaction-store] Initializing with MapView"),this.mapView=e,this.areaSelectionInteractionStore=t,this.interactableLayers=i,this.setupHighlights(e),this.setupPointerMoveHandler(e),this.setupClickHandler(e),this.setupLeaveHandler(e),this.setupEnterHandler(e),console.log("[map-interaction-store] Initialized with MapView")}setupHighlights(e){const t={name:"hover",color:"lightgreen",haloOpacity:1,fillOpacity:.2},i={name:"selected",color:"green",haloOpacity:1,fillOpacity:.3};e.highlights.push(t),e.highlights.push(i)}setupPointerMoveHandler(e){this.pointerMoveHandle=e.on("pointer-move",async t=>{if(!this.pointerInsideMap)return;const{results:i}=await e.hitTest(t),r=i.find(l=>{if(!l)return!1;const c=l?.graphic;if(!c)return!1;const s=c?.layer;return s?this.isLayerInteractable(s.title)&&c.attributes?.[s.objectIdField]!==void 0:!1});if(!r){this.clearHoverHighlight();return}const a=r.graphic,n=a.layer;if(!a||!n||!this.isLayerInteractable(n.title)||a.attributes?.[n.objectIdField]===void 0){this.clearHoverHighlight();return}const o=a.attributes?.[n.objectIdField];if(!(this.areaSelectionInteractionStore.currentHoveredArea&&this.areaSelectionInteractionStore.currentHoveredArea.id===o))try{const l=await e.whenLayerView(n);this.areaSelectionInteractionStore.selectionViewState.layerView!==l&&this.areaSelectionInteractionStore.setSelectedLayerView(l),this.clearHoverHighlight();const c=l;if(!c){console.warn("LayerView is not a FeatureLayerView");return}if(!this.pointerInsideMap)return;const s=c.highlight(a,{name:"hover"});this.areaSelectionInteractionStore.setHoveredArea(o,s)}catch(l){console.error("Error in pointer-move handler:",l),this.clearHoverHighlight()}})}setupClickHandler(e){this.clickHandle=e.on("click",async t=>{const{results:i}=await e.hitTest(t),r=i[0];if(!r)return;const a=r.graphic,n=a.layer;if(!a||!n||!this.isLayerInteractable(n.title)||a.attributes?.[n.objectIdField]===void 0)return;const o=a.attributes?.[n.objectIdField];try{const l=await e.whenLayerView(n),c=l;if(!c){console.warn("Layer is not a FeatureLayerView");return}if(this.areaSelectionInteractionStore.selectionViewState.layerView!==l&&this.areaSelectionInteractionStore.setSelectedLayerView(l),this.areaSelectionInteractionStore.selectionViewState.areaHandles.get(o))this.areaSelectionInteractionStore.removeSelectedArea(o);else{const f=c.highlight(a,{name:"selected"});this.areaSelectionInteractionStore.addSelectedArea(o,f)}}catch(l){console.error("Error in click handler:",l)}})}setupLeaveHandler(e){this.leaveHandle=e.on("pointer-leave",()=>{this.pointerInsideMap=!1,this.clearHoverHighlight()})}setupEnterHandler(e){this.enterHandle=e.on("pointer-enter",()=>{this.pointerInsideMap=!0})}isLayerInteractable(e){return this.interactableLayers.has(e)}clearHoverHighlight(){this.areaSelectionInteractionStore.currentHoveredArea&&this.areaSelectionInteractionStore.clearHoveredArea()}updateInteractableLayers(e){this.interactableLayers=e}cleanup(){this.pointerMoveHandle&&(this.pointerMoveHandle.remove(),this.pointerMoveHandle=null),this.clickHandle&&(this.clickHandle.remove(),this.clickHandle=null),this.leaveHandle&&(this.leaveHandle.remove(),this.leaveHandle=null),this.enterHandle&&(this.enterHandle.remove(),this.enterHandle=null),this.clearHoverHighlight(),this.pointerInsideMap=!0,this.interactableLayers=new S,console.log("[map-interaction-store] cleaned up")}get currentMapView(){return this.mapView}}export{te as A,Z as L,re as M,Y as S,ee as a,S as b};
