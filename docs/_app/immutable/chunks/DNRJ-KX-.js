const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Cqkb5zdc.js","./Aa_nm3Tf.js","./BFGjv385.js","./DSdBzmdi.js","./BHwe4xe6.js","./Drf0nZ94.js","./Bv4rzOz8.js","./CH2voQe_.js","./Ci6C1k20.js","./bnayRBMH.js","./DWgil3ps.js","./Dwqd1w08.js","./8d4XiCAe.js","./CEYpN6bs.js","./DsdqSOQR.js","./PPVm8Dsz.js","./DPysyl42.js","./BJhaCM43.js","./DzPnzJx5.js","./LLVnLkr1.js","./CEIvA_E-.js","./DPb6J-GU.js","./D5lfJVJF.js","./wFIBN3al.js","./DZm7cYY_.js","./D_96sC_r.js","./BEpFWXkz.js","./DmoL4uwP.js","./CvJVpgMV.js","./BvZ8mO3n.js","./Bt-D_PUr.js","./DPJXGPFY.js","./CLXoG-5n.js","./BAwhstd8.js","./BnL9dRiP.js","./Bvmk-rnc.js","./DkGd4JTu.js","./CttKhsFI.js","./CiLz26oR.js","./Bc7uMo7x.js","./CT-_SrKz.js","./D7w1LsY9.js","./Dp7EIoZF.js","./UfB07l46.js","./DYspwNLv.js","./CISVLUtc.js","./DboXEB11.js","./CVwTD0fV.js","./Cl1y9xCy.js","./DCbUWbpl.js","./Bola1Gyj.js","./DWuFonT6.js","./XqQYA9Kc.js","./D1xSXHoa.js","./BP4OB8lT.js","./q_b6UJoq.js","./BpE1VQlG.js","./D_hPk45Z.js","./Dr6j4QXi.js","./CLUeyY5c.js","./DARfHPHw.js","./CSXZNpHb.js","./DYtTyGiR.js","./B6H5dYHk.js","./Djp3mnm5.js","./C9j04UTW.js","./DZIgQuAM.js","./CN9sEZ07.js","./PJA-oSZG.js","./DIGTz9Fo.js","./D9LecJbg.js","./DVdhdsPf.js","./B1tp3gsa.js","./BEM1Pz9A.js","./Cp_8tW2x.js","./BMM7N5Tr.js","./BurgD2W6.js","./Oe6SV2kF.js","./DTbXJ_Dm.js","./MtSiOt06.js","./C0wm8_Yw.js","./OROug527.js","./VzQSUR_q.js","./DGlNuEmX.js","./BcJu4T66.js","./BVXTGD7H.js","./hbA2VStE.js","./B87vTgcy.js","./sd8OvKRi.js","./B6VJd4jK.js","./B5KrPk5K.js","./BO9PY44w.js","./CxGYwNrO.js","./Bu-Kmli7.js","./CxXLonmD.js","./DvKU1K2H.js","../assets/jsxFactory.CQED0rIl.css","./a2KGoXuK.js","./BJ0i82DL.js","./CSxkCvzu.js","./DUzt8ZhE.js","./Pk78U0OI.js","./Bu3ymzBu.js","./CidP4wfb.js","./Cgb6qxNH.js","./D1puAYCv.js","./BQ6kwVi5.js","./4rLBhf07.js","./COehenBl.js","./DdWc1Xci.js","./CaVKkSa6.js","./DPG_QtyK.js","./B1N-tmtC.js","./DqPESIRO.js","./CvoKRsgE.js","./D-qJO60r.js","./QQC62dOK.js","./Bxxl7NsE.js","./1mhaIyTX.js","./DQOO6RKE.js","./DV6VugFz.js","./Bi6C4OG6.js","./l80NLc26.js","./D-YQ4CHs.js","./CB0fjJdw.js","./Bi-Hvdv_.js","./CcBkeIxb.js","./ClMhxk8y.js","./B3lKMARR.js","./vo5ikRo6.js","./aQ5IuZRd.js","./BD-Sb4-p.js","./CzB5EJsy.js","./BbDtXHtC.js","./CsbgHX1w.js","./CirnHLSB.js","./D9gy186-.js","./BXP3TJBz.js","./bwDMcLI5.js","./DAjO9PFl.js","./CoEUqqxC.js","./sl3O5HVX.js","./DsCH_XSv.js","./DQqC9TKz.js","./CcL-nW0Z.js","./DS6KqlQS.js","./36z667aM.js","./DF7gF6hq.js","./BK1S_sgT.js","./C1tUA3io.js","./CcceWh_T.js","./CKdAe3My.js","./D8UTKHFV.js","./Cw6nET6t.js","./BcjliOfo.js","./CKc66y4x.js","./B5bJgrnA.js","./BfZbt_DV.js","./BLyltQyJ.js","./Dr5Ivlkv.js","./DHYTDGcC.js","./BKo2foNY.js","./pWmsgnS9.js","./DFvpHt6D.js","./WCVSSNPR.js","./DabT61Ls.js","./CykAtxaZ.js","./hd_aUzM9.js","./DJgFlHSa.js","./C5FxRkvK.js","./waUk5IqZ.js","./V1j_h1SE.js","./C7CXFnjx.js","./Dxy7Bn4N.js","./BYodr0Bz.js","./BjXQDf3v.js","./GKolV7NZ.js","./QE3JtKjo.js","./jJEP_Pib.js","./CzDmcIx5.js","./vbhV9bie.js","./MMxDnOZf.js","./C_HvrvL1.js","./hfLZB9PK.js","./Bydm6Fc4.js","./DMDheznO.js","./BuPa4E3c.js","./B92kdZ15.js","./DP7_WWTp.js","./o_qglFAH.js","./BviBlhgR.js","./CFU8R5XJ.js","./sicDWFNL.js","./DwHfoDw-.js","./Cp-gmQeJ.js","./D1xEr0Uz.js","./W_wd8TLY.js","./DQntrP9f.js","./NcLQqnsB.js","./qyF9FwQ9.js","./XI-Li77m.js","./DC4T6Ptu.js","./n__Nwz3z.js","./CURTE_qC.js"])))=>i.map(i=>d[i]);
import{X as V,aK as mr,av as E,aw as se,am as de,O as _t,q as ie,aj as $,aL as vr,ao as mt,as as xr,e as yr}from"./CttKhsFI.js";import{n as _}from"./Cgb6qxNH.js";import{s as br,n as lt,a as wr}from"./DPb6J-GU.js";import{a0 as $r,b as Ge}from"./DsdqSOQR.js";import{g as Cr,b as Tr}from"./DkGd4JTu.js";import{e as kt,i as vt}from"./BP4OB8lT.js";import{m as Sr,n as Or,C as Qt,a1 as ut,y as ze,a2 as Pr,a3 as ve,l as Xt,a4 as Le,a5 as Yt,r as Jt,a6 as Kt,D as B,E as U,a7 as je,a8 as Rr,a9 as ct,aa as Dr,ab as Ne,ac as Ae,ad as Be,J as P,ae as Fr,af as Mr,M as Ue,K as Vr,ag as Ir,ah as zr,f as qr,ai as Lr,aj as jr,u as Ar,q as Er,ak as Hr,al as Wr,j as Gr,x as Nr,t as Br,am as Ur,an as kr,ao as Qr,ap as Xr,aq as Yr,ar as Jr,as as Kr,G as Zr,F as es,H as Zt,I as ts,at as ke,au as xt,av as rs,aw as ss,A as is,ax as as,ay as ns,az as os}from"./D8UTKHFV.js";import{u as hs,b as ls,J as us}from"./BFGjv385.js";import{U as cs}from"./Cw6nET6t.js";import{t as F}from"./CcceWh_T.js";import{N as me,x as dt,y as ds,r as gs,a5 as ge,a9 as Ce,av as yt,J as ps}from"./BHwe4xe6.js";import{b as bt,i as wt,c as et,h as fs,X as _s,Q as ms,q as vs,n as xs}from"./C9j04UTW.js";import{r as ne,e as M}from"./q_b6UJoq.js";import{S as ys,P as bs,D as ws}from"./BD-Sb4-p.js";import{m as $s}from"./B3lKMARR.js";import{_ as k}from"./PPVm8Dsz.js";import{Q as he}from"./DHYTDGcC.js";import{r as er,o as Cs,b as Ts}from"./bnayRBMH.js";import{j as Ss,r as Os,A as Ps,g as Rs,s as L,c as Ds,H as Fs,y as Ms,E as Vs,o as tr}from"./wFIBN3al.js";import{i as Ie,G as $t,k as Is,r as rr,n as xe,C as zs}from"./Dwqd1w08.js";import{a as qs,s as Ct,z as Ls}from"./DWgil3ps.js";import"./Bt-D_PUr.js";import{t as I}from"./B5bJgrnA.js";import{s as Q}from"./DabT61Ls.js";import{T as G,d as N,r as sr,_ as js}from"./CKc66y4x.js";import{d as As,_ as u,m as v,a as j,n as ye}from"./Aa_nm3Tf.js";import{h as ir}from"./DTQOylXD.js";import{t as Es,f as Hs,l as Ws}from"./C1tUA3io.js";import{i as Gs}from"./CvJVpgMV.js";import{watch as ae,initial as tt,on as Ns,syncAndInitial as Tt}from"./D5lfJVJF.js";import{i as Bs}from"./DSdBzmdi.js";import{n as gt}from"./BfZbt_DV.js";import{O as Us}from"./BcJu4T66.js";import{h as ks}from"./DKWMGTc5.js";import{o as Qs}from"./hd_aUzM9.js";import{_ as Xs,R as Ys,n as Te}from"./DQOO6RKE.js";import{h as ar,A as pt}from"./1mhaIyTX.js";import{r as Js}from"./CykAtxaZ.js";import{t as Ks}from"./B93H1Ttm.js";import{s as oe,u as Zs,c as Y,e as Se}from"./BcjliOfo.js";import{r as Qe}from"./a2KGoXuK.js";import{j as ei,v as St,w as Ot}from"./DsCH_XSv.js";import{r as be}from"./Dp7EIoZF.js";import{n as ti}from"./C5FxRkvK.js";import{f as ri,F as si}from"./DPG_QtyK.js";function gn(t,e,r=null){const s=[],i=e.mapPositions,a=ii(e,s),n=a.data,o=a.indices.length,l=cs(o);return ai(e,s,l),hi(e,s,l),ni(e,s,l),oi(e,s,a.indices,l),li(e,s,a.indices,l),ui(e,s),ci(e,s,a.indices,l),di(e,s,n),new Sr(t,s,i,2,r)}function ii(t,e){const{attributeData:{position:r},removeDuplicateStartEnd:s}=t,i=gi(r)&&s,a=r.length/3-(i?1:0),n=new Array(2*(a-1)),o=i?r.slice(0,-3):r;let l=0;for(let d=0;d<a-1;d++)n[l++]=d,n[l++]=d+1;const g=new F(o,n,3,i);return e.push(["position",g]),g}function ai(t,e,r){if(t.attributeData.colorFeature!=null)return;const s=t.attributeData.color;e.push(["color",new F(s??br,r,4)])}function ni(t,e,r){t.attributeData.normal&&e.push(["normal",new F(t.attributeData.normal,r,3)])}function oi(t,e,r,s){const i=t.attributeData.colorFeature;i!=null&&(typeof i=="number"?e.push(["colorFeatureAttribute",new F([i],s,1,!0)]):e.push(["colorFeatureAttribute",new F(i,r,1,!0)]))}function hi(t,e,r){t.attributeData.sizeFeature==null&&e.push(["size",new F([t.attributeData.size??1],r,1,!0)])}function li(t,e,r,s){const i=t.attributeData.sizeFeature;i!=null&&(typeof i=="number"?e.push(["sizeFeatureAttribute",new F([i],s,1,!0)]):e.push(["sizeFeatureAttribute",new F(i,r,1,!0)]))}function ui(t,e){const{attributeData:{position:r,timeStamps:s}}=t;if(!s)return;const i=r.length/3,a=new Array(2*(i-1));let n=0;for(let o=0;o<i-1;o++)a[n++]=o,a[n++]=o+1;e.push(["timeStamps",new F(s,a,_i,!0)])}function ci(t,e,r,s){const i=t.attributeData.opacityFeature;i!=null&&(typeof i=="number"?e.push(["opacityFeatureAttribute",new F([i],s,1,!0)]):e.push(["opacityFeatureAttribute",new F(i,r,1,!0)]))}function di(t,e,r){if(t.overlayInfo==null||t.overlayInfo.renderCoordsHelper.viewingMode!==1||!t.overlayInfo.spatialReference.isGeographic)return;const s=kt(r.length),i=$r(t.overlayInfo.spatialReference);for(let f=0;f<s.length;f+=3)Cr(r,f,s,f,i);const a=r.length/3,n=Or(a+1);let o=pi,l=fi,g=0,d=0;V(o,s[d++],s[d++]),d++,n[0]=0;for(let f=1;f<a+1;++f)f===a&&(d=0),V(l,s[d++],s[d++]),d++,g+=mr(o,l),n[f]=g,[o,l]=[l,o];e.push(["distanceToStart",new F(n,e[0][1].indices,1,!0)])}function gi(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}const pi=_(),fi=_(),_i=4;let mi=class extends ks{},Pt=class{constructor(){this._extent=Ie(),this.resolution=0,this.renderLocalOrigin=Es(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new vi}get extent(){return this._extent}setExtent(e){qs(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const r=.001*e.range;if(this._extent[0]-r<=e.min){const s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];$t(this._extent,e.range,0,s)}if(this._extent[2]+r>=e.max){const s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];$t(this._extent,-e.range,0,s)}}_setupGeometryView(){this.canvasGeometries.numViews=1,Is(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},vi=class{constructor(){this.extents=[Ie(),Ie(),Ie()],this.numViews=0}},xi=class{constructor(e,r,s){this._fbos=e,this._format=r,this._name=s}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=me(this._handle)}get texture(){return this._handle?.getTexture()}ensureFramebuffer(e,r){this._handle&&this._handle.fbo?.width===e&&this._handle.fbo?.height===r||(this._handle?.release(),this._handle=this._fbos.acquire(e,r,this._name,this._format))}bind(e){e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},J=class{constructor(e,r,s,i,a=1,n=6){this.output=s,this.content=i,this.redrawOnRequest=a,this.fbo=new xi(e,n,r)}handleRenderRequest(e){return e===1||e===this.redrawOnRequest}get valid(){return this.fbo.valid}},yi=class{constructor(e){this.targets=[new J(e,"overlay color",0,0),new J(e,"overlay IM color",0,1),new J(e,"overlay highlight",9,2,1,3),new J(e,"overlay water",3,3,0),new J(e,"overlay occluded",0,4)],Qt()&&this.targets.push(new J(e,"overlay olid",10,5,1,5))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(e){if(e!==0)for(const r of this.targets)r.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,r,s)=>r.valid?e|=1<<s:e,0)}},nr=class extends ve{constructor(){super(...arguments),this.color=rr(1,1,1)}};function bi(){const t=new Q;return t.include(ut),t.fragment.uniforms.add(new ze("tex",e=>e.texture),new Pr("uColor",e=>e.color)),t.fragment.main.add(I`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),t}const wi=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:nr,build:bi},Symbol.toStringTag,{value:"Module"})),$i={required:[]};let or=class extends As{precompile(e){return!!this.acquireTechniques(e)}consumes(){return $i}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}},Ci=class extends or{},$n=class extends or{},Rt=class extends Xt{constructor(e,r){super(e,"ivec2",1,(s,i,a)=>s.setUniform2iv(e,r(i,a)))}},Ee=class extends Xt{constructor(e,r){super(e,"usampler2D",1,(s,i,a)=>s.bindTexture(e,r(i,a)))}},hr=class extends ve{};function Ti(){const t=new Q,{outputs:e,fragment:r}=t;return t.include(ut),r.uniforms.add(new Ee("highlightTexture",s=>s.highlightTexture)),r.constants.add("outlineWidth","int",Math.ceil(qe)),r.constants.add("cellSize","int",W),e.add("fragGrid","uvec2"),r.main.add(I`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),t}const W=32,qe=9,lr=.4,Si=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:hr,blurSize:lr,build:Ti,gridCellPixelSize:W,outlineSize:qe},Symbol.toStringTag,{value:"Module"}));function ft(t){const{vertex:e}=t;e.uniforms.add(new Ee("coverageTexture",r=>r.coverageTexture),new Rt("highlightRenderCellCount",r=>V(Dt,r.horizontalCellCount,r.verticalCellCount)),new Rt("highlightTextureResolution",({highlightTexture:r})=>V(Dt,r.descriptor.width,r.descriptor.height)),new Le("highlightLevel",r=>r.highlightLevel)).constants.add("cellSize","int",W),t.varyings.add("sUV","vec2"),t.varyings.add("vOutlinePossible","float"),e.code.add(I`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),e.main.add(I`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const Dt=_();function Oi(){const t=new Q;t.include(ft);const{fragment:e}=t;return e.uniforms.add(new ze("blurInput",r=>r.highlightBlurTexture),new Yt("blurSize",r=>r.blurSize),new Ee("highlightTexture",r=>r.highlightTexture),new ze("highlightOptionsTexture",r=>r.highlightOptionsTexture),new Le("highlightLevel",r=>r.highlightLevel),new Jt("occludedIntensityFactor",r=>r.occludedFactor)),e.constants.add("inner","float",1-(qe-lr)/qe),t.include(Kt),e.main.add(I`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),t}const Pi=Object.freeze(Object.defineProperty({__proto__:null,build:Oi},Symbol.toStringTag,{value:"Module"}));let Ft=class extends B{constructor(e,r){super(e,r,new U(Pi,()=>k(()=>import("./Cqkb5zdc.js").then(s=>s.H),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203]),import.meta.url)),gt(je))}initializePipeline(){return G({blending:sr,colorWrite:N})}},ur=class extends ve{constructor(){super(...arguments),this.blurSize=_()}};function Ri(){const t=new Q;return t.include(ft),t.outputs.add("fragHighlight","vec2",0),t.fragment.uniforms.add(new Yt("blurSize",e=>e.blurSize),new Rr("blurInput",e=>e.blurInput)).main.add(I`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),t}const Di=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:ur,build:Ri},Symbol.toStringTag,{value:"Module"}));let Mt=class extends B{constructor(e,r){super(e,r,new U(Di,()=>k(()=>import("./Cqkb5zdc.js").then(s=>s.a),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203]),import.meta.url)),gt(je))}initializePipeline(){return G({colorWrite:N})}},Xe=class extends B{constructor(e,r){super(e,r,new U(Si,()=>k(()=>import("./Cqkb5zdc.js").then(s=>s.b),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203]),import.meta.url)),ct)}initializePipeline(){return G({colorWrite:N})}};class Fi extends ve{constructor(){super(...arguments),this.occludedFactor=Us,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}}function Mi(){const t=new Q;t.include(ft),t.include(Kt);const{fragment:e}=t;return t.outputs.add("fragSingleHighlight","vec2",0),e.uniforms.add(new Ee("highlightTexture",r=>r.highlightTexture),new Le("highlightLevel",r=>r.highlightLevel)),e.main.add(I`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),t}const Vi=Object.freeze(Object.defineProperty({__proto__:null,build:Mi},Symbol.toStringTag,{value:"Module"}));let Vt=class extends B{constructor(e,r){super(e,r,new U(Vi,()=>k(()=>import("./Cqkb5zdc.js").then(s=>s.c),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203]),import.meta.url)),gt(je))}initializePipeline(){return G({colorWrite:N})}},Oe=class extends Dr{constructor(){super(...arguments),this.produces=Ne.HIGHLIGHTS,this.consumes={required:[Ne.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new hr,this._passParameters=new Fi,this._highlightBlurDrawParameters=new ur,this._grid=new Ii}initialize(){this.addHandles([ae(()=>this._updateOptionsTexture(),()=>{},tt)])}destroy(){this._grid.coverage=me(this._grid.coverage),this._grid.vao=dt(this._grid.vao),this._passParameters.highlightOptionsTexture=me(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){const t=new ar(16,2);t.internalFormat=6408,t.samplingMode=9728,this._passParameters.highlightOptionsTexture=new pt(this.renderingContext,t,null)}this._passParameters.highlightOptionsTexture.setData(zi(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(Xe),this.techniques.precompile(Vt),this.techniques.precompile(Mt),this.techniques.precompile(Ft)}render(t){const e=t.find(({name:a})=>a===Ne.HIGHLIGHTS),{techniques:r,bindParameters:s}=this;if(!s.decorations)return e;if(!r.get(Xe).compiled)return this.requestRender(1),e;const i=t.find(({name:a})=>a==="highlights").getTexture();return this._renderHighlightPostprocess(i,e),e}_prepareAndDownSample(t){this._gridUpdateResources(t);const e=this.techniques.get(Xe),r=this._gridComputeCoverage(e,t),{horizontalCellCount:s,verticalCellCount:i}=r,a=this._passParameters;return a.horizontalCellCount=s,a.verticalCellCount=i,a.coverageTexture=r.coverage?.getTexture(),r}_renderGrid(t){const e=t.verticalCellCount*t.horizontalCellCount;this.renderingContext.bindVAO(t.vao),this.renderingContext.drawElementsInstanced(Xs.TRIANGLES,6,Ys.UNSIGNED_BYTE,0,e)}_renderHighlightPostprocess(t,e){const{fboCache:r,techniques:s,bindParameters:i,_passParameters:a,renderingContext:n}=this,o=s.get(Vt),l=s.get(Mt),g=s.get(Ft);if(!g.compiled||!l.compiled||!o.compiled)return void this.requestRender(1);a.highlightTexture=t;const d=this._prepareAndDownSample(t),{width:f,height:b}=t.descriptor;a.highlightTexture=t;const{camera:p}=i,{fullWidth:y,fullHeight:le,pixelRatio:X,fullViewport:He}=p,ue=Math.ceil(y/X),ce=Math.ceil(le/X),{_highlightBlurDrawParameters:A}=this,m=this.view.stage.renderView.renderer,{highlights:C}=i;for(let we=0;we<C.length;++we){const{name:_r}=C[we];if(!m.hasHighlight(_r))continue;a.highlightLevel=we,n.setClearColor(0,0,0,0);const We=r.acquire(f,b,"single highlight",2);n.bindFramebuffer(We.fbo),n.setViewport(0,0,f,b),n.clear(16384),n.bindTechnique(o,i,a),this._renderGrid(d),A.blurInput=We.getTexture(),V(A.blurSize,1/ue,0);const $e=r.acquire(ue,ce,"single highlight blur",2);n.unbindTexture($e.fbo?.colorTexture),n.bindFramebuffer($e.fbo),n.setViewport(0,0,ue,ce),n.clear(16384),n.bindTechnique(l,i,a,A),this._renderGrid(d),We.release(),V(A.blurSize,0,1/ce),a.highlightBlurTexture=$e.getTexture(),n.bindFramebuffer(e.fbo),n.setViewport4fv(He),n.bindTechnique(g,i,a,A),this._renderGrid(d),$e.release()}a.coverageTexture=a.highlightTexture=null}_gridUpdateResources(t){const e=this._grid,{width:r,height:s}=t.descriptor;if(e.horizontalCellCount=Math.ceil(r/W),e.verticalCellCount=Math.ceil(s/W),e.vao)return;const i=this.renderingContext,a=Qs.createIndex(i,35044,ji);e.vao=new mi(i,new Js(i,je),a)}_gridComputeCoverage(t,e){const r=this.renderingContext,s=this._grid,i=e.descriptor,a=Math.ceil(i.width/W),n=Math.ceil(i.height/W);this._downsampleDrawParameters.input=e;const{highlights:o}=this.bindParameters;s.coverage?.release();const l=this.fboCache.acquire(a,n,"highlight coverage",o.length>cr?3:1);return s.coverage=l,r.bindFramebuffer(l.fbo),r.bindTechnique(t,this.bindParameters,this._passParameters,this._downsampleDrawParameters),r.setViewport(0,0,a,n),r.screen.draw(),s}get test(){}};u([v()],Oe.prototype,"produces",void 0),u([v()],Oe.prototype,"consumes",void 0),Oe=u([j("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Oe);let Ii=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function zi(t){const e=new Uint8Array(128);let r=0;for(const s of t){const i=4*r,a=4*r+64;++r;const{color:n}=s,o=s.haloColor??n;e[i+0]=n.r,e[i+1]=n.g,e[i+2]=n.b,e[i+3]=s.fillOpacity*n.a*255,e[a+0]=o.r,e[a+1]=o.g,e[a+2]=o.b,e[a+3]=s.haloOpacity*o.a*255}return e}let qi=0;function Li(t){let e=0;for(const s of t){const{name:i}=s;e+=i.length;const{color:a,fillOpacity:n,haloColor:o,haloOpacity:l}=s;e+=a.r+a.g+a.b+a.a+n,e+=o?o.r+o.g+o.b+o.a+l:0}const r=t.at(0);if(r){const{shadowOpacity:s,shadowDifference:i,shadowColor:a}=r;e+=s+i+a.r+a.g+a.b+a.a}return qi+++(e>=0?0:1)}const ji=new Uint8Array([0,1,2,2,1,3]);function Ai(t,e,r,s,i,a=0){const{highlights:n}=s,o=n.length>1?e.acquire(r.width,r.height,"highlight mix",n.length>cr?3:1):null,{gl:l}=t;if(o){const d=t.getBoundFramebufferObject();t.bindFramebuffer(o.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),t.bindFramebuffer(d)}const g=o?.getTexture();s.highlightMixTexture=g,V(s.highlightMixOrigin,a,0),n.forEach((d,f)=>{if(f>0){const b=pt.TEXTURE_UNIT_FOR_UPDATES;t.bindTexture(g,b),t.setActiveTexture(b),l.copyTexSubImage2D(3553,0,0,0,a,0,r.width,r.height),t.bindTexture(null,b)}t.clear(256),s.highlightLevel=f,i()}),s.highlightLevel=null,s.highlightMixTexture=null,o?.release()}const cr=4;let Ei=class{constructor(e,r,s,i){this.material=e,this.output=r,this.techniques=s,this.textures=i}},Hi=class{constructor(e,r,s,i){this._textures=e,this._techniques=r,this.materialChanged=s,this.requestRender=i,this._id2glMaterialRef=new Ks}dispose(){this._textures.destroy()}acquire(e,r,s){if(this._ownMaterial(e),!e.produces.get(r)?.(s))return null;let a=this._id2glMaterialRef.get(s,e.id);if(a==null){const n=e.createGLMaterial(new Ei(e,s,this._techniques,this._textures));a=new Wi(n),this._id2glMaterialRef.set(s,e.id,a)}return a.ref(),a.glMaterial}release(e,r){const s=this._id2glMaterialRef.get(r,e.id);s!=null&&(s.unref(),s.referenced||(dt(s.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&Bs.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Wi=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,oe(this._refCnt>=0)}get referenced(){return this._refCnt>0}};function Gi(t){return t!=null&&!t.readyToRun}var rt;let Pe=rt=class extends ye{constructor(t){super(t),this.type="cloudy",this.cloudCover=.5}clone(){return new rt({cloudCover:this.cloudCover})}};u([be({cloudy:"cloudy"}),v({json:{write:{isRequired:!0}}})],Pe.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Pe.prototype,"cloudCover",void 0),Pe=rt=u([j("esri.views.3d.environment.CloudyWeather")],Pe);var st;let Re=st=class extends ye{constructor(t){super(t),this.type="foggy",this.fogStrength=.5}clone(){return new st({fogStrength:this.fogStrength})}};u([be({foggy:"foggy"}),v({json:{write:{isRequired:!0}}})],Re.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Re.prototype,"fogStrength",void 0),Re=st=u([j("esri.views.3d.environment.FoggyWeather")],Re);var it;let pe=it=class extends ye{constructor(t){super(t),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new it({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([be({rainy:"rainy"}),v({json:{write:{isRequired:!0}}})],pe.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],pe.prototype,"cloudCover",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],pe.prototype,"precipitation",void 0),pe=it=u([j("esri.views.3d.environment.RainyWeather")],pe);var at;let K=at=class extends ye{constructor(t){super(t),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new at({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};u([be({snowy:"snowy"}),v({json:{write:{isRequired:!0}}})],K.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],K.prototype,"cloudCover",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],K.prototype,"precipitation",void 0),u([v({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],K.prototype,"snowCover",void 0),K=at=u([j("esri.views.3d.environment.SnowyWeather")],K);var nt;let De=nt=class extends ye{constructor(t){super(t),this.type="sunny",this.cloudCover=.5}clone(){return new nt({cloudCover:this.cloudCover})}};u([be({sunny:"sunny"}),v({json:{write:{isRequired:!0}}})],De.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],De.prototype,"cloudCover",void 0),De=nt=u([j("esri.views.3d.environment.SunnyWeather")],De);const Fe=1e4,Ln=1e5;let Ni=class{constructor(){this.startTime=0,this._data=Qe(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new It,this.parallaxNew=new It,this._anchorPoint=xe(),this._fadeState=Qe(0),this._fadeFactor=Qe(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,r,s){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=s?er((r-this.startTime)/(Ui*s),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,r),this._updateParallax(e)}_evaluateState(e,r){const s=e.relativeElevation,i=this._updateAnchorPoint(e);(s>1.7*Fe||s<-Fe||i>qt)&&this.opacity>0?this._startFade(0,r):this.isFading||(s>Fe||s<-.35*Fe||i>ki*qt?this.opacity>0&&this._startFade(4,r):Gi(this.data)&&(this.opacity===0?this._startFade(1,r):this.data.state===2&&(this.fadeState===2?this._startFade(3,r):this._startFade(2,r))))}_updateParallax(e){const r=Ss(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(r-Ge.radius*Ge.radius,0))/Math.sqrt(r),St(zt,this.parallax.anchorPoint,Z),bt(this.parallax.transform,ne,Z[3],Ot(Z)),St(zt,this.parallaxNew.anchorPoint,Z),bt(this.parallaxNew.transform,ne,Z[3],Ot(Z))}_updateAnchorPoint(e){return Ps(this._anchorPoint,e.eye),Rs(this._anchorPoint,this._anchorPoint,Ge.radius),this.fadeState===0&&this.data?.state===2?(L(this.parallax.anchorPoint,this._anchorPoint),0):Os(Ds(Bi,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,r){switch(this._fadeState.value=e,this.startTime=r,e){case 3:this.requestFade(),this._switchReadChannels(),L(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),L(this.parallax.anchorPoint,this._anchorPoint),L(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),L(this.parallax.anchorPoint,this._anchorPoint),L(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==2&&(this.data.state=0),this.fadeState){case 3:L(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:hs(this.fadeState)}}_switchReadChannels(){this.data?.state===2&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return this.fadeState===4||this.fadeState===1||this.fadeState===3}},It=class{constructor(){this.anchorPoint=xe(),this.radiusCurvatureCorrection=0,this.transform=M()}};const zt=rr(0,0,1),Z=ei(),Bi=xe(),Ui=1.25,ki=.5,qt=2e5;let Qi=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new Ae,this._inverseViewport=_(),this._oldLighting=new Be,this._newLighting=new Be,this._fadedLighting=new Be,this._lighting=this._newLighting,this.ssr=new Xi,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=_(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new Ni,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,r,s,i){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=r,this._newLighting.globalFactor=s,this._newLighting.set(e),this._oldLighting.updateLegacy(),i===1&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},Xi=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=M()}},Yi=class{constructor(e,r,s){this.rctx=e,this.techniques=s,this.lastFrameCamera=new Ae,this.output=0,this.renderOccludedMask=ot,this.time=ds(0),this.bind=new Qi(r),this.bind.alignPixelEnabled=!0}};const ot=13;let _e=class extends Ae{constructor(){super(...arguments),this._projectionMatrix=M()}get projectionMatrix(){return this._projectionMatrix}};u([v()],_e.prototype,"_projectionMatrix",void 0),u([v({readOnly:!0})],_e.prototype,"projectionMatrix",null),_e=u([j("esri.views.3d.webgl-engine.lib.CascadeCamera")],_e);class Me{constructor(){this.camera=new _e,this.lightMat=M()}}class Ji{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}let Ki=class{constructor(e,r){this._fbos=e,this._viewingMode=r,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Ji,this._projectionView=M(),this._projectionViewInverse=M(),this._modelViewLight=M(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=lt(),this._cascades=[new Me,new Me,new Me,new Me],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(ls("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(Te)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Ct(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=me(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=er(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)Je[e]=this._cascades[e];return Je.length=this._numCascades,Je}start(e,r,s,i,a){oe(this.enabled);const{near:n,far:o}=ia(s);this._computeCascadeDistances(n,o,i),this._textureHeight=this._computeTextureHeight(e,a,i),this._setupMatrices(e,r);const{viewMatrix:l,projectionMatrix:g}=e;for(let d=0;d<this._numCascades;++d)this._constructCascade(d,g,l,r);this._lastOrigin=null,this.clear()}finish(){oe(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!Fs(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||xe(),L(this._lastOrigin,e);for(let r=0;r<this._numCascades;++r){wt(Wt,this._cascades[r].lightMat,e);for(let s=0;s<16;++s)Gt[16*r+s]=Wt[s]}}return Gt}moveSnapshot(e){oe(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(e===0?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){if(!this.enabled||!this._handle?.getTexture(Te)?.descriptor)return;this._snapshots[e]?.release();const s=e===0?"shadow map highlight":"shadow map excluding highlight",i=this._acquireFBO(s);this._snapshots[e]=i;const a=this._handle?.fbo;if(!a||!i?.fbo)return void console.error("No FBO");const{rctx:n}=this._fbos;n.blitFramebuffer(a,i.fbo,256)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(Te):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:r,fullHeight:s},i,a){const n=Math.min(window.devicePixelRatio,i)/e,o=a?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return ti(Math.max(r,s)*n*o,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){const r=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return r.getTexture(Te)?.setShadowFiltering(!0),r}_discardSnapshot(e){this._snapshots[e]=me(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,r,s,i){const a=this._cascades[e],n=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],l=(r[10]*n+r[14])/Math.abs(r[11]*n+r[15]),g=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]);oe(l<g);for(let p=0;p<8;++p){Ct(Lt,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?l:g,1);const y=D[p];Ls(y,Lt,this._projectionViewInverse),y[0]/=y[3],y[1]/=y[3],y[2]/=y[3]}Ms(Ye,D[0]),a.camera.viewMatrix=wt(Zi,this._modelViewLight,Ye);for(let p=0;p<8;++p)Vs(D[p],D[p],a.camera.viewMatrix);let d=D[0][2],f=D[0][2];for(let p=1;p<8;++p)d=Math.min(d,D[p][2]),f=Math.max(f,D[p][2]);d-=200,f+=200,a.camera.near=-f,a.camera.far=-d,sa(s,i,d,f,a.camera),et(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);const b=this._textureHeight;a.camera.viewport=[e*b,0,b,b]}_setupMatrices(e,r){et(this._projectionView,e.projectionMatrix,e.viewMatrix),fs(this._projectionViewInverse,this._projectionView);const s=this._viewingMode===1?e.eye:tr(Ye,0,0,1);_s(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],s)}_computeCascadeDistances(e,r,s){const i=s?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Zs(r/e,4)),i);const a=(r-e)/this._numCascades,n=(r/e)**(1/this._numCascades);let o=e,l=e;for(let g=0;g<this._numCascades+1;++g)this._cascadeDistances[g]=Cs(o,l,this.settings.splitSchemeLambda),o*=n,l+=a}get test(){}};const Zi=M(),Lt=lt(),D=[];for(let t=0;t<8;++t)D.push(lt());const jt=_(),At=_(),ea=_(),Et=_(),Ht=_(),Ye=xe(),Je=[],Wt=M(),Gt=ne.concat(ne,ne,ne),O=_(),ee=_(),H=[_(),_(),_(),_()],x=_(),Ke=_(),q=_(),fe=_(),te=_(),re=_(),Ve=_();function ta(t,e,r,s,i,a,n,o){V(O,0,0);for(let m=0;m<4;++m)E(O,O,t[m]);se(O,O,.25),V(ee,0,0);for(let m=4;m<8;++m)E(ee,ee,t[m]);se(ee,ee,.25),de(H[0],t[4],t[5],.5),de(H[1],t[5],t[6],.5),de(H[2],t[6],t[7],.5),de(H[3],t[7],t[4],.5);let l=0,g=_t(H[0],O);for(let m=1;m<4;++m){const C=_t(H[m],O);C<g&&(g=C,l=m)}ie(x,H[l],t[l+4]);const d=x[0];let f,b;x[0]=-x[1],x[1]=d,ie(Ke,ee,O),$(Ke,x)<0&&vr(x,x),de(x,x,Ke,r),mt(x,x),f=b=$(ie(q,t[0],O),x);for(let m=1;m<8;++m){const C=$(ie(q,t[m],O),x);C<f?f=C:C>b&&(b=C)}xr(s,O),se(q,x,f-e),E(s,s,q);let p=-1,y=1,le=0,X=0;for(let m=0;m<8;++m){ie(fe,t[m],s),mt(fe,fe);const C=x[0]*fe[1]-x[1]*fe[0];C>0?C>p&&(p=C,le=m):C<y&&(y=C,X=m)}Y(p>0,"leftArea"),Y(y<0,"rightArea"),se(te,x,f),E(te,te,O),se(re,x,b),E(re,re,O),Ve[0]=-x[1],Ve[1]=x[0];const He=Se(s,t[X],re,E(q,re,Ve),1,i),ue=Se(s,t[le],re,q,1,a),ce=Se(s,t[le],te,E(q,te,Ve),1,n),A=Se(s,t[X],te,q,1,o);Y(He,"rayRay"),Y(ue,"rayRay"),Y(ce,"rayRay"),Y(A,"rayRay")}function c(t,e){return 3*e+t}const Nt=_();function S(t,e){return V(Nt,t[e],t[e+3]),Nt}const T=_(),h=yr();function ra(t,e,r,s,i){ie(T,r,s),se(T,T,.5),h[0]=T[0],h[1]=T[1],h[2]=0,h[3]=T[1],h[4]=-T[0],h[5]=0,h[6]=T[0]*T[0]+T[1]*T[1],h[7]=T[0]*T[1]-T[1]*T[0],h[8]=1,h[c(0,2)]=-$(S(h,0),t),h[c(1,2)]=-$(S(h,1),t);let a=$(S(h,0),r)+h[c(0,2)],n=$(S(h,1),r)+h[c(1,2)],o=$(S(h,0),s)+h[c(0,2)],l=$(S(h,1),s)+h[c(1,2)];a=-(a+o)/(n+l),h[c(0,0)]+=h[c(1,0)]*a,h[c(0,1)]+=h[c(1,1)]*a,h[c(0,2)]+=h[c(1,2)]*a,a=1/($(S(h,0),r)+h[c(0,2)]),n=1/($(S(h,1),r)+h[c(1,2)]),h[c(0,0)]*=a,h[c(0,1)]*=a,h[c(0,2)]*=a,h[c(1,0)]*=n,h[c(1,1)]*=n,h[c(1,2)]*=n,h[c(2,0)]=h[c(1,0)],h[c(2,1)]=h[c(1,1)],h[c(2,2)]=h[c(1,2)],h[c(1,2)]+=1,a=$(S(h,1),e)+h[c(1,2)],n=$(S(h,2),e)+h[c(2,2)],o=$(S(h,1),r)+h[c(1,2)],l=$(S(h,2),r)+h[c(2,2)],a=-.5*(a/n+o/l),h[c(1,0)]+=h[c(2,0)]*a,h[c(1,1)]+=h[c(2,1)]*a,h[c(1,2)]+=h[c(2,2)]*a,a=$(S(h,1),e)+h[c(1,2)],n=$(S(h,2),e)+h[c(2,2)],o=-n/a,h[c(1,0)]*=o,h[c(1,1)]*=o,h[c(1,2)]*=o,i[0]=h[0],i[1]=h[1],i[2]=0,i[3]=h[2],i[4]=h[3],i[5]=h[4],i[6]=0,i[7]=h[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=h[6],i[13]=h[7],i[14]=0,i[15]=h[8]}function sa(t,e,r,s,i){const a=1/D[0][3],n=1/D[4][3];oe(a<n);let o=a+Math.sqrt(a*n);const l=Math.sin(Ts(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));o/=l,ta(D,o,l,jt,At,ea,Et,Ht),ra(jt,At,Et,Ht,i.projectionMatrix),i.projectionMatrix[10]=2/(r-s),i.projectionMatrix[14]=-(r+s)/(r-s)}function ia(t){let{near:e,far:r}=t;return e<2&&(e=2),r<2&&(r=2),e>=r&&(e=2,r=4),{near:e,far:r}}class Bt extends B{constructor(e,r){super(e,r,new U(wi,()=>k(()=>import("./Cqkb5zdc.js").then(s=>s.T),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203]),import.meta.url)),ct)}initializePipeline(e){return e.hasAlpha?G({blending:sr,colorWrite:N}):G({colorWrite:N})}}let dr=class extends Fr{constructor(){super(...arguments),this.hasAlpha=!1}};u([P()],dr.prototype,"hasAlpha",void 0);let gr=class extends ve{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}};function aa(){const t=new Q;return t.include(ut),t.fragment.uniforms.add(new ze("tex",e=>e.texture)),t.fragment.uniforms.add(new Le("overlayIdx",e=>e.overlayIndex)),t.fragment.uniforms.add(new Jt("opacity",e=>e.opacity)),t.fragment.main.add(I`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),t}const na=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:gr,build:aa},Symbol.toStringTag,{value:"Module"}));let Ut=class extends B{constructor(e,r){super(e,r,new U(na,()=>k(()=>import("./Cqkb5zdc.js").then(s=>s.O),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203]),import.meta.url)),ct)}},z=class extends Ci{constructor(t){super(t),this._overlays=null,this._renderTargets=null,this._overlayParameters=new gr,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new gs,this._passParameters=new nr,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Ae,this.events=new Gs,this.longitudeCyclical=null,this.produces=new Map([[18,e=>e!==9||this.hasHighlights],[19,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){const t=this._view,e=t.stage,r=e.renderer.fboCache,{waterTextures:s,techniques:i}=e.renderView;this._renderContext=new Yi(this._rctx,new Ki(r,t.state.viewingMode),i),this.addHandles([ae(()=>s.updating,()=>this.events.emit("content-changed"),Tt),ae(()=>this._spatialReference,o=>this._localOriginFactory=new Hs(o),Tt),Ns(()=>t.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),ae(()=>Li(t.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,tt),ae(()=>t.state.highlights,o=>{this._bindParameters.highlights=o,this._bindParameters.highlightOrderMap=t.state.highlightOrderMap},tt),t.resourceController.scheduler.registerTask(ri.OVERLAY_RENDERER,this)]);const{_bindParameters:a,_camera:n}=this;n.near=1,n.far=1e4,n.relativeElevation=null,a.slot=18,a.mainDepth=null,a.camera=n,a.oitPass=0,a.updateLighting([new Mr(zs())],0,0,0)}destroy(){this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._passParameters.texture=dt(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(t){const e=new Hi(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._pluginContext={...t,materials:e},this._techniques.precompile(Ut)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||ge(this._renderers,t=>t.updating||t.canCompact)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(t){for(const e of this._renderers.values()){const r=e.getMaterialRenderer(t);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),us(this._sortedRenderers.map(t=>t.drapeSource.layer).filter(t=>!!t))}registerDrapeSource(t,e){const r=this._renderers.get(t);r?.destroy(),this._renderers.set(t,e),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in t&&this.addHandles(ae(()=>t.fullOpacity,()=>this.events.emit("content-changed")),t)}removeDrapeSourceRenderer(t){if(t==null)return;const e=this._renderers.get(t);e!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(t),this.removeHandles(t),e.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(t){this._renderTargets?.dispose(t)}get overlays(){return this._overlays??[]}ensureDrapeTargets(t){this._hasTargetWithoutRasterImage=!!this._overlays&&Ce(t,e=>e.drapeTargetType===1)}ensureDrapeSources(t){this._overlays?(this._hasDrapedFeatureSource=Ce(t,e=>e.drapeSourceType===1),this._hasDrapedRasterSource=Ce(t,e=>e.drapeSourceType===0),this._hasDrapedFlowSource=Ce(t,e=>e.drapeSourceType===2)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(t,e,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new yi(this._stage.renderer.fboCache),this._overlays=[new Pt,new Pt]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets?.dispose(1),this._renderTargets=null,this.events.emit("textures-disposed")}_useOverlayColorInsteadOfColorNoRasterImage(t){return t===1&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(t){const e=this._useOverlayColorInsteadOfColorNoRasterImage(t);return this._renderTargets?.getTexture(e?0:t)}get readyToRun(){return this.updating}runTask(t){this._processDrapeSources(t,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=ge(this._renderers,t=>t.hasOccluders)?Ze:1}_processDrapeSources(t,e){let r=!1;for(const[s,i]of this._renderers){if(t.done)break;(s.destroyed||e(s))&&i.commitChanges()&&(r=!0,t.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers(),t.madeProgress()),this.compact(t),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this._onMaterialOrContentChanged(),this.hasHighlights=ge(this._renderers,s=>s.hasHighlights),this.events.emit("content-changed"))}compact(t){let e=!1;for(const r of this._renderers.values()){if(t.done)break;e=r.compact(t)||e}return e&&this.notifyChange("updating"),e}hasHighlight(t){return ge(this._renderers,e=>e.hasHighlight(t))}processSyncDrapeSources(){this._processDrapeSources(si,t=>t.updatePolicy===1)}get isEmpty(){return!Ue.OVERLAY_DRAW_DEBUG_TEXTURE&&yt(this._renderers,t=>t.isEmpty)}get hasWater(){const t=ge(this._renderers,({hasWater:e})=>e);return t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water")),this._hasWater}renders(t){if(Ue.OVERLAY_DRAW_DEBUG_TEXTURE&&t!==4&&t!==2)return!0;if(!this._overlays)return!1;const e=this._overlays[0];for(const i of this._overlays)i.setupGeometryViews(this.longitudeCyclical);if(!e.hasSomeSizedView())return!1;const r=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find(i=>i.content===t)?.output??0,++this._techniques.precompiling;const s=this._sortedRenderers.some(({renderer:i})=>i.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.output=r,s}get mode(){return this.isEmpty?0:this.hasWater&&this.renders(3)?2:this._renderTargets?.getTexture(0)?1:0}updateAnimation(t){let e=!1;return this._renderers.forEach(r=>e=r.updateAnimation(t)||e),e&&this.parent.requestRender(0),e}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(t){if(!this._overlays||!this._renderTargets)return!1;const e=this._bindParameters;e.alignPixelEnabled=t.alignPixelEnabled,++this._techniques.precompiling;for(const r of this._renderTargets.targets){if(r.content===1&&!this._needsColorWithoutRasterImage)continue;const{output:s}=r;this._renderContext.output=s,e.slot=s===3?19:18,s===9&&(e.highlightMixTexture=e.highlights.length>1?this._rctx.emptyTexture:null);const i=this._renderContext.renderOccludedMask;r.content===4&&(this._renderContext.renderOccludedMask=Ze),this._sortedRenderers.forAll(({drapeSource:a,renderer:n})=>{r.content===1&&a.drapeSourceType===0||r.content===4&&n.hasOnlyOccluders||n.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=i,e.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(t,e){if(!this._overlays||!this._renderTargets)return;for(const s of this._overlays)s.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=t.alignPixelEnabled;const r=this.allSourcesOccluders;for(const s of this._renderTargets.targets){if(!(s.content===0&&this._hasDrapedFlowSource)&&!s.handleRenderRequest(e)||s.content===1&&!this._needsColorWithoutRasterImage||s.content===4&&r)continue;const i=this._drawTarget(0,s),a=this._drawTarget(1,s);(i||a)&&s.fbo.generateMipMap()}}_drawTarget(t,e){const r=this._overlays[t],s=r.canvasGeometries;if(s.numViews===0)return!1;const i=this._view.state.contentPixelRatio;this._screenToWorldRatio=i*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:a}=e;if(this.isEmpty||a===3&&!this.hasWater||!r.hasSomeSizedView())return!1;const{_rctx:n,_camera:o,_renderContext:l,_bindParameters:g}=this;if(o.pixelRatio=r.pixelRatio*i,l.output=a,g.screenToWorldRatio=this._screenToWorldRatio,g.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,g.slot=a===3?19:18,e.content===4&&(l.renderOccludedMask=Ze),!this.renders(e.content))return l.renderOccludedMask=ot,!1;const{resolution:d}=r,f=t===0,b=f?0:d;if(n.setViewport(b,0,d,d),this._bindTargetFBO(e),f)if(e.output!==9)n.setClearColor(0,0,0,0),n.clear(16384);else{const{gl:p}=n;p.clearBufferuiv(p.COLOR,0,[0,0,0,0])}if(Ue.OVERLAY_DRAW_DEBUG_TEXTURE&&e.content!==4&&e.content!==2){this._techniques.precompile(Bt,ht);const p=this._techniques.get(Bt,ht);for(let y=0;y<s.numViews;y++)this._setViewParameters(s.extents[y],r),this._ensureDebugPatternResources(r.resolution,ha[t]),n.bindTechnique(p,g,this._passParameters),n.screen.draw()}if(e.output===9){const{fboCache:p}=this._stage.renderer,y=this._resolution;this._bindTargetFBO(e),Ai(n,p,{width:y,height:y},g,()=>this._renderAllGeometry(t,e),b)}else this._renderAllGeometry(t,e);return n.bindFramebuffer(null),l.renderOccludedMask=ot,!0}get allSourcesOccluders(){return yt(this._renderers,t=>t.hasOnlyOccluders)}_renderAllGeometry(t,e){const r=this._overlays[t],s=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:i,renderer:a})=>{if(e.content===1&&i.drapeSourceType===0)return;const{fullOpacity:n}=i,o=n!=null&&n<1&&e.output===0&&this._bindTemporaryFBO();for(let l=0;l<s.numViews;l++)this._setViewParameters(s.extents[l],r),a.render(this._renderContext);if(o){this._bindTargetFBO(e),this._overlayParameters.texture=o.getTexture(),this._overlayParameters.opacity=n,this._overlayParameters.overlayIndex=t;const l=this._techniques.get(Ut);this._rctx.bindTechnique(l,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),o.release()}})}_bindTargetFBO(t){const e=this._resolution,r=2*e;t.fbo.ensureFramebuffer(r,e),t.fbo.bind(this._rctx)}_bindTemporaryFBO(){const t=this._resolution,e=2*t,r=this._stage.renderer.fboCache,s=r.acquire(e,t,"overlay tmp");return r.rctx.bindFramebuffer(s.fbo),r.rctx.clear(16384),s}get _resolution(){return this._overlays?.[0].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(t,e,r,s){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(const{renderer:a}of this._sortedRenderers)i=a.intersect?.(t,e,r,s,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const t=this._view.map.allLayers.map(r=>r.uid),e=t.length;this._renderers.forEach((r,s)=>{const i=t.indexOf(s.layer?.uid),a=i>=0,n=s.renderGroup??(a?0:1),o=s.drapeSourcePriorityOffset??0,l=e*n+(a?i:0)+o;this._sortedRenderers.push(new oa(s,r,l))}),this._sortedRenderers.sort((r,s)=>r.index-s.index)}_setViewParameters(t,e){const r=this._camera;r.viewport=[0,0,e.resolution,e.resolution],ms(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),vs(r.viewMatrix,[-t[0],-t[1],0])}_ensureDebugPatternResources(t,e){if(tr(this._passParameters.color,e[0],e[1],e[2]),this._passParameters.texture)return;const r=new Uint8Array(t*t*4);let s=0;for(let a=0;a<t;a++)for(let n=0;n<t;n++){const o=Math.floor(n/10),l=Math.floor(a/10);o<2||l<2||10*o>t-20||10*l>t-20?(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=255):(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=1&o&&1&l?1&n^1&a?0:255:1&o^1&l?0:128)}const i=new ar(t);i.samplingMode=9728,this._passParameters.texture=new pt(this._rctx,i,r)}get test(){}};u([v()],z.prototype,"hasHighlights",void 0),u([v()],z.prototype,"renderOccludedFlags",void 0),u([v()],z.prototype,"_sortedDrapeSourceRenderersDirty",void 0),u([v({constructOnly:!0})],z.prototype,"parent",void 0),u([v({readOnly:!0})],z.prototype,"_techniques",null),u([v({type:Boolean,readOnly:!0})],z.prototype,"updating",null),u([v()],z.prototype,"isEmpty",null),z=u([j("esri.views.3d.terrain.OverlayRenderer")],z);class oa{constructor(e,r,s){this.drapeSource=e,this.renderer=r,this.index=s}}const ha=[[1,.5,.5],[.5,.5,1]],la=-2,Ze=4,ht=new dr;ht.hasAlpha=!0;let Qn=class{constructor(e,r={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=M(),this._shaderTransformation=null,this._boundingSphere=null,this.id=ps(),this.layerViewUid=r.layerViewUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){xs(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=M(),et(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??=bs(),ws(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*$s(this.shaderTransformation)),this._boundingSphere):ys}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};class ua extends Vr{intersect(e,r,s,i,a,n){return Ir(e,s,i,a,void 0,n)}intersectDraped(e,r,s,i){return zr(s[0],s[1],e,i)}}function ca(t){const e=new Q,{vertex:r,fragment:s,attributes:i,varyings:a}=e,{hasVVColor:n,hasVertexColors:o}=t;return qr(r,t),e.include(Lr),e.include(jr,t),e.include(Ar,t),e.include(Er,t),s.include(Hr,t),e.include(Wr,t),e.include(Gr,t),i.add("position","vec3"),n&&i.add("colorFeatureAttribute","float"),o||a.add("vColor","vec4"),a.add("vpos","vec3",{invariant:!0}),r.uniforms.add(new Nr("uColor",l=>l.color)),r.main.add(I`
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${o?"vColor *= uColor;":n?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
      gl_Position = transformPosition(proj, view, vpos);`),s.include(Br),s.main.add(I`discardBySlice(vpos);
discardByTerrainDepth();
outputColorHighlightOID(vColor, vpos, vColor.rgb);`),e}const da=Object.freeze(Object.defineProperty({__proto__:null,build:ca},Symbol.toStringTag,{value:"Module"}));class ga extends B{constructor(e,r){super(e,r,new U(da,()=>k(()=>import("./Cqkb5zdc.js").then(s=>s.C),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203]),import.meta.url)),pr(r).locations)}_createPipeline(e,r){const{oitPass:s,output:i,transparent:a,cullFace:n,draped:o,hasOccludees:l,polygonOffset:g}=e,d=s===0;return G({blending:Zt(i)&&a?Zr(s):null,culling:js(n),depthTest:o?null:{func:Kr(s)},depthWrite:Jr(e),drawBuffers:Yr(i,es(s,i)),colorWrite:N,stencilWrite:l?Xr:null,stencilTest:l?r?kr:Qr:null,polygonOffset:d?g?pa:null:Ur(e)})}initializePipeline(e){return this._occludeePipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}const pa={factor:1,units:1};function pr(t){const e=he().vec3f("position");return Qt()&&e.vec4u8("olidColor"),t.hasVVColor?e.f32("colorFeatureAttribute"):e.vec4u8("color"),e.freeze()}let R=class extends ts{constructor(){super(...arguments),this.cullFace=0,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.snowCover=!1}};u([P({count:3})],R.prototype,"cullFace",void 0),u([P()],R.prototype,"hasVertexColors",void 0),u([P()],R.prototype,"transparent",void 0),u([P()],R.prototype,"discardInvisibleFragments",void 0),u([P()],R.prototype,"polygonOffset",void 0),u([P()],R.prototype,"enableOffset",void 0),u([P()],R.prototype,"writeDepth",void 0),u([P()],R.prototype,"hasOccludees",void 0),u([P()],R.prototype,"terrainDepthTest",void 0),u([P()],R.prototype,"cullAboveTerrain",void 0),u([P()],R.prototype,"hasVVColor",void 0),u([P()],R.prototype,"draped",void 0);class Jn extends ua{constructor(e){super(e,_a),this._configuration=new R,this.supportsEdges=!0,this.produces=new Map([[2,r=>this._isOpaqueMaterialPass(r)],[3,r=>this._isOpaqueNoSSAODepthPass(r)],[4,r=>ke(r)&&this._transparent&&this.parameters.writeDepth],[5,r=>xt(r)&&this._transparent&&this.parameters.writeDepth],[8,r=>ke(r)&&this._transparent&&!this.parameters.writeDepth],[18,r=>rs(r)]])}getConfiguration(e,r){return super.getConfiguration(e,r,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=r.hasOccludees,this._configuration.oitPass=r.oitPass,this._configuration.enableOffset=r.camera.relativeElevation<ss,this._configuration.terrainDepthTest=r.terrainDepthTest&&Zt(e),this._configuration.cullAboveTerrain=r.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=is}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return e===9||ke(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return xt(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new fa(e)}createBufferWriter(){return new as(pr(this.parameters))}}class fa extends os{beginSlot(e){return this.getTechnique(ga,e)}}class _a extends ns{constructor(){super(...arguments),this.color=wr,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.draped=!1,this.discardInvisibleFragments=!1}}const w={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},ma={dash:w.dash,"dash-dot":[...w.dash,...w.dot],dot:w.dot,"long-dash":w["long-dash"],"long-dash-dot":[...w["long-dash"],...w.dot],"long-dash-dot-dot":[...w["long-dash"],...w.dot,...w.dot],none:null,"short-dash":w["short-dash"],"short-dash-dot":[...w["short-dash"],...w["short-dot"]],"short-dash-dot-dot":[...w["short-dash"],...w["short-dot"],...w["short-dot"]],"short-dot":w["short-dot"],solid:null},va=8;function xa(t,e){return t==null?t:{pattern:t.slice(),pixelRatio:e}}function Kn(t){return{pattern:[t,t],pixelRatio:2}}function Zn(t){return t?.type==="style"?ya(t.style):null}function ya(t){return t!=null?xa(ma[t],va):null}function eo(t,e,r,s){const i=t.type==="polygon"?1:0,a=t.type==="polygon"?t.rings:t.paths,{position:n,outlines:o}=ir(a,!!t.hasZ,i,t.spatialReference),l=kt(n.length),g=Ws(n,t.spatialReference,0,l,0,n,0,n.length/3,e,r,s),d=g!=null;return{lines:d?fr(o,n,l):[],projectionSuccess:d,sampledElevation:g}}function to(t,e){const r=t.type==="polygon"?1:0,s=t.type==="polygon"?t.rings:t.paths,{position:i,outlines:a}=ir(s,!1,r),n=Tr(i,t.spatialReference,0,i,e,0);for(let o=2;o<i.length;o+=3)i[o]=la;return{lines:n?fr(a,i):[],projectionSuccess:n}}function fr(t,e,r=null){const s=new Array;for(const{index:i,count:a}of t){if(a<=1)continue;const n=3*i,o=3*a;s.push({position:vt(e,3*i,3*a),mapPositions:r!=null?vt(r,n,o):void 0})}return s}const ro=he().vec3f("position").freeze(),so=he().vec3f("position").vec2f16("uv0").freeze(),io=he().vec3f("position").vec4u8("color").freeze(),ao=he().vec3f("position").vec2f("uv0").freeze(),no=he().vec3f("position").vec2f("uv0").vec4u8("olidColor").freeze();export{bi as A,la as B,gr as C,aa as D,ca as E,Ln as a,ao as b,no as c,Kn as d,so as e,gn as f,Oi as g,Qn as h,ua as i,ur as j,Ri as k,hr as l,Jn as m,Zn as n,ro as o,to as p,lr as q,mi as r,eo as s,Ti as t,$n as u,io as v,W as w,qe as x,Mi as y,nr as z};
