import{c as _,_ as h,m as p,a as u}from"./ChMEnlEh.js";import{a as r}from"./B2reeZpr.js";import{watch as o,when as m,on as c,sync as g}from"./Bvm6lAc7.js";import{A as H}from"./D8DYOP_H.js";let l=class extends _{constructor(){super(...arguments),this.updating=!1,this._handleId=0,this._scheduleHandleId=0,this._pendingPromises=new Set}destroy(){this.removeAll()}add(e,s,t={}){return this._installWatch(e,s,t,o)}addWhen(e,s,t={}){return this._installWatch(e,s,t,m)}addOnCollectionChange(e,s,{initial:t=!1,final:a=!1}={}){const n=++this._handleId;return this.addHandles([c(e,"after-changes",this._createSyncUpdatingCallback(),g),c(e,"change",s,{onListenerAdd:t?d=>s({added:d.toArray(),removed:[]}):void 0,onListenerRemove:a?d=>s({added:[],removed:d.toArray()}):void 0})],n),r(()=>this.removeHandles(n))}addPromise(e){if(e==null)return e;const s=++this._handleId;this.addHandles(r(()=>{this._pendingPromises.delete(e)&&(this._pendingPromises.size!==0||this.hasHandles(i)||this._set("updating",!1))}),s),this._pendingPromises.add(e),this._set("updating",!0);const t=()=>this.removeHandles(s);return e.then(t,t),e}removeAll(){this._pendingPromises.clear(),this.removeAllHandles(),this._set("updating",!1)}_installWatch(e,s,t={},a){const n=++this._handleId;t.sync||this._installSyncUpdatingWatch(e,n);const d=a(e,s,t);return this.addHandles(d,n),r(()=>this.removeHandles(n))}_installSyncUpdatingWatch(e,s){const t=this._createSyncUpdatingCallback(),a=o(e,t,{sync:!0,equals:()=>!1});return this.addHandles(a,s),a}_createSyncUpdatingCallback(){return()=>{this.removeHandles(i),++this._scheduleHandleId;const e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this.addHandles(H(()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this.removeHandles(i))}),i)}}};h([p({readOnly:!0})],l.prototype,"updating",void 0),l=h([u("esri.core.support.UpdatingHandles")],l);const i=-42;export{l as h};
