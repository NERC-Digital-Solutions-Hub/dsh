const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CN-5qGxU.js","./B5jfOAyC.js","./DsnmJJEf.js","./qhGSfr8s.js","./CYgEQTyb.js","./CUmkdNFk.js","./BfrHREwz.js","./DwntN76J.js","./tQNujLrX.js","./D7vOUhHr.js","./CSLnW4Ur.js","./laJq_Y7H.js","../assets/4.BILSy67e.css","./C56ZiKiC.js","./IsMQoFqb.js","./G2z5ln8o.js","./370ddt8N.js","./BJ84funn.js","./kfWM0w4U.js","./C2Yj7m4f.js","./DDx-Un6v.js","./BR4wCaQn.js"])))=>i.map(i=>d[i]);
import{_ as N}from"./D7vOUhHr.js";import{f as B,s as f,I as H}from"./B5jfOAyC.js";import{a as U}from"./CRQLIJ7A.js";import{j as y}from"./BeCrDXwC.js";import{i as F}from"./C3hpUfwZ.js";import{s as K,$ as J,H as z,aY as q}from"./IsMQoFqb.js";import{x as $,k as Y}from"./BMtnoABP.js";import{k as Q,C as X}from"./C56ZiKiC.js";import{o as Z}from"./C9pWAOut.js";import{c as n,E as d,i as p,s as m,u as ee}from"./1qG396Hh.js";import{p as ae,n as te}from"./G2z5ln8o.js";import{d as oe,m as re,b as ie}from"./B6VklA3h.js";import{p as A}from"./tHkGkAX9.js";import{o as I,s as P,n as ne}from"./BZvlrK2_.js";const se=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((a=>a.toLowerCase()));async function qe(a,e,t){t??={},le(a,e),await y((()=>!e.updatingFromView)),await e.load(),await C(e),await I(e),await S(a,e);const o=e.portalItem,{json:r,jsonContext:i}=await T(e,o,a.origin);return P(i,{errorName:`${a.name}:save`},t),await k(e,o),await Ce(a,e,o,r,i),await Promise.all([e.updateItemThumbnail(),A(e.resourceReferences,i)]),o}async function T(a,e,t){const o=Z(e,t,!0),r=a.write({},o);return await Promise.all(o.resources.pendingOperations),{json:r,jsonContext:o}}async function Ye(a,e,t,o){o??={};const r=pe(a,t);await y((()=>!e.updatingFromView)),await e.load(),await C(e),await I(e),await S(a,e);const{json:i,jsonContext:s}=await T(e,r,a.origin);P(s,{errorName:`${a.name}:save`},o),await fe(e,r);const l=e.getThumbnailState();return await ke(a,e,r,i,s,o)&&(e.resourceReferences.portalItem=r),e.restoreThumbnailFromState(l),await Promise.all([e.updateItemThumbnail(),A(e.resourceReferences,s)]),r}function le(a,e){if(!e.portalItem)throw new f(`${a.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");O(a,e.portalItem)}function O(a,e){if(e.type!==a.itemType)throw new f(`${a.name}:portal-item-wrong-type`,`Portal item needs to have type "${a.itemType}"`)}async function S(a,e){if(a.name==="linkchart")return;if(!e.basemap?.baseLayers.length)throw new f(`${a.name}:save`,"Map does not have a valid basemap with a base layer.");let t=null;if(await y((()=>{const o=oe(e.initialViewProperties,e.basemap);return t=o.spatialReference,!o.updating})),!K(t,e.initialViewProperties.spatialReference))throw new f(`${a.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:t})}function pe(a,e){let t=Q.from(e);return t.id&&(t=t.clone(),t.id=null),t.type||(t.type=a.itemType),t.portal||(t.portal=X.getDefault()),O(a,t),t}function C(a){const e=[];return a.basemap&&e.push(a.basemap.load()),a.ground&&e.push(a.ground.load()),Promise.allSettled(e).then((()=>{}))}async function k(a,e){e.extent=await $e(a.portalItem,a.initialViewProperties.viewpoint.targetGeometry),await de(a,e)}const ce=d.JSAPI,E="CollectorDisabled",_="Collector",g="Data Editing",D="OfflineDisabled",b="Offline",V="Workforce Project",M="Workforce Worker",x="Workforce Dispatcher",ue="Offline Map Areas",me="FieldMapsDisabled",R=d.DEVELOPER_BASEMAP,v="UtilityNetwork",W="IPS";async function fe(a,e){n(e,E),n(e,me),n(e,d.METADATA),n(e,D),n(e,ue),n(e,x),n(e,V),n(e,M),await k(a,e)}async function de(a,e){p(e,ce),await we(a),he(a,e),_e(a,e),ge(a,e),be(a,e),Re(a,e),ve(a,e),We(a,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((t,o,r)=>r.indexOf(t)===o)))}function we(a){const e=h(a).map((t=>t.load())).toArray();return Promise.allSettled(e).then((()=>{}))}function h(a){return a.allLayers.concat(a.allTables)}function j(a){return h(a).some((e=>e.loaded&&$(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!=="subtype-group"||e.sublayers.some((t=>t.editingEnabled)))))}function ye(a){return h(a).filter((e=>e.type!=="group")).every((e=>e.loaded&&Pe(a,e)))}function he(a,e){m(e,E)||m(e,V)||m(e,M)||m(e,x)||!j(a)?n(e,_):p(e,_)}function _e(a,e){j(a)?p(e,g):n(e,g)}function ge(a,e){!m(e,D)&&ye(a)?p(e,b):n(e,b)}function be(a,e){re(a.basemap)?p(e,R):n(e,R)}function Re(a,e){a.utilityNetworks?.length?p(e,v):n(e,v)}function ve(a,e){a.ipsInfo?p(e,W):n(e,W)}function We(a,e){ee(e,d.CHARTS,ne(a))}async function $e(a,e){const t=e.clone().normalize();let o;if(t.length>1)for(const r of t)o?r.width>o.width&&(o=r):o=r;else o=t[0];return Ae(a,o)}async function Ae(a,e){const t=e.spatialReference;if(t.isWGS84)return e.clone();if(t.isWebMercator)return J(e);const{getGeometryServiceURL:o}=await N(()=>import("./CN-5qGxU.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21]),import.meta.url),r=await o(a),i=new ae({geometries:[e],outSpatialReference:z.WGS84});return(await te(r,i))[0]}function Ie(a){return Y(a)||a.type==="map-notes"||a.type==="route"}function Pe(a,e){return $(e)&&e.capabilities.operations.supportsSync||Ie(e)&&!e.portalItem||Te(e)&&!Oe(e)&&e.spatialReference.equals(a.initialViewProperties.spatialReference)}function Te(a){return(a.type==="tile"||a.type==="vector-tile")&&(a.capabilities.operations.supportsExportTiles||Se(a)||ie(a))}function Oe(a){return a.type==="vector-tile"&&Object.keys(a.sourceNameToSource).length>1}function Se(a){return a.type==="tile"&&q(a.url)&&se.some((e=>a.url?.toLowerCase().includes("/"+e+"/")))}async function Ce(a,e,t,o,r){await t.update({data:o}),G(a,e,t,o,r)}async function ke(a,e,t,o,r,i){const s=e.portalItem,l={item:s,authenticated:!(!s?.id||!s.portal.user)},c=t.portal;await c.signIn();const{copyAllowed:u,itemReloaded:w}=await Ee(l,c);if(l.authenticated||=w,!u)throw new f(`${a.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const L=await De(t,l,o,i);return e.portalItem=t,G(a,e,t,o,r),L}async function Ee(a,e){const{item:t,authenticated:o}=a;return t?.id&&t.typeKeywords?.includes("useOnly")?t.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await t.reload(),{copyAllowed:t.itemControl==="admin"||t.itemControl==="update",itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function De(a,e,t,o){const r=a.portal,{item:i}=e,{folder:s,copyAllResources:l}=o;let c=!1;if(l&&i?.id&&B(i.portal.url,r.url)&&parseInt(i.portal.currentVersion,10)>=2023){const{total:u}=await i.fetchResources();c=!!u}if(c){const u=await i.copy({copyResources:"all",folder:s});a.id=u.id,a.portal=u.portal;const w=a.toJSON();await a.load(),a.read(w),await a.update({data:t})}else await r.user.addItem({item:a,folder:s,data:t});return c}function G(a,e,t,o,r){U.prototype.read.call(e,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:a.origin,ignoreDefaults:!0,url:t.itemUrl?H(t.itemUrl):void 0}),F(r),e.resourceInfo=o}export{T as createJSON,De as initializeNewItem,Ee as isCopyAllowed,qe as save,Ye as saveAs};
