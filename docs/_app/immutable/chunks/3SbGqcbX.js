import{c as ee,n as G,Q as te,_ as i,m as n,a as I,g as se,aD as le,w as ie,r as P,b as k}from"./CDGqq53N.js";import{s as A,i as m}from"./C9_KfL0q.js";import{N as re,b as oe,a as v,K as ne}from"./BzZgUCJc.js";import{a as N}from"./D1sKJjB8.js";import{O as Q,H as ue,E as ae,m as fe}from"./Cad-p0g1.js";import{r as Z}from"./CicY3o9G.js";import{y as pe}from"./OuCfdC0r.js";import{aM as de,n as H,aH as ce,aN as R,aO as he}from"./CPwmGbun.js";import{M as x,p as ye}from"./C3oh_tnt.js";import{c as D,y as W,m as me,v as ve,a as be,n as ge}from"./CWMNWfLw.js";import{l as E}from"./NEmuse4e.js";import{R as _e,K as Ve}from"./COT3swUQ.js";var L;const qe=ee()({ascendingValues:"ascending-values",descendingValues:"descending-values"});let O=L=class extends E(G){static from(e){return te(L,e)}constructor(e){super(e),this.title=null,this.order=null}};i([n({type:String,json:{write:!0}})],O.prototype,"title",void 0),i([Z(qe)],O.prototype,"order",void 0),O=L=i([I("esri.renderers.support.RendererLegendOptions")],O);const we=O;let c=class extends E(G){constructor(t){super(t),this.value=null,this.value2=null,this.value3=null}};i([n(D)],c.prototype,"value",void 0),i([n(D)],c.prototype,"value2",void 0),i([n(D)],c.prototype,"value3",void 0),c=i([I("esri.renderers.support.UniqueValue")],c);let h=class extends E(G){constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.values=null}castValues(t){if(t==null)return null;const s=typeof(t=Array.isArray(t)?t:[t])[0];return s==="string"||s==="number"?t.map(l=>new c({value:l})):s==="object"?t[0]instanceof c?t:t.map(l=>new c(l)):null}};i([n({type:String,json:{write:!0}})],h.prototype,"description",void 0),i([n({type:String,json:{write:!0}})],h.prototype,"label",void 0),i([n(W)],h.prototype,"symbol",void 0),i([n({type:[c],json:{type:[[String]],read:{reader:e=>e?e.map(t=>new c({value:t[0],value2:t[1],value3:t[2]})):null},write:{writer:(e,t)=>{const s=[];for(const l of e){const r=[l.value,l.value2,l.value3].filter(re).map(o=>o.toString());s.push(r)}t.values=s}}}})],h.prototype,"values",void 0),i([Q("values")],h.prototype,"castValues",null),h=i([I("esri.renderers.support.UniqueValueClass")],h);let _=class extends E(G){constructor(t){super(t),this.heading=null,this.classes=null}};i([n({type:String,json:{write:!0}})],_.prototype,"heading",void 0),i([n({type:[h],json:{write:{isRequired:!0}}})],_.prototype,"classes",void 0),_=i([I("esri.renderers.support.UniqueValueGroup")],_);var C;let d=C=class extends G{constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.value=null}clone(){return new C({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol?.toJSON());return`${this.value}.${e}`}};i([n({type:String,json:{write:!0}})],d.prototype,"description",void 0),i([n({type:String,json:{write:!0}})],d.prototype,"label",void 0),i([n(me)],d.prototype,"symbol",void 0),i([n(D)],d.prototype,"value",void 0),d=C=i([I("esri.renderers.support.UniqueValueInfo")],d);const z=new Map;async function Ie(e,t){try{return{data:(await Oe(e,t)).data,baseUrl:_e(e),styleUrl:e}}catch(s){return se(s),null}}function Se(e,t,s){const l=t.portal!=null?t.portal:x.getDefault();let r;const o=`${l.url} - ${l.user?.username} - ${e}`,u=z.get(o);if(u)return u;const p=Ue(e,l,s).then(f=>(r=f,f.fetchData())).then(f=>({data:f,baseUrl:r.itemUrl??"",styleName:e}));return z.set(o,p),p}function Ue(e,t,s){return t.load(s).then(()=>{const l=new ye({disableExtraQuery:!0,query:`owner:${J} AND type:${T} AND typekeywords:"${e}"`});return t.queryItems(l,s)}).then(({results:l})=>{let r=null;const o=e.toLowerCase();if(l&&Array.isArray(l)){for(const u of l)if(u.typeKeywords?.some(f=>f.toLowerCase()===o)&&u.type===T&&u.owner===J){r=u;break}}if(!r)throw new A("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return r.load(s)})}function $e(e,t,s){return e?.styleUrl!=null?Ie(e.styleUrl,s):e?.styleName!=null?Se(e.styleName,t,s):Promise.reject(new A("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function Be(e){return e===null||e.type==="CIMSymbolReference"?e:{type:"CIMSymbolReference",symbol:e}}function Ke(e,t){for(const s of t)switch(s){case"cim":if(e.cimRef)return{format:s,url:encodeURI(e.cimRef)};break;case"web-gltf-basisu":{const l=M(e,"gltf_basisu");if(l)return{format:s,url:l};break}case"web-gltf":{const l=M(e,"gltf");if(l)return{format:s,url:l};break}case"web":{const l=M(e,"gltf");if(l)return{format:"web-gltf",url:l};if(e.webRef)return{format:s,url:encodeURI(e.webRef)};break}}}function M(e,t){if(!oe("enable-feature:force-wosr"))return e.formatInfos?.find(s=>s.type===t)?.href}function Oe(e,t){const s={responseType:"json",query:{f:"json"},...t};return ue(Ve(e),s)}const J="esri_en",T="Style",Qe="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var F;const B="uvInfos-watcher",K="uvGroups-watcher",Fe=",",Ge=ie(d);function je(e){const{field1:t,field2:s,field3:l,fieldDelimiter:r,uniqueValueInfos:o,valueExpression:u}=e,p=!(!t||!s);return[{classes:(o??[]).map(f=>{const{symbol:b,label:g,value:V,description:q}=f,[S,U,$]=p?V?.toString()?.split(r||"")||[]:[V],y=[];return(t||u)&&y.push(S),s&&y.push(U),l&&y.push($),{symbol:b,label:g,values:[y],description:q}})}]}function w(e){return e!=null&&e!==""&&(typeof e!="string"||e.trim()!==""&&e.toLowerCase()!=="<null>")||(e=null),e+""}let a=F=class extends ve(be){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this._isInfosSource=null,this.type="unique-value",this.backgroundFillSymbol=null,this.orderByClassesEnabled=!1,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(t,s){if(!t&&!s)return;if(!t||!s)return{type:"complete",oldValue:t,newValue:s};let l=!1;const r={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let o=0;o<s.length;o++){const u=t.find(p=>p.value===s[o].value);u?pe(u,s[o])?(r.changed.push({type:"complete",oldValue:u,newValue:s[o]}),l=!0):r.unchanged.push({oldValue:u,newValue:s[o]}):(r.added.push(s[o]),l=!0)}for(let o=0;o<t.length;o++)s.find(u=>u.value===t[o].value)||(r.removed.push(t[o]),l=!0);return l?r:void 0}},this._set("uniqueValueInfos",[]),this._set("uniqueValueGroups",[])}get _cache(){return{compiledFunc:null}}set field(e){this._set("field",e),this._updateFieldDelimiter(),this._updateUniqueValues()}castField(e){return e==null||typeof e=="function"?e:le(e)}writeField(e,t,s,l){typeof e=="string"?t[s]=e:l?.messages?l.messages.push(new A("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):m.getLogger(this).error(".field: cannot write field to JSON since it's not a string value")}set field2(e){this._set("field2",e),this._updateFieldDelimiter(),this._updateUniqueValues()}set field3(e){this._set("field3",e),this._updateUniqueValues()}set valueExpression(e){this._set("valueExpression",e),this._updateUniqueValues()}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}set fieldDelimiter(e){this._set("fieldDelimiter",e),this._updateUniqueValues()}readPortal(e,t,s){return s.portal||x.getDefault()}readStyleOrigin(e,t,s){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const l=ae(t.styleUrl,s);return Object.freeze({styleUrl:l})}}writeStyleOrigin(e,t,s,l){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=fe(e.styleUrl,l))}set uniqueValueGroups(e){this.styleOrigin?m.getLogger(this).error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",e),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}set uniqueValueInfos(e){this.styleOrigin?m.getLogger(this).error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}addUniqueValueInfo(e,t){if(this.styleOrigin)return void m.getLogger(this).error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let s;s=typeof e=="object"?Ge(e):new d({value:e,symbol:de(t)}),this.uniqueValueInfos?.push(s),this._valueInfoMap[w(s.value)]=s,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}removeUniqueValueInfo(e){if(this.styleOrigin)return void m.getLogger(this).error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const t=this.uniqueValueInfos;if(t)for(let s=0;s<t.length;s++){const l=t[s];if(String(l.value)===String(e)){delete this._valueInfoMap[w(e)],t.splice(s,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}async getUniqueValueInfo(e,t){let s=t;return this.valueExpression&&t?.arcade==null&&(s={...s,arcade:await H()}),this._getUniqueValueInfo(e,s)}getSymbol(e,t){return this.valueExpression&&t?.arcade==null?void m.getLogger(this).error("#getSymbol()","Please use getSymbolAsync if valueExpression is used"):this._getUniqueValueInfo(e,t)?.symbol||this.defaultSymbol}async getSymbolAsync(e,t){let s=t;if(this.valueExpression&&s?.arcade==null){const r=await H(),{arcadeUtils:o}=r;o.hasGeometryOperations(this.valueExpression)&&await o.enableGeometryOperations(),s={...s,arcade:r}}return this._getUniqueValueInfo(e,s)?.symbol||this.defaultSymbol}get symbols(){const e=[];if(this._isInfosSource)for(const t of this.uniqueValueInfos??[])t.symbol&&e.push(t.symbol);else for(const t of this.uniqueValueGroups??[])for(const s of t.classes??[])s.symbol&&e.push(s.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables?.reduce((e,t)=>e+t.getAttributeHash(),"")??""}getMeshHash(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=this.uniqueValueInfos?.reduce((l,r)=>l+r.getMeshHash(),"");return`${e}.${t}.${s}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const e=new F({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:v(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:v(this.visualVariables),legendOptions:v(this.legendOptions),authoringInfo:v(this.authoringInfo),backgroundFillSymbol:v(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=v(this.uniqueValueInfos),s=v(this.uniqueValueGroups);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(v(this.styleOrigin))),Object.freeze(t),Object.freeze(s)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e._set("uniqueValueGroups",s),e._isInfosSource=this._isInfosSource,e._watchUniqueValueInfosAndGroups(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(s)}async collectSymbolFields(e,t){const s=[...this.symbols.map(l=>l.collectRequiredFields(e,t)),ce(e,t,null,this.valueExpression)];R(e,t,this.field),R(e,t,this.field2),R(e,t,this.field3),await Promise.all(s)}populateFromStyle(){return $e(this.styleOrigin,{portal:this.portal}).then(e=>{const t=[];return this._valueInfoMap={},e?.data&&Array.isArray(e.data.items)&&e.data.items.forEach(s=>{const l=new he({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:s.name});this.defaultSymbol||s.name!==e.data.defaultItem||(this.defaultSymbol=l,this._isDefaultSymbolDerived=!0);const r=new d({value:s.name,symbol:l});t.push(r),this._valueInfoMap[w(s.name)]=r}),this._set("uniqueValueInfos",Object.freeze(t)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&this.uniqueValueInfos?.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateFieldDelimiter(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",Fe)}_updateUniqueValues(){this._isInfosSource!=null&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())}_updateValueInfoMap(){this._valueInfoMap={};const{uniqueValueInfos:e}=this;if(e)for(const t of e)this._valueInfoMap[w(t.value)]=t}_watchUniqueValueInfosAndGroups(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()}_watchUniqueValueInfos(){this.removeHandles(B);const{uniqueValueInfos:e}=this;if(e){const t=[];for(const s of e)t.push(N(()=>({symbol:s.symbol,value:s.value,label:s.label,description:s.description}),(l,r)=>{l!==r&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(t,B)}}_watchUniqueValueGroups(){this.removeHandles(K);const{uniqueValueGroups:e}=this;if(e){const t=[];for(const s of e){t.push(N(()=>({classes:s.classes}),(l,r)=>{l!==r&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(const l of s.classes??[])t.push(N(()=>({symbol:l.symbol,values:l.values,label:l.label,description:l.description}),(r,o)=>{r!==o&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(t,K)}}_updateInfosFromGroups(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const e=[],{field:t,field2:s,field3:l,fieldDelimiter:r,uniqueValueGroups:o,valueExpression:u}=this;if(!t&&!u)return this._set("uniqueValueInfos",e),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const p=!(!t||!s);for(const f of o)for(const b of f.classes??[]){const{symbol:g,label:V,values:q,description:S}=b;for(const U of q??[]){const{value:$,value2:y,value3:X}=U,j=[$];s&&j.push(y),l&&j.push(X);const Y=p?j.join(r||""):j[0]??void 0;e.push(new d({symbol:g,label:V,value:Y,description:S}))}}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos()}_updateGroupsFromInfos(e=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:t,field2:s,valueExpression:l,fieldDelimiter:r,uniqueValueInfos:o}=this;if(!t&&!l||!o.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const u=!(!t||!s),p=o.map(b=>{const{symbol:g,label:V,value:q,description:S}=b,[U,$,y]=u?q?.toString()?.split(r||"")||[]:[q];return new h({symbol:g,label:V,description:S,values:[new c({value:U,value2:$,value3:y})]})}),f=[new _({classes:p})];e&&Object.freeze(f),this._set("uniqueValueGroups",f),this._watchUniqueValueGroups()}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){const{viewingMode:s,scale:l,spatialReference:r,arcade:o,timeZone:u}=t??{};let p=this._cache.compiledFunc;const f=o.arcadeUtils;if(!p){const g=f.createSyntaxTree(this.valueExpression);p=f.createFunction(g),this._cache.compiledFunc=p}const b=f.executeFunction(p,f.createExecContext(e,f.getViewInfo({viewingMode:s,scale:l,spatialReference:r}),u));return this._valueInfoMap[w(b)]}_getUnqiueValueInfoForFields(e){const t=this.field,s=e.attributes;let l;if(this.field2){const r=this.field2,o=this.field3,u=[];t&&u.push(s[t]),r&&u.push(s[r]),o&&u.push(s[o]),l=u.join(this.fieldDelimiter||"")}else t&&(l=s[t]);return this._valueInfoMap[w(l)]}static fromPortalStyle(e,t){const s=new F(t?.properties);s._set("styleOrigin",Object.freeze({styleName:e})),s._set("portal",t?.portal||x.getDefault());const l=s.populateFromStyle();return l.catch(r=>{m.getLogger(this.prototype).error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",r)}),l}static fromStyleUrl(e,t){const s=new F(t?.properties);s._set("styleOrigin",Object.freeze({styleUrl:e}));const l=s.populateFromStyle();return l.catch(r=>{m.getLogger(this.prototype).error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",r)}),l}};i([n({readOnly:!0})],a.prototype,"_cache",null),i([Z({uniqueValue:"unique-value"})],a.prototype,"type",void 0),i([n(ge)],a.prototype,"backgroundFillSymbol",void 0),i([n({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],a.prototype,"field",null),i([Q("field")],a.prototype,"castField",null),i([P("field")],a.prototype,"writeField",null),i([n({type:String,value:null,json:{write:!0}})],a.prototype,"field2",null),i([n({type:String,value:null,json:{write:!0}})],a.prototype,"field3",null),i([n({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],a.prototype,"orderByClassesEnabled",void 0),i([n({type:String,value:null,json:{write:!0}})],a.prototype,"valueExpression",null),i([n({type:String,json:{write:!0}})],a.prototype,"valueExpressionTitle",void 0),i([n({type:we,json:{write:!0}})],a.prototype,"legendOptions",void 0),i([n({type:String,json:{write:!0}})],a.prototype,"defaultLabel",void 0),i([n(ne({...W},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],a.prototype,"defaultSymbol",null),i([n({type:String,value:null,json:{write:!0}})],a.prototype,"fieldDelimiter",null),i([n({type:x,readOnly:!0})],a.prototype,"portal",void 0),i([k("portal",["styleName"])],a.prototype,"readPortal",null),i([n({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],a.prototype,"styleOrigin",void 0),i([k("styleOrigin",["styleName","styleUrl"])],a.prototype,"readStyleOrigin",null),i([P("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],a.prototype,"writeStyleOrigin",null),i([n({type:[_],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(e,t,s)=>(t.uniqueValueGroups||je(t)).map(l=>_.fromJSON(l,s))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],a.prototype,"uniqueValueGroups",null),i([n({type:[d],json:{read:!1,write:{isRequired:!0,overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0,isRequired:!0}}}}})],a.prototype,"uniqueValueInfos",null),a=F=i([I("esri.renderers.UniqueValueRenderer")],a);export{a as $,d as a,we as d,Qe as h,$e as i,Be as m,Oe as p,Ke as y};
