import"./DsnmJJEf.js";import{d as m,r as A,f as L,s as h,aA as I,g as u,b as f,aK as b,w as H}from"./Dg8B37cN.js";import{f as g,a as V,c as F}from"./Lqxt2u0_.js";import{s as M}from"./B3syFVNQ.js";import{i as j}from"./DX-cJOE_.js";import{S as k}from"./Kyo2J1YB.js";import"./BzZgUCJc.js";import"./C9_KfL0q.js";import"./CDGqq53N.js";import"./bnayRBMH.js";import"./BcU1P1CV.js";import"./BkaRJQOf.js";import"./CPwmGbun.js";import"./CY1ScL2v.js";import{S as y}from"./BZOnCu_P.js";import{S as p}from"./pSJ29C-C.js";var _=g('<div class="min-w-0 space-y-2 overflow-hidden"><!></div>'),N=g('<div class="w-full flex-1 overflow-hidden pr-1.5 pl-1.5"><!></div>');function U(S,e){var t=N(),a=m(t);k(a,{class:"h-full w-full",children:(r,s)=>{var n=_(),o=m(n);{var l=c=>{var i=F(),d=L(i);M(d,()=>e.children),V(c,i)};j(o,c=>{e.children&&c(l)})}A(n),V(r,n)},$$slots:{default:!0}}),A(t),V(S,t)}class W{#e;constructor(e){this.#e=e}async getLayerView(e){return this.#e.whenLayerView(e)}async getLayerViewById(e){const t=this.#e.map?.findLayerById(e);if(t)return this.getLayerView(t)}}class X{areaSelectionStore;layerViewProvider;#e=h(I({layerView:null,areaHandles:new y}));get selectionViewState(){return u(this.#e)}set selectionViewState(e){f(this.#e,e,!0)}#t=h(null);get lastAddedArea(){return u(this.#t)}set lastAddedArea(e){f(this.#t,e,!0)}#r=h(null);get lastRemovedArea(){return u(this.#r)}set lastRemovedArea(e){f(this.#r,e,!0)}#i=h(null);get currentHoveredArea(){return u(this.#i)}set currentHoveredArea(e){f(this.#i,e,!0)}fieldInfos=[];cachedNames=new y;constructor(e,t){this.areaSelectionStore=e,this.layerViewProvider=t,b(()=>{H(()=>{this.refreshLayerView()}),H(()=>{this.refreshAreas()})})}async refreshLayerView(){if(!this.areaSelectionStore.layerId&&this.selectionViewState.layerView!==null){this.resetSelectedLayerView();return}if(this.selectionViewState.layerView?.layer?.id===this.areaSelectionStore.layerId||!this.areaSelectionStore.layerId)return;const e=await this.layerViewProvider.getLayerViewById(this.areaSelectionStore.layerId);e&&this.setSelectedLayerView(e)}async refreshAreas(){const e=this.selectionViewState.layerView;if(!e){this.resetSelectedAreas();return}const t=this.areaSelectionStore.selectedAreaIds,a=this.selectionViewState.areaHandles;for(const r of a.keys())t.has(r)||this.removeSelectedArea(r);for(const r of t){if(a.has(r))continue;const s=e.highlight(r,{name:"selected"});s&&this.addSelectedArea(r,s)}}setFieldInfos(e){this.fieldInfos=e}setSelectedLayerView(e){this.selectionViewState?.layerView!==e&&(this.selectionViewState={layerView:e,areaHandles:new y},this.resetSelectedAreas())}clearSelectedLayerView(){this.selectionViewState.layerView!==null&&(this.resetSelectedAreas(),this.selectionViewState.layerView=null)}resetSelectedLayerView(){this.selectionViewState={layerView:null,areaHandles:new y},this.resetSelectedAreas()}resetSelectedAreas(){!this.selectionViewState.layerView&&this.selectionViewState.areaHandles.size===0||(this.selectionViewState.areaHandles.values().forEach(e=>{e.remove()}),this.selectionViewState.areaHandles.clear(),this.lastAddedArea=null,this.lastRemovedArea=null,this.currentHoveredArea=null)}addSelectedArea(e,t){if(!this.selectionViewState){console.warn("SelectedAreasStore: No feature layer view is set.");return}const a={id:e,handle:t};this.lastAddedArea=a,this.selectionViewState.areaHandles.set(e,t),this.areaSelectionStore.addSelectedArea(e)}removeSelectedArea(e){if(!this.selectionViewState){console.warn("[area-selection-interaction-store] no feature layer view is set.");return}const t=this.selectionViewState.areaHandles.get(e);if(!t){console.warn(`[area-selection-interaction-store] no handle found for area ID ${e}.`);return}this.lastRemovedArea={id:e,handle:t},t.remove(),this.selectionViewState.areaHandles.delete(e),this.areaSelectionStore.removeSelectedArea(e)}async getAreaNamesById(e){if(!this.selectionViewState?.layerView)return[];const t=this.getNameFieldForCurrentLayer();if(!t)return[];const a=this.selectionViewState.layerView.layer;let r=this.cachedNames.get(a.uid);r||(r=new y,this.cachedNames.set(a.uid,r));const s=new Array(e.length),n=new y,o=[];if(e.forEach((i,d)=>{n.set(i,d);const w=r.get(i);w!==void 0?s[d]=w:o.push(i)}),o.length===0)return s.map(i=>i??"");const l=a.objectIdField,c=await a.queryFeatures({objectIds:o,outFields:[t,l],returnGeometry:!1});for(const i of c.features){const d=i.attributes[l],w=i.attributes[t],v=n.get(d);v!==void 0&&(s[v]=w??"",r.set(d,w??""))}return s.map(i=>i??"")}async getAreaCodesById(e){if(!this.selectionViewState?.layerView)return[];const t=this.getCodeFieldForCurrentLayer();if(!t)return[];const a=this.selectionViewState.layerView.layer,r=a.objectIdField,s=await a.queryFeatures({objectIds:e,outFields:[t,r],returnGeometry:!1}),n=new Array(e.length);for(const o of s.features){const l=o.attributes[r],c=o.attributes[t],i=e.indexOf(l);i!==-1&&(n[i]=c??"")}return n.map(o=>o??"")}setHoveredArea(e,t){e!==this.currentHoveredArea?.id&&(this.currentHoveredArea&&this.clearHoveredArea(),this.currentHoveredArea={id:e,handle:t})}clearHoveredArea(){this.currentHoveredArea&&(this.currentHoveredArea?.handle.remove(),this.currentHoveredArea=null)}getNameFieldForCurrentLayer(){if(!this.selectionViewState||!this.selectionViewState.layerView||!this.selectionViewState.layerView.layer)return null;const e=this.fieldInfos.find(t=>t.layerName===this.selectionViewState?.layerView?.layer?.title)?.nameField;return e||(console.warn(`[area-selection-interaction-store] no name field configured for layer ${this.selectionViewState.layerView.layer.title}`,this.fieldInfos),null)}getCodeFieldForCurrentLayer(){if(!this.selectionViewState||!this.selectionViewState.layerView||!this.selectionViewState.layerView.layer)return null;const e=this.fieldInfos.find(t=>t.layerName===this.selectionViewState?.layerView?.layer?.title)?.codeField;return e||(console.warn(`[area-selection-interaction-store] no code field configured for layer ${this.selectionViewState.layerView.layer.title}`,this.fieldInfos),null)}clearSelections(){this.resetSelectedAreas(),this.clearHoveredArea(),this.lastAddedArea=null,this.lastRemovedArea=null,this.currentHoveredArea=null,console.log("[area-selection-interaction-store] selections cleared.")}cleanup(){this.resetSelectedAreas(),this.clearHoveredArea(),this.lastAddedArea=null,this.lastRemovedArea=null,this.currentHoveredArea=null,this.cachedNames.clear(),this.fieldInfos=[],console.log("[area-selection-interaction-store] cleaned up.")}}class Y{#e=h(null);get layerId(){return u(this.#e)}set layerId(e){f(this.#e,e,!0)}#t=h(I(new p));get selectedAreaIds(){return u(this.#t)}set selectedAreaIds(e){f(this.#t,e,!0)}setLayerId(e){this.layerId!==e&&(this.layerId=e,this.selectedAreaIds.clear())}addSelectedArea(e){this.selectedAreaIds.add(e)}addSelectedAreas(e){e.forEach(t=>this.selectedAreaIds.add(t))}removeSelectedArea(e){this.selectedAreaIds.delete(e)}clearSelectedAreas(){this.selectedAreaIds.clear()}exportSnapshot(){return{layerId:this.layerId,selectedAreaIds:new p(this.selectedAreaIds)}}}class Z{mapView;areaSelectionInteractionStore;interactableLayers;pointerMoveHandle=null;clickHandle=null;leaveHandle=null;enterHandle=null;#e=h(!0);get pointerInsideMap(){return u(this.#e)}set pointerInsideMap(e){f(this.#e,e,!0)}constructor(e,t,a){console.log("[map-interaction-store] Initializing with MapView"),this.mapView=e,this.areaSelectionInteractionStore=t,this.interactableLayers=a,this.setupHighlights(e),this.setupPointerMoveHandler(e),this.setupClickHandler(e),this.setupLeaveHandler(e),this.setupEnterHandler(e),console.log("[map-interaction-store] Initialized with MapView")}setupHighlights(e){const t={name:"hover",color:"lightgreen",haloOpacity:1,fillOpacity:.2},a={name:"selected",color:"green",haloOpacity:1,fillOpacity:.3};e.highlights.push(t),e.highlights.push(a)}setupPointerMoveHandler(e){this.pointerMoveHandle=e.on("pointer-move",async t=>{if(!this.pointerInsideMap)return;const{results:a}=await e.hitTest(t),r=a.find(l=>{if(!l)return!1;const c=l?.graphic;if(!c)return!1;const i=c?.layer;return i?this.isLayerInteractable(i.title)&&c.attributes?.[i.objectIdField]!==void 0:!1});if(!r){this.clearHoverHighlight();return}const s=r.graphic,n=s.layer;if(!s||!n||!this.isLayerInteractable(n.title)||s.attributes?.[n.objectIdField]===void 0){this.clearHoverHighlight();return}const o=s.attributes?.[n.objectIdField];if(!(this.areaSelectionInteractionStore.currentHoveredArea&&this.areaSelectionInteractionStore.currentHoveredArea.id===o))try{const l=await e.whenLayerView(n);this.areaSelectionInteractionStore.selectionViewState.layerView!==l&&this.areaSelectionInteractionStore.setSelectedLayerView(l),this.clearHoverHighlight();const c=l;if(!c){console.warn("LayerView is not a FeatureLayerView");return}if(!this.pointerInsideMap)return;const i=c.highlight(s,{name:"hover"});this.areaSelectionInteractionStore.setHoveredArea(o,i)}catch(l){console.error("Error in pointer-move handler:",l),this.clearHoverHighlight()}})}setupClickHandler(e){this.clickHandle=e.on("click",async t=>{const{results:a}=await e.hitTest(t),r=a[0];if(!r)return;const s=r.graphic,n=s.layer;if(!s||!n||!this.isLayerInteractable(n.title)||s.attributes?.[n.objectIdField]===void 0)return;const o=s.attributes?.[n.objectIdField];try{const l=await e.whenLayerView(n),c=l;if(!c){console.warn("Layer is not a FeatureLayerView");return}if(this.areaSelectionInteractionStore.selectionViewState.layerView!==l&&this.areaSelectionInteractionStore.setSelectedLayerView(l),this.areaSelectionInteractionStore.selectionViewState.areaHandles.get(o))this.areaSelectionInteractionStore.removeSelectedArea(o);else{const d=c.highlight(s,{name:"selected"});this.areaSelectionInteractionStore.addSelectedArea(o,d)}}catch(l){console.error("Error in click handler:",l)}})}setupLeaveHandler(e){this.leaveHandle=e.on("pointer-leave",()=>{this.pointerInsideMap=!1,this.clearHoverHighlight()})}setupEnterHandler(e){this.enterHandle=e.on("pointer-enter",()=>{this.pointerInsideMap=!0})}isLayerInteractable(e){return this.interactableLayers.has(e)}clearHoverHighlight(){this.areaSelectionInteractionStore.currentHoveredArea&&this.areaSelectionInteractionStore.clearHoveredArea()}cleanup(){this.pointerMoveHandle&&(this.pointerMoveHandle.remove(),this.pointerMoveHandle=null),this.clickHandle&&(this.clickHandle.remove(),this.clickHandle=null),this.leaveHandle&&(this.leaveHandle.remove(),this.leaveHandle=null),this.enterHandle&&(this.enterHandle.remove(),this.enterHandle=null),this.clearHoverHighlight(),this.pointerInsideMap=!0,this.interactableLayers=new p,console.log("[map-interaction-store] cleaned up")}get currentMapView(){return this.mapView}}export{Y as A,W as L,Z as M,U as S,X as a};
